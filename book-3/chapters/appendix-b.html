<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ë¡ B: Metabase ì¿¼ë¦¬ ëª¨ìŒ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ ë°ì´í„°ë² ì´ìŠ¤ 3ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "3"})

    @@include('components/mobile-menu.html')
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“™ ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì‹¤ì „ êµ¬ì¶• & ëŒ€ì‹œë³´ë“œ (3ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>
        <main class="main">
<h1 class="title">ë¶€ë¡ B: Metabase ì¿¼ë¦¬ ëª¨ìŒ</h1>

<h2>ëŒ€ì‹œë³´ë“œìš© ì¿¼ë¦¬ ì „ì²´ ì •ë¦¬</h2>

<p>ì´ ë¶€ë¡ì—ëŠ” 3ì¢… ëŒ€ì‹œë³´ë“œ(ë§¤ì¶œ, ìš´ì˜, ì¹˜ë£Œì‚¬ ì‹¤ì )ì— ì‚¬ìš©ëœ ëª¨ë“  SQL ì¿¼ë¦¬ê°€ ì •ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ì¿¼ë¦¬ë¥¼ ë³µì‚¬í•´ì„œ Metabaseì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.</p>

<hr>

<h2>ğŸ“Š ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬</h2>

<h3>1. ì˜¤ëŠ˜ ë§¤ì¶œ</h3>
<pre><code>SELECT
    COALESCE(SUM(b.total_amount), 0) as ì˜¤ëŠ˜ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE ts.session_date = CURDATE()
  AND b.payment_status = 'ì™„ë£Œ';</code></pre>

<h3>2. ì´ë²ˆ ì£¼ ë§¤ì¶œ</h3>
<pre><code>SELECT
    COALESCE(SUM(b.total_amount), 0) as ì´ë²ˆì£¼ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE YEARWEEK(ts.session_date, 1) = YEARWEEK(CURDATE(), 1)
  AND b.payment_status = 'ì™„ë£Œ';</code></pre>

<h3>3. ì´ë²ˆ ë‹¬ ë§¤ì¶œ</h3>
<pre><code>SELECT
    COALESCE(SUM(b.total_amount), 0) as ì´ë²ˆë‹¬ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND b.payment_status = 'ì™„ë£Œ';</code></pre>

<h3>4. ë¯¸ìˆ˜ê¸ˆ ì´ì•¡</h3>
<pre><code>SELECT
    COALESCE(SUM(total_amount), 0) as ë¯¸ìˆ˜ê¸ˆì´ì•¡
FROM billings
WHERE payment_status = 'ëŒ€ê¸°'
  AND total_amount > 0;</code></pre>

<h3>5. ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h3>
<pre><code>SELECT
    DATE_FORMAT(ts.session_date, '%Y-%m') as ì›”,
    SUM(b.total_amount) as ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE b.payment_status = 'ì™„ë£Œ'
  AND ts.session_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
GROUP BY DATE_FORMAT(ts.session_date, '%Y-%m')
ORDER BY ì›”;</code></pre>

<h3>6. ì¼ë³„ ë§¤ì¶œ ì¶”ì´ (ìµœê·¼ 30ì¼)</h3>
<pre><code>SELECT
    ts.session_date as ë‚ ì§œ,
    SUM(b.total_amount) as ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE b.payment_status = 'ì™„ë£Œ'
  AND ts.session_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY ts.session_date
ORDER BY ë‚ ì§œ;</code></pre>

<h3>7. í•­ëª©ë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
<pre><code>SELECT
    f.fee_name as í•­ëª©,
    COUNT(*) as ê±´ìˆ˜,
    SUM(b.total_amount) as ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
JOIN fee_items f ON b.fee_code = f.fee_code
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND b.payment_status = 'ì™„ë£Œ'
  AND b.total_amount > 0
GROUP BY f.fee_code, f.fee_name
ORDER BY ë§¤ì¶œ DESC;</code></pre>

<h3>8. ê²°ì œ ìˆ˜ë‹¨ë³„ ë¹„ì¤‘</h3>
<pre><code>SELECT
    COALESCE(b.payment_method, 'ë¯¸ìˆ˜ê¸ˆ') as ê²°ì œìˆ˜ë‹¨,
    COUNT(*) as ê±´ìˆ˜,
    SUM(b.total_amount) as ê¸ˆì•¡
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND b.total_amount > 0
GROUP BY b.payment_method
ORDER BY ê¸ˆì•¡ DESC;</code></pre>

<h3>9. ë¯¸ìˆ˜ê¸ˆ ìƒì„¸ ëª©ë¡</h3>
<pre><code>SELECT
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    ts.session_date as ì¹˜ë£Œì¼,
    f.fee_name as í•­ëª©,
    b.total_amount as ë¯¸ìˆ˜ê¸ˆì•¡,
    DATEDIFF(CURDATE(), ts.session_date) as ê²½ê³¼ì¼
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
JOIN patients p ON ts.patient_id = p.patient_id
JOIN fee_items f ON b.fee_code = f.fee_code
WHERE b.payment_status = 'ëŒ€ê¸°'
  AND b.total_amount > 0
ORDER BY ts.session_date;</code></pre>

<h3>10. ë¯¸ìˆ˜ê¸ˆ ê¸°ê°„ë³„ ë¶„í¬</h3>
<pre><code>SELECT
    CASE
        WHEN DATEDIFF(CURDATE(), ts.session_date) <= 7 THEN '1ì£¼ ì´ë‚´'
        WHEN DATEDIFF(CURDATE(), ts.session_date) <= 14 THEN '1~2ì£¼'
        WHEN DATEDIFF(CURDATE(), ts.session_date) <= 30 THEN '2ì£¼~1ë‹¬'
        ELSE '1ë‹¬ ì´ìƒ'
    END as ê¸°ê°„,
    COUNT(*) as ê±´ìˆ˜,
    SUM(b.total_amount) as ê¸ˆì•¡
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE b.payment_status = 'ëŒ€ê¸°'
  AND b.total_amount > 0
GROUP BY ê¸°ê°„
ORDER BY
    CASE ê¸°ê°„
        WHEN '1ì£¼ ì´ë‚´' THEN 1
        WHEN '1~2ì£¼' THEN 2
        WHEN '2ì£¼~1ë‹¬' THEN 3
        ELSE 4
    END;</code></pre>

<h3>11. ì „ì›” ëŒ€ë¹„ ë§¤ì¶œ</h3>
<pre><code>SELECT
    'ì´ë²ˆ ë‹¬' as êµ¬ë¶„,
    SUM(b.total_amount) as ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND b.payment_status = 'ì™„ë£Œ'

UNION ALL

SELECT
    'ì§€ë‚œ ë‹¬' as êµ¬ë¶„,
    SUM(b.total_amount) as ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH), '%Y-%m')
  AND b.payment_status = 'ì™„ë£Œ';</code></pre>

<hr>

<h2>ğŸ“‹ ìš´ì˜ ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬</h2>

<h3>1. ì˜¤ëŠ˜ ì˜ˆì•½ í™˜ì ìˆ˜</h3>
<pre><code>SELECT COUNT(*) as ì˜¤ëŠ˜ì˜ˆì•½
FROM treatment_sessions
WHERE session_date = CURDATE()
  AND session_status IN ('ì˜ˆì•½', 'ì™„ë£Œ');</code></pre>

<h3>2. ì˜¤ëŠ˜ ì™„ë£Œ ê±´ìˆ˜</h3>
<pre><code>SELECT COUNT(*) as ì™„ë£Œê±´ìˆ˜
FROM treatment_sessions
WHERE session_date = CURDATE()
  AND session_status = 'ì™„ë£Œ';</code></pre>

<h3>3. ì˜¤ëŠ˜ ë‚¨ì€ ì˜ˆì•½</h3>
<pre><code>SELECT COUNT(*) as ë‚¨ì€ì˜ˆì•½
FROM treatment_sessions
WHERE session_date = CURDATE()
  AND session_status = 'ì˜ˆì•½'
  AND start_time > CURTIME();</code></pre>

<h3>4. ì˜¤ëŠ˜ ì‹ ê·œ í™˜ì</h3>
<pre><code>SELECT COUNT(DISTINCT ts.patient_id) as ì‹ ê·œí™˜ì
FROM treatment_sessions ts
WHERE ts.session_date = CURDATE()
  AND NOT EXISTS (
      SELECT 1 FROM treatment_sessions ts2
      WHERE ts2.patient_id = ts.patient_id
        AND ts2.session_date < CURDATE()
  );</code></pre>

<h3>5. ì˜¤ëŠ˜ ì˜ˆì•½ ëª©ë¡</h3>
<pre><code>SELECT
    TIME_FORMAT(ts.start_time, '%H:%i') as ì‹œê°„,
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    t.name as ì¹˜ë£Œì‚¬,
    COALESCE(d.diagnosis_name, '-') as ì§„ë‹¨,
    ts.session_status as ìƒíƒœ,
    ts.notes as ë©”ëª¨
FROM treatment_sessions ts
JOIN patients p ON ts.patient_id = p.patient_id
JOIN therapists t ON ts.therapist_id = t.therapist_id
LEFT JOIN patient_diagnoses pd ON p.patient_id = pd.patient_id AND pd.is_primary = 'Y'
LEFT JOIN diagnosis_codes d ON pd.diagnosis_code = d.diagnosis_code
WHERE ts.session_date = CURDATE()
ORDER BY ts.start_time;</code></pre>

<h3>6. ì¹˜ë£Œì‚¬ë³„ ì˜¤ëŠ˜ í˜„í™©</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COUNT(*) as ì´ì˜ˆì•½,
    SUM(CASE WHEN ts.session_status = 'ì™„ë£Œ' THEN 1 ELSE 0 END) as ì™„ë£Œ,
    SUM(CASE WHEN ts.session_status = 'ì˜ˆì•½' THEN 1 ELSE 0 END) as ëŒ€ê¸°,
    SUM(CASE WHEN ts.session_status IN ('ì·¨ì†Œ', 'ë…¸ì‡¼') THEN 1 ELSE 0 END) as 'ì·¨ì†Œ_ë…¸ì‡¼'
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
WHERE ts.session_date = CURDATE()
GROUP BY t.therapist_id, t.name
ORDER BY t.therapist_id;</code></pre>

<h3>7. í•´í”¼ì½œ ìš”ì•½</h3>
<pre><code>SELECT
    CASE
        WHEN ê²½ê³¼ì¼ BETWEEN 7 AND 13 THEN '7ì¼ ê²½ê³¼'
        WHEN ê²½ê³¼ì¼ BETWEEN 14 AND 29 THEN '14ì¼ ê²½ê³¼'
        WHEN ê²½ê³¼ì¼ >= 30 THEN '30ì¼+ ê²½ê³¼'
    END as êµ¬ë¶„,
    COUNT(*) as í™˜ììˆ˜
FROM (
    SELECT
        p.patient_id,
        DATEDIFF(CURDATE(), MAX(ts.session_date)) as ê²½ê³¼ì¼
    FROM patients p
    JOIN treatment_sessions ts ON p.patient_id = ts.patient_id
    WHERE p.is_active = 'Y'
      AND ts.session_status = 'ì™„ë£Œ'
    GROUP BY p.patient_id
    HAVING ê²½ê³¼ì¼ >= 7
) sub
GROUP BY êµ¬ë¶„
ORDER BY
    CASE êµ¬ë¶„
        WHEN '7ì¼ ê²½ê³¼' THEN 1
        WHEN '14ì¼ ê²½ê³¼' THEN 2
        ELSE 3
    END;</code></pre>

<h3>8. 7ì¼ ë¯¸ë°©ë¬¸ í™˜ì (í•´í”¼ì½œ)</h3>
<pre><code>SELECT
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    MAX(ts.session_date) as ë§ˆì§€ë§‰ë°©ë¬¸,
    DATEDIFF(CURDATE(), MAX(ts.session_date)) as ê²½ê³¼ì¼,
    COALESCE(d.diagnosis_name, '-') as ì£¼ì§„ë‹¨,
    COUNT(ts.session_id) as ì´ë°©ë¬¸íšŸìˆ˜
FROM patients p
JOIN treatment_sessions ts ON p.patient_id = ts.patient_id
LEFT JOIN patient_diagnoses pd ON p.patient_id = pd.patient_id AND pd.is_primary = 'Y'
LEFT JOIN diagnosis_codes d ON pd.diagnosis_code = d.diagnosis_code
WHERE p.is_active = 'Y'
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY p.patient_id, p.name, p.phone, d.diagnosis_name
HAVING DATEDIFF(CURDATE(), MAX(ts.session_date)) BETWEEN 7 AND 14
ORDER BY ê²½ê³¼ì¼ DESC;</code></pre>

<h3>9. 14ì¼+ ë¯¸ë°©ë¬¸ í™˜ì</h3>
<pre><code>SELECT
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    MAX(ts.session_date) as ë§ˆì§€ë§‰ë°©ë¬¸,
    DATEDIFF(CURDATE(), MAX(ts.session_date)) as ê²½ê³¼ì¼,
    COALESCE(d.diagnosis_name, '-') as ì£¼ì§„ë‹¨
FROM patients p
JOIN treatment_sessions ts ON p.patient_id = ts.patient_id
LEFT JOIN patient_diagnoses pd ON p.patient_id = pd.patient_id AND pd.is_primary = 'Y'
LEFT JOIN diagnosis_codes d ON pd.diagnosis_code = d.diagnosis_code
WHERE p.is_active = 'Y'
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY p.patient_id, p.name, p.phone, d.diagnosis_name
HAVING DATEDIFF(CURDATE(), MAX(ts.session_date)) BETWEEN 14 AND 30
ORDER BY ê²½ê³¼ì¼ DESC;</code></pre>

<h3>10. ì´íƒˆ ìœ„í—˜ (30ì¼+ ë¯¸ë°©ë¬¸)</h3>
<pre><code>SELECT
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    MAX(ts.session_date) as ë§ˆì§€ë§‰ë°©ë¬¸,
    DATEDIFF(CURDATE(), MAX(ts.session_date)) as ê²½ê³¼ì¼,
    COUNT(ts.session_id) as ì´ë°©ë¬¸íšŸìˆ˜,
    COALESCE(d.diagnosis_name, '-') as ì£¼ì§„ë‹¨
FROM patients p
JOIN treatment_sessions ts ON p.patient_id = ts.patient_id
LEFT JOIN patient_diagnoses pd ON p.patient_id = pd.patient_id AND pd.is_primary = 'Y'
LEFT JOIN diagnosis_codes d ON pd.diagnosis_code = d.diagnosis_code
WHERE p.is_active = 'Y'
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY p.patient_id, p.name, p.phone, d.diagnosis_name
HAVING DATEDIFF(CURDATE(), MAX(ts.session_date)) > 30
ORDER BY ê²½ê³¼ì¼ DESC;</code></pre>

<h3>11. ì´ë²ˆ ë‹¬ ì‹ ê·œ í™˜ì ìˆ˜</h3>
<pre><code>SELECT COUNT(DISTINCT ts.patient_id) as ì‹ ê·œí™˜ììˆ˜
FROM treatment_sessions ts
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND NOT EXISTS (
      SELECT 1 FROM treatment_sessions ts2
      WHERE ts2.patient_id = ts.patient_id
        AND ts2.session_date < DATE_FORMAT(CURDATE(), '%Y-%m-01')
  );</code></pre>

<h3>12. ì›”ë³„ ì‹ ê·œ í™˜ì ì¶”ì´</h3>
<pre><code>SELECT
    DATE_FORMAT(ì²«ë°©ë¬¸ì¼, '%Y-%m') as ì›”,
    COUNT(*) as ì‹ ê·œí™˜ììˆ˜
FROM (
    SELECT
        patient_id,
        MIN(session_date) as ì²«ë°©ë¬¸ì¼
    FROM treatment_sessions
    WHERE session_status = 'ì™„ë£Œ'
    GROUP BY patient_id
) sub
WHERE ì²«ë°©ë¬¸ì¼ >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
GROUP BY DATE_FORMAT(ì²«ë°©ë¬¸ì¼, '%Y-%m')
ORDER BY ì›”;</code></pre>

<h3>13. ìµœê·¼ ì‹ ê·œ í™˜ì ëª©ë¡</h3>
<pre><code>SELECT
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    MIN(ts.session_date) as ì²«ë°©ë¬¸ì¼,
    COALESCE(d.diagnosis_name, '-') as ì£¼ì§„ë‹¨,
    t.name as ë‹´ë‹¹ì¹˜ë£Œì‚¬
FROM patients p
JOIN treatment_sessions ts ON p.patient_id = ts.patient_id
JOIN therapists t ON ts.therapist_id = t.therapist_id
LEFT JOIN patient_diagnoses pd ON p.patient_id = pd.patient_id AND pd.is_primary = 'Y'
LEFT JOIN diagnosis_codes d ON pd.diagnosis_code = d.diagnosis_code
WHERE ts.session_status = 'ì™„ë£Œ'
GROUP BY p.patient_id, p.name, p.phone, d.diagnosis_name, t.name
HAVING MIN(ts.session_date) >= DATE_SUB(CURDATE(), INTERVAL 14 DAY)
ORDER BY ì²«ë°©ë¬¸ì¼ DESC;</code></pre>

<h3>14. ë…¸ì‡¼/ì·¨ì†Œ í˜„í™©</h3>
<pre><code>SELECT
    session_status as ìƒíƒœ,
    COUNT(*) as ê±´ìˆ˜
FROM treatment_sessions
WHERE DATE_FORMAT(session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND session_status IN ('ì·¨ì†Œ', 'ë…¸ì‡¼')
GROUP BY session_status;</code></pre>

<h3>15. ë…¸ì‡¼ ìƒìŠµì</h3>
<pre><code>SELECT
    p.name as í™˜ìëª…,
    p.phone as ì—°ë½ì²˜,
    COUNT(*) as ë…¸ì‡¼íšŸìˆ˜,
    MAX(ts.session_date) as ìµœê·¼ë…¸ì‡¼
FROM treatment_sessions ts
JOIN patients p ON ts.patient_id = p.patient_id
WHERE ts.session_status = 'ë…¸ì‡¼'
GROUP BY p.patient_id, p.name, p.phone
HAVING COUNT(*) >= 2
ORDER BY ë…¸ì‡¼íšŸìˆ˜ DESC;</code></pre>

<h3>16. ì§„ë‹¨ë³„ í™˜ì ìˆ˜ TOP 10</h3>
<pre><code>SELECT
    d.diagnosis_name as ì§„ë‹¨ëª…,
    d.diagnosis_category as ë¶„ë¥˜,
    COUNT(DISTINCT pd.patient_id) as í™˜ììˆ˜
FROM patient_diagnoses pd
JOIN diagnosis_codes d ON pd.diagnosis_code = d.diagnosis_code
JOIN patients p ON pd.patient_id = p.patient_id
WHERE p.is_active = 'Y'
  AND pd.is_primary = 'Y'
GROUP BY d.diagnosis_code, d.diagnosis_name, d.diagnosis_category
ORDER BY í™˜ììˆ˜ DESC
LIMIT 10;</code></pre>

<hr>

<h2>ğŸ‘¨â€âš•ï¸ ì¹˜ë£Œì‚¬ ì‹¤ì  ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬</h2>

<h3>1. ì´ë²ˆ ë‹¬ ì´ ì¹˜ë£Œ ê±´ìˆ˜</h3>
<pre><code>SELECT COUNT(*) as ì´ì¹˜ë£Œê±´ìˆ˜
FROM treatment_sessions
WHERE DATE_FORMAT(session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND session_status = 'ì™„ë£Œ';</code></pre>

<h3>2. ì´ë²ˆ ë‹¬ ì´ ë§¤ì¶œ</h3>
<pre><code>SELECT COALESCE(SUM(b.total_amount), 0) as ì´ë§¤ì¶œ
FROM billings b
JOIN treatment_sessions ts ON b.session_id = ts.session_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND b.payment_status = 'ì™„ë£Œ';</code></pre>

<h3>3. ì¹˜ë£Œì‚¬ë³„ ì´ë²ˆ ë‹¬ ì‹¤ì </h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COUNT(ts.session_id) as ì¹˜ë£Œê±´ìˆ˜,
    COALESCE(SUM(b.total_amount), 0) as ë§¤ì¶œ,
    ROUND(COALESCE(SUM(b.total_amount), 0) / NULLIF(COUNT(ts.session_id), 0)) as ê±´ë‹¹ë§¤ì¶œ
FROM therapists t
LEFT JOIN treatment_sessions ts ON t.therapist_id = ts.therapist_id
    AND DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
    AND ts.session_status = 'ì™„ë£Œ'
LEFT JOIN billings b ON ts.session_id = b.session_id
    AND b.payment_status = 'ì™„ë£Œ'
WHERE t.is_active = 'Y'
GROUP BY t.therapist_id, t.name
ORDER BY ë§¤ì¶œ DESC;</code></pre>

<h3>4. ì¹˜ë£Œì‚¬ë³„ ë§¤ì¶œ ë¹„êµ</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COALESCE(SUM(b.total_amount), 0) as ë§¤ì¶œ
FROM therapists t
LEFT JOIN treatment_sessions ts ON t.therapist_id = ts.therapist_id
    AND DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
    AND ts.session_status = 'ì™„ë£Œ'
LEFT JOIN billings b ON ts.session_id = b.session_id
    AND b.payment_status = 'ì™„ë£Œ'
WHERE t.is_active = 'Y'
GROUP BY t.therapist_id, t.name
ORDER BY ë§¤ì¶œ DESC;</code></pre>

<h3>5. ì¹˜ë£Œì‚¬ë³„ ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h3>
<pre><code>SELECT
    DATE_FORMAT(ts.session_date, '%Y-%m') as ì›”,
    t.name as ì¹˜ë£Œì‚¬,
    SUM(b.total_amount) as ë§¤ì¶œ
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
JOIN billings b ON ts.session_id = b.session_id
WHERE ts.session_status = 'ì™„ë£Œ'
  AND b.payment_status = 'ì™„ë£Œ'
  AND ts.session_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
GROUP BY DATE_FORMAT(ts.session_date, '%Y-%m'), t.therapist_id, t.name
ORDER BY ì›”, t.name;</code></pre>

<h3>6. ì¹˜ë£Œì‚¬ë³„ ë‹´ë‹¹ í™˜ì ìˆ˜</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COUNT(DISTINCT ts.patient_id) as ë‹´ë‹¹í™˜ììˆ˜
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY t.therapist_id, t.name
ORDER BY ë‹´ë‹¹í™˜ììˆ˜ DESC;</code></pre>

<h3>7. ì¹˜ë£Œì‚¬ë³„ ì‹ ê·œ í™˜ì ìœ ì¹˜</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COUNT(DISTINCT ts.patient_id) as ì‹ ê·œí™˜ììˆ˜
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND ts.session_status = 'ì™„ë£Œ'
  AND NOT EXISTS (
      SELECT 1 FROM treatment_sessions ts2
      WHERE ts2.patient_id = ts.patient_id
        AND ts2.session_date < DATE_FORMAT(CURDATE(), '%Y-%m-01')
  )
GROUP BY t.therapist_id, t.name
ORDER BY ì‹ ê·œí™˜ììˆ˜ DESC;</code></pre>

<h3>8. í™˜ìë‹¹ í‰ê·  ë°©ë¬¸ íšŸìˆ˜</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COUNT(*) as ì´ì¹˜ë£Œê±´ìˆ˜,
    COUNT(DISTINCT ts.patient_id) as í™˜ììˆ˜,
    ROUND(COUNT(*) / COUNT(DISTINCT ts.patient_id), 1) as í™˜ìë‹¹ë°©ë¬¸íšŸìˆ˜
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY t.therapist_id, t.name
ORDER BY í™˜ìë‹¹ë°©ë¬¸íšŸìˆ˜ DESC;</code></pre>

<h3>9. ì¹˜ë£Œì‚¬ë³„ ì‹œê°„ëŒ€ ë¶„í¬</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    CASE
        WHEN HOUR(ts.start_time) < 12 THEN 'ì˜¤ì „'
        WHEN HOUR(ts.start_time) < 15 THEN 'ì˜¤í›„1'
        WHEN HOUR(ts.start_time) < 18 THEN 'ì˜¤í›„2'
        ELSE 'ì €ë…'
    END as ì‹œê°„ëŒ€,
    COUNT(*) as ê±´ìˆ˜
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY t.therapist_id, t.name, ì‹œê°„ëŒ€
ORDER BY t.name;</code></pre>

<h3>10. ì¹˜ë£Œì‚¬ë³„ ìš”ì¼ ë¶„í¬</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    CASE DAYOFWEEK(ts.session_date)
        WHEN 1 THEN 'ì¼'
        WHEN 2 THEN 'ì›”'
        WHEN 3 THEN 'í™”'
        WHEN 4 THEN 'ìˆ˜'
        WHEN 5 THEN 'ëª©'
        WHEN 6 THEN 'ê¸ˆ'
        WHEN 7 THEN 'í† '
    END as ìš”ì¼,
    COUNT(*) as ê±´ìˆ˜
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
WHERE DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
  AND ts.session_status = 'ì™„ë£Œ'
GROUP BY t.therapist_id, t.name, DAYOFWEEK(ts.session_date)
ORDER BY t.name, DAYOFWEEK(ts.session_date);</code></pre>

<h3>11. ì¸ì„¼í‹°ë¸Œ ê³„ì‚°í‘œ</h3>
<pre><code>SELECT
    t.name as ì¹˜ë£Œì‚¬,
    COALESCE(SUM(b.total_amount), 0) as ë§¤ì¶œ,
    COUNT(DISTINCT ts.session_id) as ì¹˜ë£Œê±´ìˆ˜,
    -- ë§¤ì¶œ ì¸ì„¼í‹°ë¸Œ: 200ë§Œì› ì´ˆê³¼ë¶„ì˜ 10%
    GREATEST(0, (COALESCE(SUM(b.total_amount), 0) - 2000000)) * 0.1 as ë§¤ì¶œì¸ì„¼í‹°ë¸Œ,
    -- ê±´ìˆ˜ ì¸ì„¼í‹°ë¸Œ: 50ê±´ ì´ˆê³¼ë¶„ Ã— 1ë§Œì›
    GREATEST(0, COUNT(DISTINCT ts.session_id) - 50) * 10000 as ê±´ìˆ˜ì¸ì„¼í‹°ë¸Œ
FROM therapists t
LEFT JOIN treatment_sessions ts ON t.therapist_id = ts.therapist_id
    AND DATE_FORMAT(ts.session_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m')
    AND ts.session_status = 'ì™„ë£Œ'
LEFT JOIN billings b ON ts.session_id = b.session_id
    AND b.payment_status = 'ì™„ë£Œ'
WHERE t.is_active = 'Y'
GROUP BY t.therapist_id, t.name
ORDER BY ë§¤ì¶œ DESC;</code></pre>

<hr>

<h2>ìœ í‹¸ë¦¬í‹° ì¿¼ë¦¬</h2>

<h3>í™˜ì ê²€ìƒ‰ (ì´ë¦„)</h3>
<pre><code>SELECT patient_id, name, phone, birth_date, memo
FROM patients
WHERE name LIKE '%ê²€ìƒ‰ì–´%'
  AND is_active = 'Y'
ORDER BY name;</code></pre>

<h3>í™˜ì ê²€ìƒ‰ (ì „í™”ë²ˆí˜¸)</h3>
<pre><code>SELECT patient_id, name, phone, birth_date, memo
FROM patients
WHERE phone LIKE '%ê²€ìƒ‰ì–´%'
  AND is_active = 'Y'
ORDER BY name;</code></pre>

<h3>í™˜ì ìƒì„¸ ì •ë³´</h3>
<pre><code>SELECT
    p.patient_id,
    p.name as ì´ë¦„,
    CASE p.gender WHEN 'M' THEN 'ë‚¨' ELSE 'ì—¬' END as ì„±ë³„,
    p.birth_date as ìƒë…„ì›”ì¼,
    TIMESTAMPDIFF(YEAR, p.birth_date, CURDATE()) as ë‚˜ì´,
    p.phone as ì—°ë½ì²˜,
    i.insurance_name as ë³´í—˜,
    p.memo as íŠ¹ì´ì‚¬í•­
FROM patients p
LEFT JOIN insurances i ON p.insurance_code = i.insurance_code
WHERE p.patient_id = '{{í™˜ìID}}';</code></pre>

<h3>í™˜ì ì¹˜ë£Œ ì´ë ¥</h3>
<pre><code>SELECT
    ts.session_date as ì¹˜ë£Œì¼,
    t.name as ì¹˜ë£Œì‚¬,
    f.fee_name as ì¹˜ë£Œí•­ëª©,
    b.total_amount as ê¸ˆì•¡,
    b.payment_status as ìˆ˜ë‚©ìƒíƒœ
FROM treatment_sessions ts
JOIN therapists t ON ts.therapist_id = t.therapist_id
JOIN billings b ON ts.session_id = b.session_id
JOIN fee_items f ON b.fee_code = f.fee_code
WHERE ts.patient_id = '{{í™˜ìID}}'
ORDER BY ts.session_date DESC
LIMIT 10;</code></pre>

<h3>ë°ì´í„°ë² ì´ìŠ¤ í†µê³„ ìš”ì•½</h3>
<pre><code>SELECT
    (SELECT COUNT(*) FROM patients WHERE is_active = 'Y') as í™œì„±í™˜ììˆ˜,
    (SELECT COUNT(*) FROM therapists WHERE is_active = 'Y') as ì¹˜ë£Œì‚¬ìˆ˜,
    (SELECT COUNT(*) FROM treatment_sessions WHERE session_status = 'ì™„ë£Œ') as ì´ì¹˜ë£Œê±´ìˆ˜,
    (SELECT SUM(total_amount) FROM billings WHERE payment_status = 'ì™„ë£Œ') as ì´ë§¤ì¶œ,
    (SELECT SUM(total_amount) FROM billings WHERE payment_status = 'ëŒ€ê¸°') as ë¯¸ìˆ˜ê¸ˆì´ì•¡;</code></pre>

<hr>

<p>ì´ ì¿¼ë¦¬ë“¤ì„ Metabaseì—ì„œ ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”. <code>{{ë³€ìˆ˜ëª…}}</code> í˜•ì‹ì€ Metabase í•„í„°ë¡œ ìë™ ë³€í™˜ë©ë‹ˆë‹¤.</p>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
