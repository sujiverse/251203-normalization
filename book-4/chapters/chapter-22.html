<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>22ì¥: ì‹¤ì‹œê°„ ë™ê¸°í™” - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ì‹¤ì‹œê°„ ë™ê¸°í™”</h1>

            <h2>ë™ê¸°í™”ê°€ í•„ìš”í•œ ì´ìœ </h2>

            <p>ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ ì˜ˆì•½ ì‹œìŠ¤í…œì„ ë³¼ ë•Œ:</p>

            <ul>
                <li>Aê°€ ì˜ˆì•½ì„ ë“±ë¡ â†’ Bì˜ í™”ë©´ì—ë„ ë°˜ì˜ë˜ì–´ì•¼ í•¨</li>
                <li>ë™ì‹œì— ê°™ì€ ì…€ì„ ìˆ˜ì •í•˜ë©´ ì¶©ëŒ ë°œìƒ</li>
                <li>ìµœì‹  ë°ì´í„°ë¥¼ ìœ ì§€í•´ì•¼ í•¨</li>
            </ul>

            <hr>

            <h2>ë™ê¸°í™” ë°©ë²• ë¹„êµ</h2>

            <table>
                <tr>
                    <th>ë°©ë²•</th>
                    <th>ì¥ì </th>
                    <th>ë‹¨ì </th>
                </tr>
                <tr>
                    <td>í´ë§ (Polling)</td>
                    <td>êµ¬í˜„ ê°„ë‹¨</td>
                    <td>ì„œë²„ ë¶€í•˜, ì§€ì—°</td>
                </tr>
                <tr>
                    <td>Long Polling</td>
                    <td>ì‹¤ì‹œê°„ì— ê°€ê¹Œì›€</td>
                    <td>ì—°ê²° ìœ ì§€ ë¹„ìš©</td>
                </tr>
                <tr>
                    <td>WebSocket</td>
                    <td>ì§„ì •í•œ ì‹¤ì‹œê°„</td>
                    <td>êµ¬í˜„ ë³µì¡</td>
                </tr>
            </table>

            <p><strong>ìš°ë¦¬ëŠ” í´ë§ ë°©ì‹</strong>ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì†Œê·œëª¨ í´ë¦¬ë‹‰ì—ì„œëŠ” ì¶©ë¶„í•©ë‹ˆë‹¤.</p>

            <hr>

            <h2>í´ë§ êµ¬í˜„</h2>

            <h3>1. ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ì </h3>

            <pre><code>// ë§ˆì§€ë§‰ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ ì‹œê°„
let lastFetchTime = new Date().toISOString();

// ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ í™•ì¸
setInterval(checkForUpdates, 10000);  // 10ì´ˆë§ˆë‹¤</code></pre>

            <h3>2. ë³€ê²½ì‚¬í•­ í™•ì¸ API</h3>

            <pre><code># app.py

@app.route('/api/reservations/changes')
def get_reservation_changes():
    since = request.args.get('since')  # ISO í˜•ì‹ ì‹œê°„

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ì§€ì • ì‹œê°„ ì´í›„ ë³€ê²½ëœ ì˜ˆì•½
        cursor.execute("""
            SELECT
                ts.patient_id,
                ts.session_date,
                TIME_FORMAT(ts.start_time, '%H:%i') as start_time,
                t.name as therapist_name,
                ts.updated_at
            FROM treatment_sessions ts
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE ts.updated_at > %s
        """, (since,))

        changes = cursor.fetchall()

        return jsonify({
            'success': True,
            'changes': changes,
            'server_time': datetime.now().isoformat()
        })
    finally:
        conn.close()</code></pre>

            <div class="tip"><strong>ğŸ’¡ updated_at ì»¬ëŸ¼</strong><br>
            í…Œì´ë¸”ì— updated_at ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤. MySQLì—ì„œ ìë™ ì—…ë°ì´íŠ¸ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤:<br>
            <code>updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code></div>

            <hr>

            <h2>í”„ë¡ íŠ¸ì—”ë“œ í´ë§</h2>

            <pre><code>// ë³€ê²½ì‚¬í•­ í™•ì¸
async function checkForUpdates() {
    try {
        const response = await fetch(
            `/api/reservations/changes?since=${encodeURIComponent(lastFetchTime)}`
        );
        const { changes, server_time } = await response.json();

        if (changes && changes.length > 0) {
            console.log(`${changes.length}ê°œ ë³€ê²½ì‚¬í•­ ë°œê²¬`);

            // ê° ë³€ê²½ì‚¬í•­ì„ ì‹œíŠ¸ì— ë°˜ì˜
            changes.forEach(change => {
                updateCellFromChange(change);
            });

            showToast(`${changes.length}ê°œ ì˜ˆì•½ì´ ì—…ë°ì´íŠ¸ë¨`);
        }

        // ì‹œê°„ ì—…ë°ì´íŠ¸
        lastFetchTime = server_time;

    } catch (error) {
        console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
    }
}

// ë³€ê²½ì‚¬í•­ì„ ì…€ì— ë°˜ì˜
function updateCellFromChange(change) {
    const { patients, dates } = window.sheetData;

    // í™˜ì í–‰ ì°¾ê¸°
    const rowIdx = patients.findIndex(p => p.patient_id === change.patient_id);
    if (rowIdx === -1) return;

    // ë‚ ì§œ ì—´ ì°¾ê¸°
    const colIdx = dates.findIndex(d => d.date === change.session_date);
    if (colIdx === -1) return;

    // ì…€ ì—…ë°ì´íŠ¸
    const colors = THERAPIST_COLORS[change.therapist_name] || { bg: '#f5f5f5' };

    luckysheet.setCellValue(rowIdx + 1, colIdx + 1, {
        v: `${change.start_time}|${change.therapist_name}`,
        m: change.start_time,
        bg: colors.bg,
        fc: colors.fc
    });
}</code></pre>

            <hr>

            <h2>í´ë§ ì‹œì‘/ì¤‘ì§€</h2>

            <pre><code>let pollingInterval = null;

// í´ë§ ì‹œì‘
function startPolling(intervalMs = 10000) {
    if (pollingInterval) return;  // ì´ë¯¸ ì‹¤í–‰ ì¤‘

    console.log('ë™ê¸°í™” ì‹œì‘');
    pollingInterval = setInterval(checkForUpdates, intervalMs);
}

// í´ë§ ì¤‘ì§€
function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('ë™ê¸°í™” ì¤‘ì§€');
    }
}

// í˜ì´ì§€ ê°€ì‹œì„±ì— ë”°ë¼ ì œì–´
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopPolling();  // íƒ­ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ ì¤‘ì§€
    } else {
        startPolling();  // íƒ­ì´ ë³´ì´ë©´ ì‹œì‘
        checkForUpdates();  // ì¦‰ì‹œ í•œ ë²ˆ í™•ì¸
    }
});

// ì´ˆê¸° ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    initSheet();
    startPolling();
});</code></pre>

            <hr>

            <h2>ì¶©ëŒ ë°©ì§€</h2>

            <pre><code># ë°±ì—”ë“œ: ë‚™ê´€ì  ì ê¸ˆ

@app.route('/api/reservations', methods=['POST'])
def save_reservation():
    data = request.get_json()

    # í´ë¼ì´ì–¸íŠ¸ê°€ ì•Œê³  ìˆëŠ” ë²„ì „
    client_version = data.get('version')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # í˜„ì¬ ë²„ì „ í™•ì¸
        cursor.execute("""
            SELECT updated_at FROM treatment_sessions
            WHERE patient_id = %s AND session_date = %s
        """, (data['patient_id'], data['session_date']))

        existing = cursor.fetchone()

        if existing and client_version:
            # ë‹¤ë¥¸ ì‚¬ëŒì´ ë¨¼ì € ìˆ˜ì •í–ˆëŠ”ì§€ í™•ì¸
            if str(existing['updated_at']) != client_version:
                return jsonify({
                    'success': False,
                    'error': 'ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.',
                    'conflict': True
                }), 409

        # ì €ì¥ ì§„í–‰...
        # ...

    finally:
        conn.close()</code></pre>

            <pre><code>// í”„ë¡ íŠ¸ì—”ë“œ: ì¶©ëŒ ì²˜ë¦¬

async function saveReservation(patientId, date, time, therapistId, version) {
    const response = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            patient_id: patientId,
            session_date: date,
            start_time: time,
            therapist_id: therapistId,
            version: version  // ë²„ì „ ì •ë³´ í¬í•¨
        })
    });

    const result = await response.json();

    if (result.conflict) {
        // ì¶©ëŒ ë°œìƒ
        const reload = confirm(result.error + '\n\nìƒˆë¡œê³ ì¹¨ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (reload) {
            initSheet();  // ì‹œíŠ¸ ë‹¤ì‹œ ë¡œë“œ
        }
        return false;
    }

    return result.success;
}</code></pre>

            <hr>

            <h2>ë™ê¸°í™” ìƒíƒœ í‘œì‹œ</h2>

            <pre><code>&lt;!-- ìƒíƒœ í‘œì‹œ --&gt;
&lt;div class="sync-status" id="syncStatus"&gt;
    &lt;span class="sync-dot"&gt;&lt;/span&gt;
    &lt;span class="sync-text"&gt;ë™ê¸°í™” ì¤‘...&lt;/span&gt;
&lt;/div&gt;

/* CSS */
.sync-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #64748b;
}

.sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #22c55e;  /* ë…¹ìƒ‰: ì—°ê²°ë¨ */
}

.sync-dot.syncing {
    background: #f59e0b;  /* ì£¼í™©: ë™ê¸°í™” ì¤‘ */
    animation: pulse 1s infinite;
}

.sync-dot.error {
    background: #ef4444;  /* ë¹¨ê°•: ì˜¤ë¥˜ */
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

// JavaScript
function updateSyncStatus(status) {
    const dot = document.querySelector('.sync-dot');
    const text = document.querySelector('.sync-text');

    dot.className = 'sync-dot';

    switch(status) {
        case 'syncing':
            dot.classList.add('syncing');
            text.textContent = 'ë™ê¸°í™” ì¤‘...';
            break;
        case 'synced':
            text.textContent = 'ë™ê¸°í™”ë¨';
            break;
        case 'error':
            dot.classList.add('error');
            text.textContent = 'ì—°ê²° ëŠê¹€';
            break;
    }
}</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li><strong>í´ë§</strong>: ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì—ì„œ ë³€ê²½ì‚¬í•­ í™•ì¸</li>
                <li><code>setInterval</code>ë¡œ 10ì´ˆë§ˆë‹¤ ì²´í¬</li>
                <li><code>visibilitychange</code>ë¡œ íƒ­ ê°€ì‹œì„±ì— ë”°ë¼ ì œì–´</li>
                <li><strong>ì¶©ëŒ ë°©ì§€</strong>: ë²„ì „ ì •ë³´ë¡œ ë™ì‹œ ìˆ˜ì • ê°ì§€</li>
                <li>ìƒíƒœ í‘œì‹œë¡œ ì‚¬ìš©ìì—ê²Œ ë™ê¸°í™” ìƒíƒœ ì•Œë¦¼</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì˜ˆì•½ í˜„í™© ì‹œíŠ¸ë¥¼ ì™„ì„±í•©ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
