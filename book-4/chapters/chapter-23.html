<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>23ì¥: ì˜ˆì•½ í˜„í™© ì‹œíŠ¸ ì™„ì„± - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ì˜ˆì•½ í˜„í™© ì‹œíŠ¸ ì™„ì„±</h1>

            <h2>ì™„ì„±ëœ í™”ë©´ êµ¬ì„±</h2>

            <pre class="file-tree">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¥ ì˜ˆì•½ í˜„í™©                                    [ë™ê¸°í™”ë¨ â—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì‹œì‘ì¼: [2024-12-01] ê¸°ê°„: [2ì£¼ â–¼] [ì ìš©] [ì˜¤ëŠ˜] [ìƒˆë¡œê³ ì¹¨]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì¹˜ë£Œì‚¬: â–  ê¹€ì¹˜ë£Œ  â–  ì´ì¹˜ë£Œ  â–  ë°•ì¹˜ë£Œ  â–  ìµœì¹˜ë£Œ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ í™˜ìëª…   â”‚ 12/1   â”‚ 12/2   â”‚ 12/3   â”‚ 12/4   â”‚ 12/5   â”‚ ...    â”‚
â”‚          â”‚ (ì›”)   â”‚ (í™”)   â”‚ (ìˆ˜)   â”‚ (ëª©)   â”‚ (ê¸ˆ)   â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ê¹€ì² ìˆ˜   â”‚ 10:00  â”‚        â”‚ 14:00  â”‚        â”‚ 11:00  â”‚        â”‚
â”‚ ì´ì˜í¬   â”‚        â”‚ 11:00  â”‚        â”‚ 10:00  â”‚        â”‚        â”‚
â”‚ ë°•ë¯¼ìˆ˜   â”‚ 15:00  â”‚ 15:00  â”‚        â”‚ 16:00  â”‚        â”‚        â”‚
â”‚ ...      â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>

            <hr>

            <h2>ì „ì²´ HTML êµ¬ì¡°</h2>

            <pre><code>&lt;!-- templates/reservations.html --&gt;
{% extends "base.html" %}

{% block title %}ì˜ˆì•½ í˜„í™©{% endblock %}

{% block head %}
&lt;!-- Luckysheet --&gt;
&lt;link rel="stylesheet" href="/static/luckysheet/plugins/css/pluginsCss.css"&gt;
&lt;link rel="stylesheet" href="/static/luckysheet/plugins/plugins.css"&gt;
&lt;link rel="stylesheet" href="/static/luckysheet/css/luckysheet.css"&gt;
&lt;link rel="stylesheet" href="/static/luckysheet/assets/iconfont/iconfont.css"&gt;
&lt;style&gt;
    .sheet-page { padding: 20px; }
    .sheet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .sheet-header h1 { margin: 0; font-size: 24px; }
    .controls { display: flex; gap: 10px; align-items: center; }
    .controls input, .controls select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
    }
    .controls button {
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .controls button:hover { background: #dc2626; }
    .legend {
        display: flex;
        gap: 20px;
        padding: 10px 15px;
        background: white;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .color-box {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid #ddd;
    }
    #luckysheet { width: 100%; height: calc(100vh - 250px); }
&lt;/style&gt;
{% endblock %}

{% block content %}
&lt;div class="sheet-page"&gt;
    &lt;!-- í—¤ë” --&gt;
    &lt;div class="sheet-header"&gt;
        &lt;h1&gt;ğŸ¥ ì˜ˆì•½ í˜„í™©&lt;/h1&gt;
        &lt;div class="sync-status" id="syncStatus"&gt;
            &lt;span class="sync-dot"&gt;&lt;/span&gt;
            &lt;span class="sync-text"&gt;ë™ê¸°í™”ë¨&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- ì»¨íŠ¸ë¡¤ --&gt;
    &lt;div class="controls"&gt;
        &lt;label&gt;ì‹œì‘ì¼&lt;/label&gt;
        &lt;input type="date" id="startDate"&gt;

        &lt;label&gt;ê¸°ê°„&lt;/label&gt;
        &lt;select id="days"&gt;
            &lt;option value="7"&gt;1ì£¼&lt;/option&gt;
            &lt;option value="14" selected&gt;2ì£¼&lt;/option&gt;
            &lt;option value="30"&gt;1ê°œì›”&lt;/option&gt;
        &lt;/select&gt;

        &lt;button onclick="reloadSheet()"&gt;ì ìš©&lt;/button&gt;
        &lt;button onclick="goToToday()"&gt;ì˜¤ëŠ˜&lt;/button&gt;
        &lt;button onclick="refreshSheet()"&gt;ìƒˆë¡œê³ ì¹¨&lt;/button&gt;
    &lt;/div&gt;

    &lt;!-- ë²”ë¡€ --&gt;
    &lt;div class="legend" id="legend"&gt;&lt;/div&gt;

    &lt;!-- ì‹œíŠ¸ --&gt;
    &lt;div id="luckysheet"&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;!-- ì˜ˆì•½ ëª¨ë‹¬ --&gt;
&lt;div id="reservationModal" class="modal"&gt;
    &lt;div class="modal-content"&gt;
        &lt;h2&gt;ì˜ˆì•½ ë“±ë¡/ìˆ˜ì •&lt;/h2&gt;
        &lt;p id="modalInfo"&gt;&lt;/p&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ì‹œê°„&lt;/label&gt;
            &lt;select id="modalTime"&gt;
                &lt;option value=""&gt;ì„ íƒ&lt;/option&gt;
                &lt;option value="09:00"&gt;09:00&lt;/option&gt;
                &lt;option value="10:00"&gt;10:00&lt;/option&gt;
                &lt;option value="11:00"&gt;11:00&lt;/option&gt;
                &lt;option value="14:00"&gt;14:00&lt;/option&gt;
                &lt;option value="15:00"&gt;15:00&lt;/option&gt;
                &lt;option value="16:00"&gt;16:00&lt;/option&gt;
                &lt;option value="17:00"&gt;17:00&lt;/option&gt;
            &lt;/select&gt;
        &lt;/div&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ì¹˜ë£Œì‚¬&lt;/label&gt;
            &lt;select id="modalTherapist"&gt;&lt;/select&gt;
        &lt;/div&gt;

        &lt;div class="modal-buttons"&gt;
            &lt;button class="btn-primary" onclick="saveModal()"&gt;ì €ì¥&lt;/button&gt;
            &lt;button class="btn-danger" onclick="deleteFromModal()"&gt;ì‚­ì œ&lt;/button&gt;
            &lt;button class="btn-secondary" onclick="closeModal()"&gt;ì·¨ì†Œ&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;!-- í† ìŠ¤íŠ¸ --&gt;
&lt;div id="toast" class="toast"&gt;&lt;/div&gt;

&lt;!-- Luckysheet JS --&gt;
&lt;script src="/static/luckysheet/plugins/js/plugin.js"&gt;&lt;/script&gt;
&lt;script src="/static/luckysheet/luckysheet.umd.js"&gt;&lt;/script&gt;
&lt;script src="/static/js/sheet.js"&gt;&lt;/script&gt;
{% endblock %}</code></pre>

            <hr>

            <h2>ì „ì²´ JavaScript (sheet.js)</h2>

            <pre><code>// static/js/sheet.js

// ì¹˜ë£Œì‚¬ë³„ ìƒ‰ìƒ
const THERAPIST_COLORS = {
    'ê¹€ì¹˜ë£Œ': { bg: '#dbeafe', fc: '#1e40af' },
    'ì´ì¹˜ë£Œ': { bg: '#fef3c7', fc: '#92400e' },
    'ë°•ì¹˜ë£Œ': { bg: '#dcfce7', fc: '#166534' },
    'ìµœì¹˜ë£Œ': { bg: '#f3e8ff', fc: '#6b21a8' }
};

// ì „ì—­ ìƒíƒœ
let lastFetchTime = new Date().toISOString();
let pollingInterval = null;
let currentModalData = null;

// ========== ì´ˆê¸°í™” ==========

document.addEventListener('DOMContentLoaded', async () => {
    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;

    // ì¹˜ë£Œì‚¬ ëª©ë¡ ë¡œë“œ
    await loadTherapists();

    // ì‹œíŠ¸ ì´ˆê¸°í™”
    await initSheet();

    // í´ë§ ì‹œì‘
    startPolling();
});

// ========== ë°ì´í„° ë¡œë“œ ==========

async function loadTherapists() {
    const res = await fetch('/api/therapists');
    const { data: therapists } = await res.json();

    // ë²”ë¡€ í‘œì‹œ
    const legend = document.getElementById('legend');
    legend.innerHTML = therapists.map(t => {
        const color = THERAPIST_COLORS[t.name]?.bg || '#f1f5f5';
        return `
            &lt;div class="legend-item"&gt;
                &lt;span class="color-box" style="background:${color}"&gt;&lt;/span&gt;
                &lt;span&gt;${t.name}&lt;/span&gt;
            &lt;/div&gt;
        `;
    }).join('');

    // ëª¨ë‹¬ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
    const select = document.getElementById('modalTherapist');
    select.innerHTML = '&lt;option value=""&gt;ì„ íƒ&lt;/option&gt;' +
        therapists.map(t =>
            `&lt;option value="${t.therapist_id}"&gt;${t.name}&lt;/option&gt;`
        ).join('');

    window.therapistList = therapists;
}

// ========== ì‹œíŠ¸ ìƒì„± ==========

async function initSheet(startDateStr, days) {
    const startDate = startDateStr ||
        document.getElementById('startDate').value ||
        new Date().toISOString().split('T')[0];

    days = days || parseInt(document.getElementById('days').value) || 14;

    const dates = getDateRange(startDate, days);
    const endDate = dates[dates.length - 1].date;

    // API í˜¸ì¶œ
    const response = await fetch(
        `/api/reservations/sheet?start_date=${startDate}&end_date=${endDate}`
    );
    const { patients, reservations } = await response.json();

    // celldata ìƒì„±
    const celldata = [
        ...createHeaderCells(dates),
        ...createPatientCells(patients),
        ...createReservationCells(patients, dates, reservations)
    ];

    // ê¸°ì¡´ ì‹œíŠ¸ ì œê±°
    if (window.luckysheet && luckysheet.destroy) {
        luckysheet.destroy();
    }

    // Luckysheet ìƒì„±
    luckysheet.create({
        container: 'luckysheet',
        title: 'ì˜ˆì•½ í˜„í™©',
        lang: 'ko',
        showtoolbar: false,
        showsheetbar: false,
        showstatisticBar: false,
        allowEdit: true,
        enableAddRow: false,
        data: [{
            name: 'ì˜ˆì•½',
            celldata: celldata,
            row: patients.length + 1,
            column: dates.length + 1,
            frozen: {
                type: 'rangeBoth',
                range: { row_focus: 0, column_focus: 0 }
            },
            config: {
                columnlen: { 0: 100 }
            }
        }],
        hook: {
            cellMousedown: onCellClick,
            cellEditBefore: onCellEditBefore
        }
    });

    // ì „ì—­ ì €ì¥
    window.sheetData = { patients, dates, reservations };
    lastFetchTime = new Date().toISOString();
}

// ... (í—¬í¼ í•¨ìˆ˜ë“¤ì€ ì´ì „ ì¥ê³¼ ë™ì¼)</code></pre>

            <hr>

            <h2>ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ë“¤</h2>

            <pre><code>// ì‹œíŠ¸ ë‹¤ì‹œ ë¡œë“œ
function reloadSheet() {
    const startDate = document.getElementById('startDate').value;
    const days = parseInt(document.getElementById('days').value);
    initSheet(startDate, days);
}

// ì˜¤ëŠ˜ë¡œ ì´ë™
function goToToday() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    reloadSheet();
}

// ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ ì„¤ì • ìœ ì§€)
async function refreshSheet() {
    updateSyncStatus('syncing');
    await initSheet();
    updateSyncStatus('synced');
    showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
}</code></pre>

            <hr>

            <h2>ëª¨ë‹¬ ì²˜ë¦¬</h2>

            <pre><code>// ì…€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
function onCellClick(cell, position) {
    const { row, column } = position;
    if (row === 0 || column === 0) return;

    const { patients, dates } = window.sheetData;
    const patient = patients[row - 1];
    const date = dates[column - 1];

    if (!patient || !date) return;

    // í˜„ì¬ ê°’
    const cellValue = luckysheet.getCellValue(row, column);

    openModal({
        patient,
        date,
        row,
        column,
        currentValue: cellValue
    });
}

function openModal(data) {
    currentModalData = data;

    document.getElementById('modalInfo').textContent =
        `${data.patient.name} / ${data.date.display}`;

    // í˜„ì¬ ê°’ ì±„ìš°ê¸°
    if (data.currentValue) {
        const [time, therapistId] = String(data.currentValue).split('|');
        document.getElementById('modalTime').value = time || '';
        document.getElementById('modalTherapist').value = therapistId || '';
    } else {
        document.getElementById('modalTime').value = '';
        document.getElementById('modalTherapist').value = '';
    }

    document.getElementById('reservationModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('reservationModal').style.display = 'none';
    currentModalData = null;
}

async function saveModal() {
    const time = document.getElementById('modalTime').value;
    const therapistId = document.getElementById('modalTherapist').value;

    if (!time || !therapistId) {
        alert('ì‹œê°„ê³¼ ì¹˜ë£Œì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
    }

    const { patient, date, row, column } = currentModalData;

    const success = await saveReservation(
        patient.patient_id,
        date.date,
        time,
        therapistId
    );

    if (success) {
        // ì¹˜ë£Œì‚¬ ì´ë¦„ ì°¾ê¸°
        const therapist = window.therapistList.find(
            t => t.therapist_id == therapistId
        );
        const therapistName = therapist?.name || '';
        const colors = THERAPIST_COLORS[therapistName] || { bg: '#f5f5f5' };

        // ì…€ ì—…ë°ì´íŠ¸
        luckysheet.setCellValue(row, column, {
            v: `${time}|${therapistId}`,
            m: time,
            bg: colors.bg,
            fc: colors.fc
        });

        closeModal();
    }
}

async function deleteFromModal() {
    if (!confirm('ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { patient, date, row, column } = currentModalData;

    const success = await deleteReservation(patient.patient_id, date.date);

    if (success) {
        luckysheet.setCellValue(row, column, null);
        closeModal();
    }
}</code></pre>

            <hr>

            <h2>í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

            <ul>
                <li>âœ… ì‹œíŠ¸ê°€ ë¡œë“œë˜ê³  í™˜ì/ë‚ ì§œê°€ í‘œì‹œë˜ëŠ”ê°€?</li>
                <li>âœ… ì²« í–‰/ì—´ì´ ìŠ¤í¬ë¡¤í•´ë„ ê³ ì •ë˜ëŠ”ê°€?</li>
                <li>âœ… ì…€ í´ë¦­ ì‹œ ëª¨ë‹¬ì´ ì—´ë¦¬ëŠ”ê°€?</li>
                <li>âœ… ì˜ˆì•½ ì €ì¥ì´ DBì— ë°˜ì˜ë˜ëŠ”ê°€?</li>
                <li>âœ… ì˜ˆì•½ ì‚­ì œê°€ ì‘ë™í•˜ëŠ”ê°€?</li>
                <li>âœ… ë‚ ì§œ ë²”ìœ„ ë³€ê²½ì´ ì‘ë™í•˜ëŠ”ê°€?</li>
                <li>âœ… ì¹˜ë£Œì‚¬ë³„ ìƒ‰ìƒì´ ì ìš©ë˜ëŠ”ê°€?</li>
            </ul>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ì˜ˆì•½ í˜„í™© ì‹œíŠ¸ì˜ ì „ì²´ HTML êµ¬ì¡°ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤</li>
                <li>í—¤ë”, ì»¨íŠ¸ë¡¤, ë²”ë¡€, ì‹œíŠ¸, ëª¨ë‹¬ì„ ë°°ì¹˜í–ˆìŠµë‹ˆë‹¤</li>
                <li>JavaScriptë¡œ ëª¨ë“  ê¸°ëŠ¥ì„ ì—°ê²°í–ˆìŠµë‹ˆë‹¤</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” í™˜ì ê´€ë¦¬ ì‹œíŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
