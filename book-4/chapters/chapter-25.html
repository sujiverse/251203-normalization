<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>25ì¥: ë§¤ì¶œ í˜„í™© ì‹œíŠ¸ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ë§¤ì¶œ í˜„í™© ì‹œíŠ¸</h1>

            <h2>ë§¤ì¶œ ì‹œíŠ¸ êµ¬ì¡°</h2>

            <pre class="file-tree">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° ë§¤ì¶œ í˜„í™©   ê¸°ê°„: [2024-12] â–¼   [ì¡°íšŒ]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë‚ ì§œ      â”‚ í™˜ìëª…  â”‚ ì¹˜ë£Œ ì¢…ë¥˜â”‚ ê¸ˆì•¡    â”‚ ê²°ì œë°©ë²• â”‚ ì¹˜ë£Œì‚¬     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 12/01     â”‚ ê¹€ì² ìˆ˜  â”‚ ë¬¼ë¦¬ì¹˜ë£Œâ”‚ 50,000  â”‚ ì¹´ë“œ    â”‚ ê¹€ì¹˜ë£Œ     â”‚
â”‚ 12/01     â”‚ ì´ì˜í¬  â”‚ ë„ìˆ˜ì¹˜ë£Œâ”‚ 80,000  â”‚ í˜„ê¸ˆ    â”‚ ì´ì¹˜ë£Œ     â”‚
â”‚ 12/02     â”‚ ë°•ë¯¼ìˆ˜  â”‚ ë¬¼ë¦¬ì¹˜ë£Œâ”‚ 50,000  â”‚ ì¹´ë“œ    â”‚ ë°•ì¹˜ë£Œ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     í•©ê³„      â”‚ 180,000 â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>

            <hr>

            <h2>ë§¤ì¶œ ë°ì´í„° API</h2>

            <pre><code># app.py

@app.route('/api/revenue/sheet')
def get_revenue_for_sheet():
    year = request.args.get('year', datetime.now().year)
    month = request.args.get('month', datetime.now().month)

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        cursor.execute("""
            SELECT
                ts.session_date,
                p.name as patient_name,
                tt.treatment_name,
                ts.fee,
                ts.payment_method,
                t.name as therapist_name
            FROM treatment_sessions ts
            JOIN patients p ON ts.patient_id = p.patient_id
            JOIN treatment_types tt ON ts.treatment_type_id = tt.treatment_type_id
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE YEAR(ts.session_date) = %s
              AND MONTH(ts.session_date) = %s
              AND ts.status = 'ì™„ë£Œ'
            ORDER BY ts.session_date, ts.start_time
        """, (year, month))

        sessions = cursor.fetchall()

        # í•©ê³„ ê³„ì‚°
        total = sum(s['fee'] or 0 for s in sessions)

        # ê²°ì œë°©ë²•ë³„ í•©ê³„
        by_payment = {}
        for s in sessions:
            method = s['payment_method'] or 'ë¯¸ì •'
            by_payment[method] = by_payment.get(method, 0) + (s['fee'] or 0)

        return jsonify({
            'success': True,
            'sessions': sessions,
            'total': total,
            'by_payment': by_payment
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ì‹œíŠ¸ ë°ì´í„° ìƒì„±</h2>

            <pre><code>// static/js/revenue-sheet.js

const REVENUE_COLUMNS = [
    { key: 'session_date', title: 'ë‚ ì§œ', width: 100 },
    { key: 'patient_name', title: 'í™˜ìëª…', width: 80 },
    { key: 'treatment_name', title: 'ì¹˜ë£Œ ì¢…ë¥˜', width: 100 },
    { key: 'fee', title: 'ê¸ˆì•¡', width: 100 },
    { key: 'payment_method', title: 'ê²°ì œë°©ë²•', width: 80 },
    { key: 'therapist_name', title: 'ì¹˜ë£Œì‚¬', width: 80 }
];

function createRevenueSheetData(sessions, total, byPayment) {
    const celldata = [];

    // í—¤ë” í–‰
    REVENUE_COLUMNS.forEach((col, i) => {
        celldata.push({
            r: 0, c: i,
            v: {
                v: col.key,
                m: col.title,
                bg: '#1e293b',
                fc: '#ffffff',
                bl: 1,
                ht: 1
            }
        });
    });

    // ë°ì´í„° í–‰
    sessions.forEach((session, rowIdx) => {
        REVENUE_COLUMNS.forEach((col, colIdx) => {
            let value = session[col.key];
            let displayValue = value;
            let style = { ht: 1 };

            // ë‚ ì§œ í¬ë§·
            if (col.key === 'session_date') {
                displayValue = formatDateShort(value);
            }

            // ê¸ˆì•¡ í¬ë§·
            if (col.key === 'fee') {
                displayValue = formatCurrency(value);
                style.ht = 2;  // ì˜¤ë¥¸ìª½ ì •ë ¬
            }

            // ê²°ì œë°©ë²• ìƒ‰ìƒ
            if (col.key === 'payment_method') {
                if (value === 'ì¹´ë“œ') {
                    style.bg = '#dbeafe';
                    style.fc = '#1e40af';
                } else if (value === 'í˜„ê¸ˆ') {
                    style.bg = '#dcfce7';
                    style.fc = '#166534';
                }
            }

            celldata.push({
                r: rowIdx + 1,
                c: colIdx,
                v: { v: value, m: displayValue || '', ...style }
            });
        });
    });

    // í•©ê³„ í–‰
    const totalRow = sessions.length + 1;

    // "í•©ê³„" ë¼ë²¨
    celldata.push({
        r: totalRow, c: 0,
        v: {
            v: 'total',
            m: 'í•©ê³„',
            bg: '#fef3c7',
            fc: '#92400e',
            bl: 1,
            ht: 1
        }
    });

    // í•©ê³„ ê¸ˆì•¡
    celldata.push({
        r: totalRow, c: 3,
        v: {
            v: total,
            m: formatCurrency(total),
            bg: '#fef3c7',
            fc: '#92400e',
            bl: 1,
            ht: 2
        }
    });

    return celldata;
}

function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return `${date.getMonth() + 1}/${date.getDate()}`;
}

function formatCurrency(amount) {
    if (!amount) return '0';
    return amount.toLocaleString() + 'ì›';
}</code></pre>

            <hr>

            <h2>ì‹œíŠ¸ ì´ˆê¸°í™”</h2>

            <pre><code>async function initRevenueSheet() {
    const yearMonth = document.getElementById('yearMonth').value;
    const [year, month] = yearMonth.split('-');

    const response = await fetch(
        `/api/revenue/sheet?year=${year}&month=${month}`
    );
    const { sessions, total, by_payment } = await response.json();

    const celldata = createRevenueSheetData(sessions, total, by_payment);

    // ì—´ ë„ˆë¹„
    const columnlen = {};
    REVENUE_COLUMNS.forEach((col, i) => {
        columnlen[i] = col.width;
    });

    if (window.luckysheet && luckysheet.destroy) {
        luckysheet.destroy();
    }

    luckysheet.create({
        container: 'luckysheet',
        title: 'ë§¤ì¶œ í˜„í™©',
        lang: 'ko',
        showtoolbar: false,
        showsheetbar: false,
        showstatisticBar: false,
        allowEdit: false,  // ì½ê¸° ì „ìš©
        data: [{
            name: 'ë§¤ì¶œ',
            celldata: celldata,
            row: sessions.length + 2,
            column: REVENUE_COLUMNS.length,
            frozen: {
                type: 'rangeRow',
                range: { row_focus: 0 }
            },
            config: { columnlen }
        }]
    });

    // ìš”ì•½ ì •ë³´ í‘œì‹œ
    updateSummary(total, by_payment);
}

function updateSummary(total, byPayment) {
    const summary = document.getElementById('summary');
    summary.innerHTML = `
        &lt;div class="summary-item"&gt;
            &lt;span&gt;ì´ ë§¤ì¶œ&lt;/span&gt;
            &lt;strong&gt;${formatCurrency(total)}&lt;/strong&gt;
        &lt;/div&gt;
        ${Object.entries(byPayment).map(([method, amount]) => `
            &lt;div class="summary-item"&gt;
                &lt;span&gt;${method}&lt;/span&gt;
                &lt;span&gt;${formatCurrency(amount)}&lt;/span&gt;
            &lt;/div&gt;
        `).join('')}
    `;
}</code></pre>

            <hr>

            <h2>HTML êµ¬ì¡°</h2>

            <pre><code>&lt;!-- templates/revenue.html --&gt;
{% extends "base.html" %}

{% block content %}
&lt;div class="sheet-page"&gt;
    &lt;div class="sheet-header"&gt;
        &lt;h1&gt;ğŸ’° ë§¤ì¶œ í˜„í™©&lt;/h1&gt;

        &lt;div class="controls"&gt;
            &lt;label&gt;ê¸°ê°„&lt;/label&gt;
            &lt;input type="month" id="yearMonth"&gt;
            &lt;button onclick="initRevenueSheet()"&gt;ì¡°íšŒ&lt;/button&gt;
            &lt;button onclick="exportExcel()"&gt;ì—‘ì…€ ë‹¤ìš´ë¡œë“œ&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- ìš”ì•½ ì •ë³´ --&gt;
    &lt;div class="summary" id="summary"&gt;&lt;/div&gt;

    &lt;!-- ì‹œíŠ¸ --&gt;
    &lt;div id="luckysheet"&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;style&gt;
.summary {
    display: flex;
    gap: 30px;
    padding: 15px 20px;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
}
.summary-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.summary-item span { color: #64748b; font-size: 13px; }
.summary-item strong { font-size: 20px; color: #1e293b; }
&lt;/style&gt;

&lt;script&gt;
document.addEventListener('DOMContentLoaded', () => {
    // ì´ë²ˆ ë‹¬ë¡œ ì´ˆê¸°í™”
    const now = new Date();
    const yearMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('yearMonth').value = yearMonth;

    initRevenueSheet();
});
&lt;/script&gt;
{% endblock %}</code></pre>

            <hr>

            <h2>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</h2>

            <pre><code>// Luckysheet ë°ì´í„°ë¥¼ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
function exportExcel() {
    // luckysheetì˜ exportXlsx ê¸°ëŠ¥ ì‚¬ìš©
    luckysheet.download('xlsx');
}

// ë˜ëŠ” ì„œë²„ì—ì„œ ìƒì„±
async function exportExcelFromServer() {
    const yearMonth = document.getElementById('yearMonth').value;
    const [year, month] = yearMonth.split('-');

    // ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    window.location.href =
        `/api/revenue/export?year=${year}&month=${month}`;
}

# ë°±ì—”ë“œ (openpyxl ì‚¬ìš©)
from openpyxl import Workbook
from flask import send_file
import io

@app.route('/api/revenue/export')
def export_revenue_excel():
    year = request.args.get('year')
    month = request.args.get('month')

    # ë°ì´í„° ì¡°íšŒ (ê¸°ì¡´ ì¿¼ë¦¬ ì¬ì‚¬ìš©)
    # ...

    # ì—‘ì…€ ìƒì„±
    wb = Workbook()
    ws = wb.active
    ws.title = f'{year}ë…„ {month}ì›” ë§¤ì¶œ'

    # í—¤ë”
    headers = ['ë‚ ì§œ', 'í™˜ìëª…', 'ì¹˜ë£Œ ì¢…ë¥˜', 'ê¸ˆì•¡', 'ê²°ì œë°©ë²•', 'ì¹˜ë£Œì‚¬']
    ws.append(headers)

    # ë°ì´í„°
    for session in sessions:
        ws.append([
            session['session_date'],
            session['patient_name'],
            session['treatment_name'],
            session['fee'],
            session['payment_method'],
            session['therapist_name']
        ])

    # í•©ê³„
    ws.append(['', '', 'í•©ê³„', total, '', ''])

    # íŒŒì¼ë¡œ ì €ì¥
    output = io.BytesIO()
    wb.save(output)
    output.seek(0)

    return send_file(
        output,
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        as_attachment=True,
        download_name=f'ë§¤ì¶œ_{year}_{month}.xlsx'
    )</code></pre>

            <hr>

            <h2>ì›”ë³„ ë¹„êµ ì°¨íŠ¸ (ì„ íƒ)</h2>

            <pre><code>&lt;!-- Chart.js CDN --&gt;
&lt;script src="https://cdn.jsdelivr.net/npm/chart.js"&gt;&lt;/script&gt;

&lt;canvas id="revenueChart" height="100"&gt;&lt;/canvas&gt;

&lt;script&gt;
async function loadRevenueChart() {
    const response = await fetch('/api/revenue/monthly');
    const { data } = await response.json();

    const ctx = document.getElementById('revenueChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.month),
            datasets: [{
                label: 'ì›”ë³„ ë§¤ì¶œ',
                data: data.map(d => d.total),
                backgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString() + 'ì›'
                    }
                }
            }
        }
    });
}
&lt;/script&gt;</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ë§¤ì¶œ ë°ì´í„°ë¥¼ ì‹œíŠ¸ í˜•íƒœë¡œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤</li>
                <li>í•©ê³„ì™€ ê²°ì œë°©ë²•ë³„ ìš”ì•½ì„ ê³„ì‚°í•©ë‹ˆë‹¤</li>
                <li>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤</li>
                <li>ì½ê¸° ì „ìš© ì‹œíŠ¸ë¡œ ë°ì´í„° ë³´í˜¸</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
