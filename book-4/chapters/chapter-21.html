<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21ì¥: í¸ì§‘ â†’ DB ì €ì¥ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">í¸ì§‘ â†’ DB ì €ì¥</h1>

            <h2>ì „ì²´ íë¦„</h2>

            <div class="file-tree">
1. ì…€ í¸ì§‘ ê°ì§€ (hook)
      â†“
2. JavaScript: ë³€ê²½ ë°ì´í„° ì¶”ì¶œ
      â†“
3. fetch()ë¡œ API í˜¸ì¶œ
      â†“
4. Flask: ìš”ì²­ ì²˜ë¦¬
      â†“
5. MySQL: INSERT/UPDATE
      â†“
6. ì‘ë‹µ â†’ í™”ë©´ ì—…ë°ì´íŠ¸
            </div>

            <hr>

            <h2>ë°±ì—”ë“œ API ì‘ì„±</h2>

            <pre><code># app.py

# ì˜ˆì•½ ìƒì„±/ìˆ˜ì •
@app.route('/api/reservations', methods=['POST'])
def save_reservation():
    data = request.get_json()

    patient_id = data.get('patient_id')
    session_date = data.get('session_date')
    start_time = data.get('start_time')
    therapist_id = data.get('therapist_id')

    if not all([patient_id, session_date, start_time, therapist_id]):
        return jsonify({'success': False, 'error': 'í•„ìˆ˜ ì •ë³´ ëˆ„ë½'}), 400

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ê¸°ì¡´ ì˜ˆì•½ í™•ì¸
        cursor.execute("""
            SELECT session_id FROM treatment_sessions
            WHERE patient_id = %s AND session_date = %s
        """, (patient_id, session_date))

        existing = cursor.fetchone()

        if existing:
            # ìˆ˜ì •
            cursor.execute("""
                UPDATE treatment_sessions
                SET start_time = %s, therapist_id = %s
                WHERE session_id = %s
            """, (start_time, therapist_id, existing['session_id']))
        else:
            # ì‹ ê·œ ìƒì„±
            cursor.execute("""
                INSERT INTO treatment_sessions
                (patient_id, session_date, start_time, therapist_id, status)
                VALUES (%s, %s, %s, %s, 'ì˜ˆì•½')
            """, (patient_id, session_date, start_time, therapist_id))

        conn.commit()
        return jsonify({'success': True})

    except Exception as e:
        conn.rollback()
        return jsonify({'success': False, 'error': str(e)}), 500
    finally:
        conn.close()


# ì˜ˆì•½ ì‚­ì œ
@app.route('/api/reservations', methods=['DELETE'])
def delete_reservation():
    data = request.get_json()

    patient_id = data.get('patient_id')
    session_date = data.get('session_date')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        cursor.execute("""
            DELETE FROM treatment_sessions
            WHERE patient_id = %s AND session_date = %s
        """, (patient_id, session_date))

        conn.commit()

        if cursor.rowcount > 0:
            return jsonify({'success': True, 'message': 'ì‚­ì œ ì™„ë£Œ'})
        else:
            return jsonify({'success': False, 'error': 'ì˜ˆì•½ ì—†ìŒ'})

    finally:
        conn.close()</code></pre>

            <hr>

            <h2>í”„ë¡ íŠ¸ì—”ë“œ ì €ì¥ í•¨ìˆ˜</h2>

            <pre><code>// static/js/sheet.js

async function saveReservation(patientId, date, time, therapistId) {
    try {
        const response = await fetch('/api/reservations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                patient_id: patientId,
                session_date: date,
                start_time: time,
                therapist_id: therapistId
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            return true;
        } else {
            showToast('ì €ì¥ ì‹¤íŒ¨: ' + result.error, 'error');
            return false;
        }
    } catch (error) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', error);
        showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
        return false;
    }
}


async function deleteReservation(patientId, date) {
    try {
        const response = await fetch('/api/reservations', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                patient_id: patientId,
                session_date: date
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            return true;
        } else {
            showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            return false;
        }
    } catch (error) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
        return false;
    }
}</code></pre>

            <hr>

            <h2>í† ìŠ¤íŠ¸ ë©”ì‹œì§€</h2>

            <pre><code>&lt;!-- HTML --&gt;
&lt;div id="toast" class="toast"&gt;&lt;/div&gt;

/* CSS */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    background: #1e293b;
    color: white;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 10000;
}

.toast.show {
    opacity: 1;
}

.toast.error {
    background: #dc2626;
}

// JavaScript
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show' + (type === 'error' ? ' error' : '');

    setTimeout(() => {
        toast.className = 'toast';
    }, 3000);
}</code></pre>

            <hr>

            <h2>ì…€ í¸ì§‘ ì‹œ ìë™ ì €ì¥</h2>

            <pre><code>// ì…€ ì—…ë°ì´íŠ¸ í›…
function onCellUpdated(row, column, oldValue, newValue) {
    if (row === 0 || column === 0) return;

    const { patients, dates } = window.sheetData;
    const patient = patients[row - 1];
    const date = dates[column - 1];

    if (!patient || !date) return;

    // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì‚­ì œ
    if (!newValue || newValue.trim() === '') {
        deleteReservation(patient.patient_id, date.date);
        return;
    }

    // ì‹œê°„|ì¹˜ë£Œì‚¬ID í˜•ì‹ íŒŒì‹±
    const [time, therapistId] = newValue.split('|');

    if (time && therapistId) {
        saveReservation(patient.patient_id, date.date, time, therapistId);
    } else {
        showToast('í˜•ì‹ ì˜¤ë¥˜: ì‹œê°„|ì¹˜ë£Œì‚¬ID', 'error');
    }
}

luckysheet.create({
    // ...
    hook: {
        cellUpdated: onCellUpdated
    }
});</code></pre>

            <hr>

            <h2>ëª¨ë‹¬ì—ì„œ ì €ì¥</h2>

            <pre><code>// ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
async function saveModal() {
    const time = document.getElementById('modalTime').value;
    const therapistId = document.getElementById('modalTherapist').value;

    if (!time || !therapistId) {
        alert('ì‹œê°„ê³¼ ì¹˜ë£Œì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
    }

    const { patient, date } = currentModalData;

    // API í˜¸ì¶œ
    const success = await saveReservation(
        patient.patient_id,
        date.date,
        time,
        therapistId
    );

    if (success) {
        closeModal();

        // ì‹œíŠ¸ ì…€ ì—…ë°ì´íŠ¸
        const row = window.sheetData.patients.indexOf(patient) + 1;
        const col = window.sheetData.dates.indexOf(date) + 1;

        luckysheet.setCellValue(row, col, {
            v: `${time}|${therapistId}`,
            m: time,
            bg: getTherapistColor(therapistId)
        });
    }
}

// ëª¨ë‹¬ ì‚­ì œ ë²„íŠ¼
async function deleteFromModal() {
    if (!confirm('ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    const { patient, date } = currentModalData;

    const success = await deleteReservation(
        patient.patient_id,
        date.date
    );

    if (success) {
        closeModal();

        // ì…€ ë¹„ìš°ê¸°
        const row = window.sheetData.patients.indexOf(patient) + 1;
        const col = window.sheetData.dates.indexOf(date) + 1;

        luckysheet.setCellValue(row, col, null);
    }
}</code></pre>

            <hr>

            <h2>ì—ëŸ¬ ì²˜ë¦¬</h2>

            <pre><code>async function saveReservation(patientId, date, time, therapistId) {
    // ë¡œë”© í‘œì‹œ
    showLoading(true);

    try {
        const response = await fetch('/api/reservations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                patient_id: patientId,
                session_date: date,
                start_time: time,
                therapist_id: therapistId
            })
        });

        // HTTP ì—ëŸ¬ ì²´í¬
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            showToast('ì €ì¥ ì™„ë£Œ');
            return true;
        } else {
            showToast(result.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
            return false;
        }

    } catch (error) {
        // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬
        if (error.name === 'TypeError') {
            showToast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
        } else {
            showToast('ì˜¤ë¥˜: ' + error.message, 'error');
        }
        return false;

    } finally {
        showLoading(false);
    }
}</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>POST /api/reservations: ì˜ˆì•½ ìƒì„±/ìˆ˜ì •</li>
                <li>DELETE /api/reservations: ì˜ˆì•½ ì‚­ì œ</li>
                <li>fetch()ë¡œ JSON ë°ì´í„° ì „ì†¡</li>
                <li>í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¡œ ê²°ê³¼ í‘œì‹œ</li>
                <li>try-catchë¡œ ì—ëŸ¬ ì²˜ë¦¬</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œ í¸ì§‘í•  ë•Œ ë™ê¸°í™”í•˜ëŠ” ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
