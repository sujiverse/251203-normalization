<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26ì¥: ë¡œê·¸ì¸ ê¸°ëŠ¥ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ë¡œê·¸ì¸ ê¸°ëŠ¥</h1>

            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì´ìœ </h2>

            <ul>
                <li>í™˜ì ì •ë³´ ë³´í˜¸ (ê°œì¸ì •ë³´ë³´í˜¸ë²•)</li>
                <li>ê¶Œí•œì— ë”°ë¥¸ ê¸°ëŠ¥ ì œí•œ</li>
                <li>ëˆ„ê°€ ìˆ˜ì •í–ˆëŠ”ì§€ ê¸°ë¡</li>
            </ul>

            <hr>

            <h2>ì‚¬ìš©ì í…Œì´ë¸”</h2>

            <pre><code>-- ì‚¬ìš©ì í…Œì´ë¸”
CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role ENUM('admin', 'therapist', 'staff') DEFAULT 'staff',
    therapist_id INT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (therapist_id) REFERENCES therapists(therapist_id)
);

-- ê¸°ë³¸ ê´€ë¦¬ì ì¶”ê°€ (ë¹„ë°€ë²ˆí˜¸: admin123)
INSERT INTO users (username, password_hash, name, role)
VALUES ('admin', '$2b$12$...í•´ì‹œê°’...', 'ê´€ë¦¬ì', 'admin');</code></pre>

            <hr>

            <h2>Flask ì„¸ì…˜ ì„¤ì •</h2>

            <pre><code># app.py

from flask import Flask, session, redirect, url_for
from werkzeug.security import generate_password_hash, check_password_hash
from functools import wraps

app = Flask(__name__)
app.secret_key = 'your-secret-key-here'  # ì‹¤ì œë¡œëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ!

# ë¡œê·¸ì¸ í•„ìˆ˜ ë°ì½”ë ˆì´í„°
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

# ê´€ë¦¬ì ê¶Œí•œ í•„ìˆ˜
def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        if session.get('role') != 'admin':
            return 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 403
        return f(*args, **kwargs)
    return decorated_function</code></pre>

            <hr>

            <h2>ë¡œê·¸ì¸ API</h2>

            <pre><code># app.py

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'GET':
        return render_template('login.html')

    # POST: ë¡œê·¸ì¸ ì²˜ë¦¬
    data = request.form
    username = data.get('username')
    password = data.get('password')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        cursor.execute("""
            SELECT user_id, username, password_hash, name, role, therapist_id
            FROM users
            WHERE username = %s AND is_active = TRUE
        """, (username,))

        user = cursor.fetchone()

        if user and check_password_hash(user['password_hash'], password):
            # ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
            session['user_id'] = user['user_id']
            session['username'] = user['username']
            session['name'] = user['name']
            session['role'] = user['role']
            session['therapist_id'] = user['therapist_id']

            return redirect(url_for('index'))
        else:
            return render_template('login.html', error='ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤')

    finally:
        conn.close()


@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))</code></pre>

            <hr>

            <h2>ë¡œê·¸ì¸ í˜ì´ì§€</h2>

            <pre><code>&lt;!-- templates/login.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang="ko"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;ë¡œê·¸ì¸ - íë§í•¸ì¦ˆ&lt;/title&gt;
    &lt;style&gt;
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Pretendard', sans-serif;
            background: #f1f5f9;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1e293b;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #475569;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #ef4444;
        }
        .btn-login {
            width: 100%;
            padding: 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-login:hover {
            background: #dc2626;
        }
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="login-box"&gt;
        &lt;h1&gt;ğŸ¥ íë§í•¸ì¦ˆ&lt;/h1&gt;

        {% if error %}
        &lt;div class="error"&gt;{{ error }}&lt;/div&gt;
        {% endif %}

        &lt;form method="POST"&gt;
            &lt;div class="form-group"&gt;
                &lt;label&gt;ì•„ì´ë””&lt;/label&gt;
                &lt;input type="text" name="username" required autofocus&gt;
            &lt;/div&gt;

            &lt;div class="form-group"&gt;
                &lt;label&gt;ë¹„ë°€ë²ˆí˜¸&lt;/label&gt;
                &lt;input type="password" name="password" required&gt;
            &lt;/div&gt;

            &lt;button type="submit" class="btn-login"&gt;ë¡œê·¸ì¸&lt;/button&gt;
        &lt;/form&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

            <hr>

            <h2>í˜ì´ì§€ ë³´í˜¸ ì ìš©</h2>

            <pre><code># ëª¨ë“  í˜ì´ì§€ì— ë¡œê·¸ì¸ í•„ìˆ˜ ì ìš©

@app.route('/')
@login_required
def index():
    return render_template('index.html')

@app.route('/reservations')
@login_required
def reservations():
    return render_template('reservations.html')

@app.route('/patients')
@login_required
def patients():
    return render_template('patients.html')

@app.route('/revenue')
@login_required
@admin_required  # ê´€ë¦¬ìë§Œ
def revenue():
    return render_template('revenue.html')


# APIë„ ë³´í˜¸
@app.route('/api/patients')
@login_required
def get_patients():
    # ...
    pass</code></pre>

            <hr>

            <h2>í˜„ì¬ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ</h2>

            <pre><code>&lt;!-- templates/base.html --&gt;
&lt;header class="app-header"&gt;
    &lt;h1&gt;ğŸ¥ íë§í•¸ì¦ˆ ì˜ˆì•½ê´€ë¦¬&lt;/h1&gt;

    &lt;div class="user-info"&gt;
        &lt;span&gt;{{ session.name }}ë‹˜&lt;/span&gt;
        &lt;span class="badge"&gt;{{ session.role }}&lt;/span&gt;
        &lt;a href="/logout"&gt;ë¡œê·¸ì•„ì›ƒ&lt;/a&gt;
    &lt;/div&gt;
&lt;/header&gt;

&lt;style&gt;
.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid #e2e8f0;
}
.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}
.badge {
    padding: 4px 8px;
    background: #dbeafe;
    color: #1e40af;
    border-radius: 4px;
    font-size: 12px;
}
&lt;/style&gt;</code></pre>

            <hr>

            <h2>ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ</h2>

            <pre><code># ë¹„ë°€ë²ˆí˜¸ ìƒì„± (ê´€ë¦¬ì ê³„ì • ë§Œë“¤ ë•Œ)
from werkzeug.security import generate_password_hash

password = 'admin123'
hash = generate_password_hash(password)
print(hash)  # DBì— ì €ì¥í•  í•´ì‹œê°’

# ì‚¬ìš©ì ì¶”ê°€ API
@app.route('/api/users', methods=['POST'])
@admin_required
def create_user():
    data = request.get_json()

    # ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ
    password_hash = generate_password_hash(data['password'])

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        cursor.execute("""
            INSERT INTO users (username, password_hash, name, role, therapist_id)
            VALUES (%s, %s, %s, %s, %s)
        """, (
            data['username'],
            password_hash,
            data['name'],
            data.get('role', 'staff'),
            data.get('therapist_id')
        ))

        conn.commit()
        return jsonify({'success': True, 'user_id': cursor.lastrowid})

    except Exception as e:
        conn.rollback()
        return jsonify({'success': False, 'error': str(e)})
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>

            <pre><code>@app.route('/api/users/password', methods=['PUT'])
@login_required
def change_password():
    data = request.get_json()

    current_password = data.get('current_password')
    new_password = data.get('new_password')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        cursor.execute("""
            SELECT password_hash FROM users WHERE user_id = %s
        """, (session['user_id'],))

        user = cursor.fetchone()

        if not check_password_hash(user['password_hash'], current_password):
            return jsonify({'success': False, 'error': 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤'})

        # ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
        new_hash = generate_password_hash(new_password)

        cursor.execute("""
            UPDATE users SET password_hash = %s WHERE user_id = %s
        """, (new_hash, session['user_id']))

        conn.commit()
        return jsonify({'success': True, 'message': 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤'})

    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li><strong>ì„¸ì…˜</strong>: ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•©ë‹ˆë‹¤</li>
                <li><strong>ë°ì½”ë ˆì´í„°</strong>: <code>@login_required</code>ë¡œ í˜ì´ì§€ ë³´í˜¸</li>
                <li><strong>ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ</strong>: í‰ë¬¸ìœ¼ë¡œ ì €ì¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤</li>
                <li><strong>ê¶Œí•œ</strong>: admin, therapist, staffë¡œ êµ¬ë¶„</li>
            </ul>

            <div class="warning"><strong>âš ï¸ ë³´ì•ˆ ì£¼ì˜</strong><br>
            - secret_keyëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ì„¸ìš”<br>
            - HTTPSë¥¼ ì‚¬ìš©í•˜ì„¸ìš”<br>
            - ë¹„ë°€ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ í•´ì‹œë¡œ ì €ì¥í•˜ì„¸ìš”</div>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ì— ë°°í¬í•©ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
