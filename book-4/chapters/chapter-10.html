<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10ì¥: ì˜ˆì•½ CRUD API - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ì˜ˆì•½ CRUD API</h1>

            <h2>CRUDë€?</h2>

            <table>
                <tr>
                    <th>ì•½ì</th>
                    <th>ì˜ë¯¸</th>
                    <th>HTTP</th>
                    <th>SQL</th>
                </tr>
                <tr>
                    <td><strong>C</strong>reate</td>
                    <td>ìƒì„±</td>
                    <td>POST</td>
                    <td>INSERT</td>
                </tr>
                <tr>
                    <td><strong>R</strong>ead</td>
                    <td>ì¡°íšŒ</td>
                    <td>GET</td>
                    <td>SELECT</td>
                </tr>
                <tr>
                    <td><strong>U</strong>pdate</td>
                    <td>ìˆ˜ì •</td>
                    <td>PUT</td>
                    <td>UPDATE</td>
                </tr>
                <tr>
                    <td><strong>D</strong>elete</td>
                    <td>ì‚­ì œ</td>
                    <td>DELETE</td>
                    <td>DELETE</td>
                </tr>
            </table>

            <hr>

            <h2>ì˜ˆì•½ ìƒì„± (Create)</h2>

            <pre><code>@app.route('/api/reservations', methods=['POST'])
def create_reservation():
    data = request.get_json()

    # í•„ìˆ˜ í•„ë“œ ê²€ì¦
    required = ['patient_id', 'therapist_id', 'session_date', 'start_time']
    for field in required:
        if field not in data:
            return jsonify({
                'success': False,
                'error': f'{field}ì€(ëŠ”) í•„ìˆ˜ì…ë‹ˆë‹¤'
            }), 400

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ì¤‘ë³µ ì˜ˆì•½ ì²´í¬
        cursor.execute("""
            SELECT session_id FROM treatment_sessions
            WHERE therapist_id = %s
              AND session_date = %s
              AND start_time = %s
              AND status != 'ì·¨ì†Œ'
        """, (data['therapist_id'], data['session_date'], data['start_time']))

        if cursor.fetchone():
            return jsonify({
                'success': False,
                'error': 'í•´ë‹¹ ì‹œê°„ì— ì´ë¯¸ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤'
            }), 409  # Conflict

        # ì˜ˆì•½ ìƒì„±
        cursor.execute("""
            INSERT INTO treatment_sessions
            (patient_id, therapist_id, session_date, start_time, status)
            VALUES (%s, %s, %s, %s, 'ì˜ˆì•½')
        """, (
            data['patient_id'],
            data['therapist_id'],
            data['session_date'],
            data['start_time']
        ))

        conn.commit()
        new_id = cursor.lastrowid

        return jsonify({
            'success': True,
            'message': 'ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤',
            'data': {'session_id': new_id}
        }), 201

    except Exception as e:
        conn.rollback()
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

    finally:
        conn.close()</code></pre>

            <h3>ìš”ì²­ ì˜ˆì‹œ</h3>
            <pre><code>POST /api/reservations
Content-Type: application/json

{
    "patient_id": 1,
    "therapist_id": 2,
    "session_date": "2024-12-05",
    "start_time": "10:00"
}</code></pre>

            <hr>

            <h2>ì˜ˆì•½ ìˆ˜ì • (Update)</h2>

            <pre><code>@app.route('/api/reservations/&lt;int:session_id&gt;', methods=['PUT'])
def update_reservation(session_id):
    data = request.get_json()

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ê¸°ì¡´ ì˜ˆì•½ í™•ì¸
        cursor.execute(
            "SELECT * FROM treatment_sessions WHERE session_id = %s",
            (session_id,)
        )
        if not cursor.fetchone():
            return jsonify({
                'success': False,
                'error': 'ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
            }), 404

        # ìˆ˜ì •í•  í•„ë“œ ë™ì  êµ¬ì„±
        updates = []
        params = []

        if 'therapist_id' in data:
            updates.append("therapist_id = %s")
            params.append(data['therapist_id'])

        if 'session_date' in data:
            updates.append("session_date = %s")
            params.append(data['session_date'])

        if 'start_time' in data:
            updates.append("start_time = %s")
            params.append(data['start_time'])

        if 'status' in data:
            updates.append("status = %s")
            params.append(data['status'])

        if not updates:
            return jsonify({
                'success': False,
                'error': 'ìˆ˜ì •í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤'
            }), 400

        params.append(session_id)
        sql = f"UPDATE treatment_sessions SET {', '.join(updates)} WHERE session_id = %s"

        cursor.execute(sql, params)
        conn.commit()

        return jsonify({
            'success': True,
            'message': 'ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤'
        })

    except Exception as e:
        conn.rollback()
        return jsonify({'success': False, 'error': str(e)}), 500

    finally:
        conn.close()</code></pre>

            <h3>ìš”ì²­ ì˜ˆì‹œ</h3>
            <pre><code>PUT /api/reservations/1
Content-Type: application/json

{
    "start_time": "11:00",
    "therapist_id": 3
}</code></pre>

            <hr>

            <h2>ì˜ˆì•½ ì‚­ì œ (Delete)</h2>

            <pre><code>@app.route('/api/reservations/&lt;int:session_id&gt;', methods=['DELETE'])
def delete_reservation(session_id):
    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ì¡´ì¬ í™•ì¸
        cursor.execute(
            "SELECT * FROM treatment_sessions WHERE session_id = %s",
            (session_id,)
        )
        if not cursor.fetchone():
            return jsonify({
                'success': False,
                'error': 'ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
            }), 404

        # ì‚­ì œ ëŒ€ì‹  ìƒíƒœ ë³€ê²½ (ì†Œí”„íŠ¸ ì‚­ì œ)
        cursor.execute("""
            UPDATE treatment_sessions
            SET status = 'ì·¨ì†Œ'
            WHERE session_id = %s
        """, (session_id,))

        conn.commit()

        return jsonify({
            'success': True,
            'message': 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤'
        })

    except Exception as e:
        conn.rollback()
        return jsonify({'success': False, 'error': str(e)}), 500

    finally:
        conn.close()</code></pre>

            <div class="tip"><strong>ğŸ’¡ ì†Œí”„íŠ¸ ì‚­ì œ vs í•˜ë“œ ì‚­ì œ</strong><br>
            <strong>í•˜ë“œ ì‚­ì œ</strong>: DELETEë¡œ ì‹¤ì œ ì‚­ì œ (ë³µêµ¬ ë¶ˆê°€)<br>
            <strong>ì†Œí”„íŠ¸ ì‚­ì œ</strong>: ìƒíƒœë§Œ ë³€ê²½ (ê¸°ë¡ ìœ ì§€, ë³µêµ¬ ê°€ëŠ¥)<br>
            ì˜ë£Œ ë°ì´í„°ëŠ” ì†Œí”„íŠ¸ ì‚­ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</div>

            <hr>

            <h2>ë¹ ë¥¸ ì˜ˆì•½ API (Luckysheetìš©)</h2>

            <p>ì…€ì—ì„œ ë°”ë¡œ ì˜ˆì•½í•˜ëŠ” ìš©ë„ì…ë‹ˆë‹¤.</p>

            <pre><code>@app.route('/api/reservations/quick', methods=['POST'])
def quick_reservation():
    """
    ì…€ í´ë¦­ ì‹œ ë¹ ë¥¸ ì˜ˆì•½
    {patient_id, date, time, therapist_id}
    """
    data = request.get_json()

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ê¸°ì¡´ ì˜ˆì•½ í™•ì¸
        cursor.execute("""
            SELECT session_id FROM treatment_sessions
            WHERE patient_id = %s
              AND session_date = %s
              AND status != 'ì·¨ì†Œ'
        """, (data['patient_id'], data['date']))

        existing = cursor.fetchone()

        if existing:
            # ê¸°ì¡´ ì˜ˆì•½ ìˆ˜ì •
            cursor.execute("""
                UPDATE treatment_sessions
                SET start_time = %s, therapist_id = %s
                WHERE session_id = %s
            """, (data['time'], data['therapist_id'], existing['session_id']))
            message = 'ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤'
        else:
            # ìƒˆ ì˜ˆì•½ ìƒì„±
            cursor.execute("""
                INSERT INTO treatment_sessions
                (patient_id, therapist_id, session_date, start_time, status)
                VALUES (%s, %s, %s, %s, 'ì˜ˆì•½')
            """, (
                data['patient_id'],
                data['therapist_id'],
                data['date'],
                data['time']
            ))
            message = 'ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤'

        conn.commit()

        return jsonify({
            'success': True,
            'message': message
        })

    except Exception as e:
        conn.rollback()
        return jsonify({'success': False, 'error': str(e)}), 500

    finally:
        conn.close()</code></pre>

            <hr>

            <h2>API ìš”ì•½</h2>

            <table>
                <tr>
                    <th>ë©”ì„œë“œ</th>
                    <th>URL</th>
                    <th>ê¸°ëŠ¥</th>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/reservations</td>
                    <td>ëª©ë¡ ì¡°íšŒ</td>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/reservations/sheet</td>
                    <td>ì‹œíŠ¸ìš© ë°ì´í„°</td>
                </tr>
                <tr>
                    <td>POST</td>
                    <td>/api/reservations</td>
                    <td>ì˜ˆì•½ ìƒì„±</td>
                </tr>
                <tr>
                    <td>PUT</td>
                    <td>/api/reservations/:id</td>
                    <td>ì˜ˆì•½ ìˆ˜ì •</td>
                </tr>
                <tr>
                    <td>DELETE</td>
                    <td>/api/reservations/:id</td>
                    <td>ì˜ˆì•½ ì·¨ì†Œ</td>
                </tr>
                <tr>
                    <td>POST</td>
                    <td>/api/reservations/quick</td>
                    <td>ë¹ ë¥¸ ì˜ˆì•½</td>
                </tr>
            </table>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ì˜ˆì•½ CRUD APIë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤</li>
                <li>ì¤‘ë³µ ì˜ˆì•½ ì²´í¬ ë¡œì§ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤</li>
                <li>ì†Œí”„íŠ¸ ì‚­ì œë¡œ ë°ì´í„°ë¥¼ ë³´ì¡´í•©ë‹ˆë‹¤</li>
                <li>Luckysheetìš© ë¹ ë¥¸ ì˜ˆì•½ APIë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤</li>
            </ul>

            <blockquote>Part 2 ì™„ë£Œ! ë‹¤ìŒ Partì—ì„œëŠ” í”„ë¡ íŠ¸ì—”ë“œ ê¸°ì´ˆë¥¼ ë°°ì›ë‹ˆë‹¤. HTML, CSS, JavaScript!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
