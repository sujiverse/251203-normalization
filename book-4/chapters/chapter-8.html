<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8ì¥: í™˜ì ëª©ë¡ API - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">í™˜ì ëª©ë¡ API</h1>

            <h2>ë§Œë“¤ API</h2>

            <table>
                <tr>
                    <th>ë©”ì„œë“œ</th>
                    <th>URL</th>
                    <th>ê¸°ëŠ¥</th>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/patients</td>
                    <td>ì „ì²´ ëª©ë¡</td>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/patients?name=ê¹€</td>
                    <td>ì´ë¦„ ê²€ìƒ‰</td>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/patients?page=2</td>
                    <td>í˜ì´ì§•</td>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/patients/1</td>
                    <td>ìƒì„¸ ì¡°íšŒ</td>
                </tr>
            </table>

            <hr>

            <h2>ê¸°ë³¸ í™˜ì ëª©ë¡</h2>

            <pre><code>from flask import Flask, jsonify, request
import pymysql
from config import DB_CONFIG

app = Flask(__name__)
app.config['JSON_AS_ASCII'] = False

def get_db_connection():
    return pymysql.connect(
        **DB_CONFIG,
        cursorclass=pymysql.cursors.DictCursor
    )

@app.route('/api/patients')
def get_patients():
    conn = get_db_connection()
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT
                patient_id,
                name,
                phone,
                birth_date,
                gender,
                created_at
            FROM patients
            ORDER BY name
        """)
        patients = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': patients,
            'count': len(patients)
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€</h2>

            <pre><code>@app.route('/api/patients')
def get_patients():
    # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë°›ê¸°
    name = request.args.get('name', '')
    phone = request.args.get('phone', '')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ê¸°ë³¸ ì¿¼ë¦¬
        sql = """
            SELECT patient_id, name, phone, birth_date, gender
            FROM patients
            WHERE 1=1
        """
        params = []

        # ì´ë¦„ ê²€ìƒ‰
        if name:
            sql += " AND name LIKE %s"
            params.append(f'%{name}%')

        # ì „í™”ë²ˆí˜¸ ê²€ìƒ‰
        if phone:
            sql += " AND phone LIKE %s"
            params.append(f'%{phone}%')

        sql += " ORDER BY name"

        cursor.execute(sql, params)
        patients = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': patients,
            'count': len(patients),
            'filters': {'name': name, 'phone': phone}
        })
    finally:
        conn.close()</code></pre>

            <h3>í…ŒìŠ¤íŠ¸</h3>
            <ul>
                <li><code>/api/patients</code> â†’ ì „ì²´ ëª©ë¡</li>
                <li><code>/api/patients?name=ê¹€</code> â†’ ê¹€ì”¨ í™˜ìë§Œ</li>
                <li><code>/api/patients?phone=1234</code> â†’ ì „í™”ë²ˆí˜¸ì— 1234 í¬í•¨</li>
                <li><code>/api/patients?name=ê¹€&phone=010</code> â†’ ì¡°í•© ê²€ìƒ‰</li>
            </ul>

            <hr>

            <h2>í˜ì´ì§• ì¶”ê°€</h2>

            <pre><code>@app.route('/api/patients')
def get_patients():
    name = request.args.get('name', '')
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 10, type=int)

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # ì „ì²´ ê°œìˆ˜ ë¨¼ì € ì¡°íšŒ
        count_sql = "SELECT COUNT(*) as total FROM patients WHERE 1=1"
        params = []

        if name:
            count_sql += " AND name LIKE %s"
            params.append(f'%{name}%')

        cursor.execute(count_sql, params)
        total = cursor.fetchone()['total']

        # í˜ì´ì§•ëœ ë°ì´í„° ì¡°íšŒ
        sql = """
            SELECT patient_id, name, phone, birth_date
            FROM patients
            WHERE 1=1
        """

        if name:
            sql += " AND name LIKE %s"

        sql += " ORDER BY name LIMIT %s OFFSET %s"

        offset = (page - 1) * per_page
        params.extend([per_page, offset])

        cursor.execute(sql, params)
        patients = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': patients,
            'pagination': {
                'page': page,
                'per_page': per_page,
                'total': total,
                'total_pages': (total + per_page - 1) // per_page
            }
        })
    finally:
        conn.close()</code></pre>

            <h3>í…ŒìŠ¤íŠ¸</h3>
            <ul>
                <li><code>/api/patients?page=1&per_page=5</code> â†’ 1í˜ì´ì§€, 5ê°œì”©</li>
                <li><code>/api/patients?page=2&per_page=10</code> â†’ 2í˜ì´ì§€</li>
            </ul>

            <hr>

            <h2>í™˜ì ìƒì„¸ ì¡°íšŒ</h2>

            <pre><code>@app.route('/api/patients/&lt;int:patient_id&gt;')
def get_patient(patient_id):
    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # í™˜ì ê¸°ë³¸ ì •ë³´
        cursor.execute("""
            SELECT * FROM patients WHERE patient_id = %s
        """, (patient_id,))
        patient = cursor.fetchone()

        if not patient:
            return jsonify({
                'success': False,
                'error': 'í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
            }), 404

        # ì§„ë‹¨ ì •ë³´
        cursor.execute("""
            SELECT d.*, dc.code_name as diagnosis_name
            FROM diagnoses d
            JOIN diagnosis_codes dc ON d.diagnosis_code = dc.diagnosis_code
            WHERE d.patient_id = %s
            ORDER BY d.diagnosis_date DESC
        """, (patient_id,))
        diagnoses = cursor.fetchall()

        # ìµœê·¼ ì¹˜ë£Œ ê¸°ë¡
        cursor.execute("""
            SELECT ts.*, t.name as therapist_name
            FROM treatment_sessions ts
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE ts.patient_id = %s
            ORDER BY ts.session_date DESC
            LIMIT 5
        """, (patient_id,))
        recent_sessions = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': {
                'patient': patient,
                'diagnoses': diagnoses,
                'recent_sessions': recent_sessions
            }
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬</h2>

            <p>MySQLì˜ DATE, DATETIME íƒ€ì…ì€ JSONìœ¼ë¡œ ë³€í™˜í•  ë•Œ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <pre><code>import json
from datetime import date, datetime

# JSON ì¸ì½”ë” ì»¤ìŠ¤í„°ë§ˆì´ì§•
class CustomJSONEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, (date, datetime)):
            return obj.isoformat()
        return super().default(obj)

app.json_encoder = CustomJSONEncoder</code></pre>

            <div class="tip"><strong>ğŸ’¡ isoformat() ê²°ê³¼</strong><br>
            <code>2024-12-01</code> (date)<br>
            <code>2024-12-01T10:30:00</code> (datetime)</div>

            <hr>

            <h2>ì™„ì„±ëœ ì½”ë“œ êµ¬ì¡°</h2>

            <pre class="file-tree">healing-hands-app/
â”œâ”€â”€ app.py
â”œâ”€â”€ config.py
â””â”€â”€ api/
    â””â”€â”€ patients.py  (ë‚˜ì¤‘ì— ë¶„ë¦¬í•  ìˆ˜ ìˆìŒ)</pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>í™˜ì ëª©ë¡ APIë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤</li>
                <li>ì´ë¦„, ì „í™”ë²ˆí˜¸ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤</li>
                <li>í˜ì´ì§•ìœ¼ë¡œ ëŒ€ëŸ‰ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤</li>
                <li>ìƒì„¸ ì¡°íšŒì—ì„œ ê´€ë ¨ ë°ì´í„°ë„ í•¨ê»˜ ë°˜í™˜í•©ë‹ˆë‹¤</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì˜ˆì•½ ì¡°íšŒ APIë¥¼ ë§Œë“­ë‹ˆë‹¤. ë‚ ì§œë³„ ì˜ˆì•½ í˜„í™©ì„ ê°€ì ¸ì™€ë´…ì‹œë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
