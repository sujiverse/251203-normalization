<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16ì¥: ê¸°ë³¸ ì‹œíŠ¸ ë§Œë“¤ê¸° - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ê¸°ë³¸ ì‹œíŠ¸ ë§Œë“¤ê¸°</h1>

            <h2>ì˜ˆì•½ ì‹œíŠ¸ êµ¬ì¡°</h2>

            <table>
                <tr>
                    <th style="background:#fee2e2;">í™˜ìëª…</th>
                    <th>12/1(ì›”)</th>
                    <th>12/2(í™”)</th>
                    <th>12/3(ìˆ˜)</th>
                    <th>...</th>
                </tr>
                <tr>
                    <td style="background:#fee2e2;">ê¹€ì² ìˆ˜</td>
                    <td>10:00</td>
                    <td></td>
                    <td>14:00</td>
                    <td>...</td>
                </tr>
                <tr>
                    <td style="background:#fee2e2;">ì´ì˜í¬</td>
                    <td></td>
                    <td>11:00</td>
                    <td></td>
                    <td>...</td>
                </tr>
            </table>

            <ul>
                <li><strong>í–‰</strong>: í™˜ì (ì²« ì—´ì€ í™˜ìëª…)</li>
                <li><strong>ì—´</strong>: ë‚ ì§œ (ì²« í–‰ì€ ë‚ ì§œ)</li>
                <li><strong>ì…€</strong>: ì˜ˆì•½ ì‹œê°„</li>
            </ul>

            <hr>

            <h2>ì‹œíŠ¸ ë°ì´í„° ìƒì„± í•¨ìˆ˜</h2>

            <pre><code>// static/js/sheet.js

// ë‚ ì§œ ë²”ìœ„ ìƒì„±
function getDateRange(startDate, days) {
    const dates = [];
    const start = new Date(startDate);

    for (let i = 0; i < days; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);

        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayName = dayNames[date.getDay()];

        dates.push({
            date: date.toISOString().split('T')[0],
            display: `${date.getMonth() + 1}/${date.getDate()}(${dayName})`
        });
    }

    return dates;
}

// í—¤ë” í–‰ ìƒì„± (ë‚ ì§œ)
function createHeaderRow(dates) {
    const cells = [
        // A1: ë¹ˆ ì…€ (í™˜ìëª… ì—´ ìœ„)
        {
            r: 0, c: 0,
            v: { v: 'í™˜ìëª…', m: 'í™˜ìëª…', bg: '#f1f5f9', bl: 1 }
        }
    ];

    dates.forEach((d, i) => {
        cells.push({
            r: 0,
            c: i + 1,
            v: {
                v: d.date,
                m: d.display,
                bg: '#f1f5f9',
                bl: 1  // êµµê²Œ
            }
        });
    });

    return cells;
}

// í™˜ì í–‰ ìƒì„±
function createPatientRows(patients, startRow) {
    const cells = [];

    patients.forEach((patient, i) => {
        cells.push({
            r: startRow + i,
            c: 0,
            v: {
                v: patient.patient_id,  // ì‹¤ì œ ê°’ì€ ID
                m: patient.name,         // í‘œì‹œê°’ì€ ì´ë¦„
                bg: '#fee2e2'
            }
        });
    });

    return cells;
}</code></pre>

            <hr>

            <h2>APIì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ì„œ ì‹œíŠ¸ ìƒì„±</h2>

            <pre><code>async function initReservationSheet() {
    // ì˜¤ëŠ˜ë¶€í„° 14ì¼ê°„
    const today = new Date().toISOString().split('T')[0];
    const dates = getDateRange(today, 14);

    // ë‚ ì§œ ë²”ìœ„
    const startDate = dates[0].date;
    const endDate = dates[dates.length - 1].date;

    // APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const [patientsRes, reservationsRes] = await Promise.all([
        fetch('/api/patients').then(r => r.json()),
        fetch(`/api/reservations/sheet?start_date=${startDate}&end_date=${endDate}`)
            .then(r => r.json())
    ]);

    const patients = patientsRes.data;
    const reservations = reservationsRes.reservations;

    // ì…€ ë°ì´í„° ìƒì„±
    let celldata = [];

    // 1. í—¤ë” í–‰ (ë‚ ì§œ)
    celldata = celldata.concat(createHeaderRow(dates));

    // 2. í™˜ì í–‰
    celldata = celldata.concat(createPatientRows(patients, 1));

    // 3. ì˜ˆì•½ ë°ì´í„°
    patients.forEach((patient, rowIdx) => {
        const patientReservations = reservations[patient.patient_id] || {};

        dates.forEach((d, colIdx) => {
            const res = patientReservations[d.date];
            if (res) {
                celldata.push({
                    r: rowIdx + 1,
                    c: colIdx + 1,
                    v: {
                        v: res.time,
                        m: res.time,
                        bg: getTherapistColor(res.therapist)
                    }
                });
            }
        });
    });

    // Luckysheet ìƒì„±
    luckysheet.create({
        container: 'luckysheet',
        title: 'ì˜ˆì•½ í˜„í™©',
        lang: 'ko',
        data: [{
            name: 'ì˜ˆì•½',
            celldata: celldata,
            row: patients.length + 1,
            column: dates.length + 1
        }]
    });
}

// ì¹˜ë£Œì‚¬ë³„ ìƒ‰ìƒ
function getTherapistColor(therapistName) {
    const colors = {
        'ê¹€ì¹˜ë£Œ': '#dbeafe',  // íŒŒë€ìƒ‰
        'ì´ì¹˜ë£Œ': '#fef3c7',  // ë…¸ë€ìƒ‰
        'ë°•ì¹˜ë£Œ': '#dcfce7',  // ì´ˆë¡ìƒ‰
    };
    return colors[therapistName] || '#ffffff';
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', initReservationSheet);</code></pre>

            <hr>

            <h2>ì—´/í–‰ í¬ê¸° ì„¤ì •</h2>

            <pre><code>luckysheet.create({
    container: 'luckysheet',
    data: [{
        name: 'ì˜ˆì•½',
        celldata: celldata,

        // ì—´ ë„ˆë¹„ ì„¤ì •
        config: {
            columnlen: {
                0: 100,  // Aì—´ (í™˜ìëª…): 100px
                // ë‚˜ë¨¸ì§€ ì—´ì€ ê¸°ë³¸ê°’ (73px)
            },
            rowlen: {
                0: 30    // 1í–‰ (í—¤ë”): 30px
            }
        }
    }]
});</code></pre>

            <hr>

            <h2>ê²°ê³¼ í™•ì¸</h2>

            <p>Flask ì„œë²„ ì‹¤í–‰ í›„ <code>/reservations</code> ì ‘ì†</p>

            <ul>
                <li>ì²« í–‰ì— ë‚ ì§œê°€ í‘œì‹œë¨</li>
                <li>ì²« ì—´ì— í™˜ìëª…ì´ í‘œì‹œë¨</li>
                <li>ì˜ˆì•½ì´ ìˆëŠ” ì…€ì— ì‹œê°„ê³¼ ìƒ‰ìƒì´ í‘œì‹œë¨</li>
            </ul>

            <div class="warning"><strong>âš ï¸ ë°ì´í„°ê°€ ì•ˆ ë³´ì¸ë‹¤ë©´?</strong><br>
            1. Flask ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸<br>
            2. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ â†’ Network íƒ­ì—ì„œ API ì‘ë‹µ í™•ì¸<br>
            3. Console íƒ­ì—ì„œ JavaScript ì—ëŸ¬ í™•ì¸</div>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ë‚ ì§œ ë²”ìœ„ì™€ í™˜ì ëª©ë¡ìœ¼ë¡œ ì‹œíŠ¸ êµ¬ì¡°ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤</li>
                <li>APIì—ì„œ ì˜ˆì•½ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì…€ì— ì±„ì› ìŠµë‹ˆë‹¤</li>
                <li>ì¹˜ë£Œì‚¬ë³„ ìƒ‰ìƒì„ ì§€ì •í–ˆìŠµë‹ˆë‹¤</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì…€ ìŠ¤íƒ€ì¼ì„ ë” ê¾¸ë©°ë´…ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
