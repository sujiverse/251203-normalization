<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24ì¥: í™˜ì ê´€ë¦¬ ì‹œíŠ¸ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">í™˜ì ê´€ë¦¬ ì‹œíŠ¸</h1>

            <h2>í™˜ì ê´€ë¦¬ ì‹œíŠ¸ êµ¬ì¡°</h2>

            <pre class="file-tree">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ í™˜ì ê´€ë¦¬                           [ê²€ìƒ‰: ________] [ì¶”ê°€] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì´ë¦„   â”‚ ìƒë…„ì›”ì¼â”‚ ì—°ë½ì²˜ â”‚ ì§„ë‹¨ëª… â”‚ ë“±ë¡ì¼   â”‚ ë‹´ë‹¹ ì¹˜ë£Œì‚¬    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ê¹€ì² ìˆ˜ â”‚1980-05-â”‚010-1234â”‚ì–´ê¹¨ í†µì¦â”‚2024-01-15â”‚ ê¹€ì¹˜ë£Œ        â”‚
â”‚ ì´ì˜í¬ â”‚1975-03-â”‚010-5678â”‚í—ˆë¦¬ í†µì¦â”‚2024-02-20â”‚ ì´ì¹˜ë£Œ        â”‚
â”‚ ë°•ë¯¼ìˆ˜ â”‚1990-11-â”‚010-9012â”‚ë¬´ë¦ ì¬í™œâ”‚2024-03-10â”‚ ë°•ì¹˜ë£Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>

            <hr>

            <h2>í™˜ì ëª©ë¡ API</h2>

            <pre><code># app.py

@app.route('/api/patients/sheet')
def get_patients_for_sheet():
    search = request.args.get('search', '')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        if search:
            cursor.execute("""
                SELECT
                    p.patient_id,
                    p.name,
                    p.birth_date,
                    p.phone,
                    p.diagnosis,
                    p.registration_date,
                    t.name as therapist_name
                FROM patients p
                LEFT JOIN therapists t ON p.primary_therapist_id = t.therapist_id
                WHERE p.name LIKE %s OR p.phone LIKE %s
                ORDER BY p.name
            """, (f'%{search}%', f'%{search}%'))
        else:
            cursor.execute("""
                SELECT
                    p.patient_id,
                    p.name,
                    p.birth_date,
                    p.phone,
                    p.diagnosis,
                    p.registration_date,
                    t.name as therapist_name
                FROM patients p
                LEFT JOIN therapists t ON p.primary_therapist_id = t.therapist_id
                ORDER BY p.name
            """)

        patients = cursor.fetchall()

        return jsonify({
            'success': True,
            'patients': patients
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ì‹œíŠ¸ ë°ì´í„° ë³€í™˜</h2>

            <pre><code>// static/js/patients-sheet.js

const PATIENT_COLUMNS = [
    { key: 'name', title: 'ì´ë¦„', width: 80 },
    { key: 'birth_date', title: 'ìƒë…„ì›”ì¼', width: 100 },
    { key: 'phone', title: 'ì—°ë½ì²˜', width: 120 },
    { key: 'diagnosis', title: 'ì§„ë‹¨ëª…', width: 150 },
    { key: 'registration_date', title: 'ë“±ë¡ì¼', width: 100 },
    { key: 'therapist_name', title: 'ë‹´ë‹¹ ì¹˜ë£Œì‚¬', width: 100 }
];

function createPatientSheetData(patients) {
    const celldata = [];

    // í—¤ë” í–‰
    PATIENT_COLUMNS.forEach((col, i) => {
        celldata.push({
            r: 0, c: i,
            v: {
                v: col.key,
                m: col.title,
                bg: '#1e293b',
                fc: '#ffffff',
                bl: 1,
                ht: 1
            }
        });
    });

    // ë°ì´í„° í–‰
    patients.forEach((patient, rowIdx) => {
        PATIENT_COLUMNS.forEach((col, colIdx) => {
            let value = patient[col.key] || '';

            // ë‚ ì§œ í¬ë§·
            if (col.key.includes('date') && value) {
                value = formatDate(value);
            }

            celldata.push({
                r: rowIdx + 1,
                c: colIdx,
                v: {
                    v: col.key === 'name' ? patient.patient_id : value,
                    m: value,
                    ht: colIdx === 0 ? 0 : 1  // ì´ë¦„ì€ ì™¼ìª½ ì •ë ¬
                }
            });
        });
    });

    return celldata;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}</code></pre>

            <hr>

            <h2>í™˜ì ì‹œíŠ¸ ì´ˆê¸°í™”</h2>

            <pre><code>async function initPatientSheet() {
    const search = document.getElementById('searchInput')?.value || '';

    const response = await fetch(`/api/patients/sheet?search=${encodeURIComponent(search)}`);
    const { patients } = await response.json();

    const celldata = createPatientSheetData(patients);

    // ì—´ ë„ˆë¹„ ì„¤ì •
    const columnlen = {};
    PATIENT_COLUMNS.forEach((col, i) => {
        columnlen[i] = col.width;
    });

    if (window.luckysheet && luckysheet.destroy) {
        luckysheet.destroy();
    }

    luckysheet.create({
        container: 'luckysheet',
        title: 'í™˜ì ê´€ë¦¬',
        lang: 'ko',
        showtoolbar: false,
        showsheetbar: false,
        showstatisticBar: false,
        allowEdit: true,
        data: [{
            name: 'í™˜ì',
            celldata: celldata,
            row: patients.length + 1,
            column: PATIENT_COLUMNS.length,
            frozen: {
                type: 'rangeRow',
                range: { row_focus: 0 }
            },
            config: { columnlen }
        }],
        hook: {
            cellUpdated: onPatientCellUpdated,
            cellMousedown: onPatientCellClick
        }
    });

    window.patientData = { patients };
}</code></pre>

            <hr>

            <h2>í™˜ì ì •ë³´ ìˆ˜ì •</h2>

            <pre><code>// ì…€ ìˆ˜ì • ì‹œ
async function onPatientCellUpdated(row, column, oldValue, newValue) {
    if (row === 0) return;  // í—¤ë”ëŠ” ë¬´ì‹œ

    const patient = window.patientData.patients[row - 1];
    if (!patient) return;

    const field = PATIENT_COLUMNS[column].key;

    // ì½ê¸° ì „ìš© í•„ë“œ
    if (field === 'registration_date' || field === 'therapist_name') {
        showToast('ì´ í•„ë“œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
        luckysheet.setCellValue(row, column, oldValue);
        return;
    }

    // API í˜¸ì¶œ
    try {
        const response = await fetch(`/api/patients/${patient.patient_id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [field]: newValue })
        });

        const result = await response.json();

        if (result.success) {
            showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
            patient[field] = newValue;
        } else {
            showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
            luckysheet.setCellValue(row, column, oldValue);
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
        luckysheet.setCellValue(row, column, oldValue);
    }
}

// ë°±ì—”ë“œ API
@app.route('/api/patients/&lt;int:patient_id&gt;', methods=['PUT'])
def update_patient(patient_id):
    data = request.get_json()

    # í—ˆìš©ëœ í•„ë“œë§Œ
    allowed_fields = ['name', 'birth_date', 'phone', 'diagnosis']
    updates = {k: v for k, v in data.items() if k in allowed_fields}

    if not updates:
        return jsonify({'success': False, 'error': 'ìˆ˜ì •í•  í•­ëª© ì—†ìŒ'})

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        set_clause = ', '.join([f'{k} = %s' for k in updates.keys()])
        values = list(updates.values()) + [patient_id]

        cursor.execute(f"""
            UPDATE patients
            SET {set_clause}
            WHERE patient_id = %s
        """, values)

        conn.commit()
        return jsonify({'success': True})

    except Exception as e:
        conn.rollback()
        return jsonify({'success': False, 'error': str(e)})
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>í™˜ì ì¶”ê°€ ëª¨ë‹¬</h2>

            <pre><code>&lt;!-- í™˜ì ì¶”ê°€ ëª¨ë‹¬ --&gt;
&lt;div id="addPatientModal" class="modal"&gt;
    &lt;div class="modal-content"&gt;
        &lt;h2&gt;ìƒˆ í™˜ì ë“±ë¡&lt;/h2&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ì´ë¦„ *&lt;/label&gt;
            &lt;input type="text" id="newPatientName" required&gt;
        &lt;/div&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ìƒë…„ì›”ì¼&lt;/label&gt;
            &lt;input type="date" id="newPatientBirth"&gt;
        &lt;/div&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ì—°ë½ì²˜&lt;/label&gt;
            &lt;input type="tel" id="newPatientPhone" placeholder="010-0000-0000"&gt;
        &lt;/div&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ì§„ë‹¨ëª…&lt;/label&gt;
            &lt;input type="text" id="newPatientDiagnosis"&gt;
        &lt;/div&gt;

        &lt;div class="form-group"&gt;
            &lt;label&gt;ë‹´ë‹¹ ì¹˜ë£Œì‚¬&lt;/label&gt;
            &lt;select id="newPatientTherapist"&gt;&lt;/select&gt;
        &lt;/div&gt;

        &lt;div class="modal-buttons"&gt;
            &lt;button onclick="saveNewPatient()"&gt;ë“±ë¡&lt;/button&gt;
            &lt;button onclick="closeAddModal()"&gt;ì·¨ì†Œ&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
async function saveNewPatient() {
    const name = document.getElementById('newPatientName').value;
    if (!name) {
        alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
    }

    const data = {
        name: name,
        birth_date: document.getElementById('newPatientBirth').value || null,
        phone: document.getElementById('newPatientPhone').value || null,
        diagnosis: document.getElementById('newPatientDiagnosis').value || null,
        primary_therapist_id: document.getElementById('newPatientTherapist').value || null
    };

    try {
        const response = await fetch('/api/patients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showToast('í™˜ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
            closeAddModal();
            initPatientSheet();  // ì‹œíŠ¸ ìƒˆë¡œê³ ì¹¨
        } else {
            alert('ë“±ë¡ ì‹¤íŒ¨: ' + result.error);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ');
    }
}
&lt;/script&gt;</code></pre>

            <hr>

            <h2>ê²€ìƒ‰ ê¸°ëŠ¥</h2>

            <pre><code>&lt;!-- ê²€ìƒ‰ì°½ --&gt;
&lt;div class="search-box"&gt;
    &lt;input type="text" id="searchInput" placeholder="ì´ë¦„ ë˜ëŠ” ì—°ë½ì²˜ë¡œ ê²€ìƒ‰..."&gt;
    &lt;button onclick="searchPatients()"&gt;ê²€ìƒ‰&lt;/button&gt;
    &lt;button onclick="clearSearch()"&gt;ì´ˆê¸°í™”&lt;/button&gt;
&lt;/div&gt;

&lt;script&gt;
// ê²€ìƒ‰
function searchPatients() {
    initPatientSheet();
}

// ì´ˆê¸°í™”
function clearSearch() {
    document.getElementById('searchInput').value = '';
    initPatientSheet();
}

// ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
document.getElementById('searchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchPatients();
    }
});
&lt;/script&gt;</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>í™˜ì ëª©ë¡ì„ ì‹œíŠ¸ í˜•íƒœë¡œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤</li>
                <li>ì…€ í¸ì§‘ìœ¼ë¡œ í™˜ì ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤</li>
                <li>ëª¨ë‹¬ë¡œ ìƒˆ í™˜ìë¥¼ ë“±ë¡í•©ë‹ˆë‹¤</li>
                <li>ê²€ìƒ‰ ê¸°ëŠ¥ìœ¼ë¡œ í™˜ìë¥¼ ì°¾ìŠµë‹ˆë‹¤</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ë§¤ì¶œ í˜„í™© ì‹œíŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
