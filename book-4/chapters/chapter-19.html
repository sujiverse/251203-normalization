<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>19ì¥: DB â†’ Luckysheet í‘œì‹œ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">DB â†’ Luckysheet í‘œì‹œ</h1>

            <h2>ì „ì²´ ë°ì´í„° íë¦„</h2>

            <div class="file-tree">
1. í˜ì´ì§€ ë¡œë“œ
      â†“
2. JavaScript: API í˜¸ì¶œ
      â†“
3. Flask: SQL ì‹¤í–‰
      â†“
4. MySQL: ë°ì´í„° ë°˜í™˜
      â†“
5. Flask: JSON ì‘ë‹µ
      â†“
6. JavaScript: celldata ë³€í™˜
      â†“
7. Luckysheet: í™”ë©´ í‘œì‹œ
            </div>

            <hr>

            <h2>ë°±ì—”ë“œ API (ë³µìŠµ)</h2>

            <pre><code># app.py

@app.route('/api/reservations/sheet')
def get_reservations_for_sheet():
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # í™˜ì ëª©ë¡
        cursor.execute("""
            SELECT patient_id, name
            FROM patients
            ORDER BY name
        """)
        patients = cursor.fetchall()

        # ì˜ˆì•½ ë°ì´í„°
        cursor.execute("""
            SELECT
                ts.patient_id,
                ts.session_date,
                TIME_FORMAT(ts.start_time, '%H:%i') as start_time,
                t.name as therapist_name
            FROM treatment_sessions ts
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE ts.session_date BETWEEN %s AND %s
              AND ts.status != 'ì·¨ì†Œ'
        """, (start_date, end_date))

        reservations_raw = cursor.fetchall()

        # í™˜ìë³„, ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
        reservations = {}
        for r in reservations_raw:
            pid = r['patient_id']
            date = str(r['session_date'])

            if pid not in reservations:
                reservations[pid] = {}

            reservations[pid][date] = {
                'time': r['start_time'],
                'therapist': r['therapist_name']
            }

        return jsonify({
            'success': True,
            'patients': patients,
            'reservations': reservations
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>í”„ë¡ íŠ¸ì—”ë“œ ì „ì²´ ì½”ë“œ</h2>

            <pre><code>// static/js/sheet.js

// ì¹˜ë£Œì‚¬ë³„ ìƒ‰ìƒ
const THERAPIST_COLORS = {
    'ê¹€ì¹˜ë£Œ': { bg: '#dbeafe', fc: '#1e40af' },
    'ì´ì¹˜ë£Œ': { bg: '#fef3c7', fc: '#92400e' },
    'ë°•ì¹˜ë£Œ': { bg: '#dcfce7', fc: '#166534' },
    'ìµœì¹˜ë£Œ': { bg: '#f3e8ff', fc: '#6b21a8' }
};

// ë‚ ì§œ ë²”ìœ„ ìƒì„±
function getDateRange(startDate, days) {
    const dates = [];
    const start = new Date(startDate);
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    for (let i = 0; i < days; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);

        dates.push({
            date: date.toISOString().split('T')[0],
            display: `${date.getMonth() + 1}/${date.getDate()}(${dayNames[date.getDay()]})`,
            day: date.getDay()
        });
    }
    return dates;
}

// í—¤ë” í–‰ ìƒì„±
function createHeaderCells(dates) {
    const cells = [{
        r: 0, c: 0,
        v: { v: 'í™˜ìëª…', m: 'í™˜ìëª…', bg: '#1e293b', fc: '#fff', bl: 1, ht: 1 }
    }];

    dates.forEach((d, i) => {
        let bg = '#f1f5f9';
        let fc = '#334155';

        if (d.day === 0) { bg = '#fef2f2'; fc = '#dc2626'; }
        if (d.day === 6) { bg = '#eff6ff'; fc = '#2563eb'; }

        cells.push({
            r: 0, c: i + 1,
            v: { v: d.date, m: d.display, bg, fc, bl: 1, ht: 1 }
        });
    });

    return cells;
}

// í™˜ì í–‰ ìƒì„±
function createPatientCells(patients) {
    return patients.map((p, i) => ({
        r: i + 1,
        c: 0,
        v: {
            v: p.patient_id,
            m: p.name,
            bg: '#fee2e2',
            fc: '#991b1b',
            bl: 1
        }
    }));
}

// ì˜ˆì•½ ì…€ ìƒì„±
function createReservationCells(patients, dates, reservations) {
    const cells = [];

    patients.forEach((patient, rowIdx) => {
        const patientRes = reservations[patient.patient_id] || {};

        dates.forEach((d, colIdx) => {
            const res = patientRes[d.date];
            if (res) {
                const colors = THERAPIST_COLORS[res.therapist] || { bg: '#f5f5f5', fc: '#333' };
                cells.push({
                    r: rowIdx + 1,
                    c: colIdx + 1,
                    v: {
                        v: `${res.time}|${res.therapist}`,  // ì‹¤ì œê°’: ì‹œê°„|ì¹˜ë£Œì‚¬
                        m: res.time,                        // í‘œì‹œê°’: ì‹œê°„ë§Œ
                        bg: colors.bg,
                        fc: colors.fc,
                        ht: 1
                    }
                });
            }
        });
    });

    return cells;
}

// ë©”ì¸ ì´ˆê¸°í™” í•¨ìˆ˜
async function initSheet(startDateStr, days = 14) {
    const startDate = startDateStr || new Date().toISOString().split('T')[0];
    const dates = getDateRange(startDate, days);

    const endDate = dates[dates.length - 1].date;

    // API í˜¸ì¶œ
    const response = await fetch(
        `/api/reservations/sheet?start_date=${startDate}&end_date=${endDate}`
    );
    const { patients, reservations } = await response.json();

    // ì…€ ë°ì´í„° ìƒì„±
    const celldata = [
        ...createHeaderCells(dates),
        ...createPatientCells(patients),
        ...createReservationCells(patients, dates, reservations)
    ];

    // ê¸°ì¡´ ì‹œíŠ¸ ì œê±°
    if (window.luckysheet && luckysheet.destroy) {
        luckysheet.destroy();
    }

    // Luckysheet ìƒì„±
    luckysheet.create({
        container: 'luckysheet',
        title: 'ì˜ˆì•½ í˜„í™©',
        lang: 'ko',
        showtoolbar: false,
        showsheetbar: false,
        showstatisticBar: false,
        allowEdit: true,
        enableAddRow: false,
        data: [{
            name: 'ì˜ˆì•½',
            celldata: celldata,
            row: patients.length + 1,
            column: dates.length + 1,
            frozen: {
                type: 'rangeBoth',
                range: { row_focus: 0, column_focus: 0 }
            },
            config: {
                columnlen: { 0: 100 }
            }
        }]
    });

    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— ìˆ˜ì •í•  ë•Œ ì‚¬ìš©)
    window.sheetData = { patients, dates, reservations };
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', () => {
    initSheet();
});</code></pre>

            <hr>

            <h2>HTML í…œí”Œë¦¿</h2>

            <pre><code>&lt;!-- templates/reservations.html --&gt;
{% extends "base.html" %}

{% block title %}ì˜ˆì•½ ê´€ë¦¬{% endblock %}

{% block content %}
&lt;div class="sheet-container"&gt;
    &lt;div class="sheet-header"&gt;
        &lt;h1&gt;ì˜ˆì•½ í˜„í™©&lt;/h1&gt;
        &lt;div class="controls"&gt;
            &lt;input type="date" id="startDate"&gt;
            &lt;select id="days"&gt;
                &lt;option value="7"&gt;1ì£¼&lt;/option&gt;
                &lt;option value="14" selected&gt;2ì£¼&lt;/option&gt;
                &lt;option value="30"&gt;1ê°œì›”&lt;/option&gt;
            &lt;/select&gt;
            &lt;button onclick="reloadSheet()"&gt;ì ìš©&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="legend" id="legend"&gt;&lt;/div&gt;

    &lt;div id="luckysheet" style="width: 100%; height: calc(100vh - 200px);"&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
function reloadSheet() {
    const start = document.getElementById('startDate').value;
    const days = parseInt(document.getElementById('days').value);
    initSheet(start, days);
}
&lt;/script&gt;
{% endblock %}</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>DB â†’ API â†’ JavaScript â†’ Luckysheet íë¦„ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤</li>
                <li>í™˜ì, ë‚ ì§œ, ì˜ˆì•½ ë°ì´í„°ë¥¼ celldataë¡œ ë³€í™˜í•©ë‹ˆë‹¤</li>
                <li>ë‚ ì§œ ë²”ìœ„ ì»¨íŠ¸ë¡¤ë¡œ í‘œì‹œ ê¸°ê°„ì„ ì¡°ì ˆí•©ë‹ˆë‹¤</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì…€ í¸ì§‘ì„ ê°ì§€í•˜ëŠ” ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
