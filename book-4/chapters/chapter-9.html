<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9ì¥: ì˜ˆì•½ ì¡°íšŒ API - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 4ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "4"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ“• ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ</h1>
                <p>ì›¹ ì•± ë§Œë“¤ê¸° (4ê¶Œ)</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ì˜ˆì•½ ì¡°íšŒ API</h1>

            <h2>ì˜ˆì•½ ë°ì´í„° êµ¬ì¡°</h2>

            <p>3ê¶Œì—ì„œ ë§Œë“  <code>treatment_sessions</code> í…Œì´ë¸”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

            <table>
                <tr>
                    <th>ì»¬ëŸ¼</th>
                    <th>ì„¤ëª…</th>
                </tr>
                <tr>
                    <td>session_id</td>
                    <td>ì„¸ì…˜ ID (PK)</td>
                </tr>
                <tr>
                    <td>patient_id</td>
                    <td>í™˜ì ID (FK)</td>
                </tr>
                <tr>
                    <td>therapist_id</td>
                    <td>ì¹˜ë£Œì‚¬ ID (FK)</td>
                </tr>
                <tr>
                    <td>session_date</td>
                    <td>ì˜ˆì•½ ë‚ ì§œ</td>
                </tr>
                <tr>
                    <td>start_time</td>
                    <td>ì‹œì‘ ì‹œê°„</td>
                </tr>
                <tr>
                    <td>status</td>
                    <td>ìƒíƒœ (ì˜ˆì•½/ì™„ë£Œ/ì·¨ì†Œ)</td>
                </tr>
            </table>

            <hr>

            <h2>ë‚ ì§œë³„ ì˜ˆì•½ ì¡°íšŒ</h2>

            <pre><code>@app.route('/api/reservations')
def get_reservations():
    date = request.args.get('date')  # 2024-12-01 í˜•ì‹

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        sql = """
            SELECT
                ts.session_id,
                ts.session_date,
                ts.start_time,
                ts.status,
                p.patient_id,
                p.name as patient_name,
                t.therapist_id,
                t.name as therapist_name
            FROM treatment_sessions ts
            JOIN patients p ON ts.patient_id = p.patient_id
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE 1=1
        """
        params = []

        if date:
            sql += " AND ts.session_date = %s"
            params.append(date)

        sql += " ORDER BY ts.session_date, ts.start_time"

        cursor.execute(sql, params)
        reservations = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': reservations,
            'count': len(reservations)
        })
    finally:
        conn.close()</code></pre>

            <h3>í…ŒìŠ¤íŠ¸</h3>
            <ul>
                <li><code>/api/reservations</code> â†’ ì „ì²´ ì˜ˆì•½</li>
                <li><code>/api/reservations?date=2024-12-01</code> â†’ íŠ¹ì • ë‚ ì§œ</li>
            </ul>

            <hr>

            <h2>ë‚ ì§œ ë²”ìœ„ ì¡°íšŒ</h2>

            <p>Luckysheetì—ì„œ ì—¬ëŸ¬ ë‚ ì§œì˜ ì˜ˆì•½ì„ í•œë²ˆì— ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤.</p>

            <pre><code>@app.route('/api/reservations')
def get_reservations():
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')
    therapist_id = request.args.get('therapist_id', type=int)

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        sql = """
            SELECT
                ts.session_id,
                ts.session_date,
                TIME_FORMAT(ts.start_time, '%H:%i') as start_time,
                ts.status,
                p.patient_id,
                p.name as patient_name,
                t.therapist_id,
                t.name as therapist_name
            FROM treatment_sessions ts
            JOIN patients p ON ts.patient_id = p.patient_id
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE 1=1
        """
        params = []

        if start_date:
            sql += " AND ts.session_date >= %s"
            params.append(start_date)

        if end_date:
            sql += " AND ts.session_date <= %s"
            params.append(end_date)

        if therapist_id:
            sql += " AND ts.therapist_id = %s"
            params.append(therapist_id)

        sql += " ORDER BY ts.session_date, ts.start_time"

        cursor.execute(sql, params)
        reservations = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': reservations,
            'count': len(reservations),
            'filters': {
                'start_date': start_date,
                'end_date': end_date,
                'therapist_id': therapist_id
            }
        })
    finally:
        conn.close()</code></pre>

            <h3>í…ŒìŠ¤íŠ¸</h3>
            <ul>
                <li><code>/api/reservations?start_date=2024-12-01&end_date=2024-12-07</code></li>
                <li><code>/api/reservations?therapist_id=1</code></li>
            </ul>

            <hr>

            <h2>ì‹œíŠ¸ìš© ë°ì´í„° í˜•ì‹</h2>

            <p>Luckysheetì—ì„œ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>

            <pre><code>@app.route('/api/reservations/sheet')
def get_reservations_for_sheet():
    start_date = request.args.get('start_date')
    end_date = request.args.get('end_date')

    conn = get_db_connection()
    try:
        cursor = conn.cursor()

        # í™˜ì ëª©ë¡ (í–‰ ë°ì´í„°)
        cursor.execute("SELECT patient_id, name FROM patients ORDER BY name")
        patients = cursor.fetchall()

        # ì˜ˆì•½ ë°ì´í„°
        cursor.execute("""
            SELECT
                ts.patient_id,
                ts.session_date,
                TIME_FORMAT(ts.start_time, '%H:%i') as start_time,
                t.name as therapist_name
            FROM treatment_sessions ts
            JOIN therapists t ON ts.therapist_id = t.therapist_id
            WHERE ts.session_date BETWEEN %s AND %s
              AND ts.status != 'ì·¨ì†Œ'
            ORDER BY ts.session_date, ts.start_time
        """, (start_date, end_date))
        reservations = cursor.fetchall()

        # ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
        # {patient_id: {date: {time, therapist}, ...}, ...}
        sheet_data = {}
        for res in reservations:
            pid = res['patient_id']
            date = str(res['session_date'])

            if pid not in sheet_data:
                sheet_data[pid] = {}

            sheet_data[pid][date] = {
                'time': res['start_time'],
                'therapist': res['therapist_name']
            }

        return jsonify({
            'success': True,
            'patients': patients,
            'reservations': sheet_data,
            'date_range': {
                'start': start_date,
                'end': end_date
            }
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ì‘ë‹µ ì˜ˆì‹œ</h2>

            <pre><code>{
    "success": true,
    "patients": [
        {"patient_id": 1, "name": "ê¹€ì² ìˆ˜"},
        {"patient_id": 2, "name": "ì´ì˜í¬"}
    ],
    "reservations": {
        "1": {
            "2024-12-01": {"time": "10:00", "therapist": "ë°•ì¹˜ë£Œ"},
            "2024-12-03": {"time": "14:00", "therapist": "ê¹€ì¹˜ë£Œ"}
        },
        "2": {
            "2024-12-02": {"time": "11:00", "therapist": "ì´ì¹˜ë£Œ"}
        }
    }
}</code></pre>

            <p>ì´ í˜•ì‹ì´ë©´ Luckysheetì—ì„œ:</p>
            <ul>
                <li>patients â†’ í–‰ í—¤ë” (ì²« ì—´)</li>
                <li>ë‚ ì§œ â†’ ì—´ í—¤ë” (ì²« í–‰)</li>
                <li>reservations â†’ ì…€ ë‚´ìš©</li>
            </ul>

            <hr>

            <h2>ì¹˜ë£Œì‚¬ ëª©ë¡ API</h2>

            <p>ë“œë¡­ë‹¤ìš´ì´ë‚˜ ìƒ‰ìƒ ì§€ì •ìš©ìœ¼ë¡œ í•„ìš”í•©ë‹ˆë‹¤.</p>

            <pre><code>@app.route('/api/therapists')
def get_therapists():
    conn = get_db_connection()
    try:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT therapist_id, name, specialty
            FROM therapists
            WHERE is_active = 1
            ORDER BY name
        """)
        therapists = cursor.fetchall()

        return jsonify({
            'success': True,
            'data': therapists
        })
    finally:
        conn.close()</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ë‚ ì§œë³„/ë²”ìœ„ë³„ ì˜ˆì•½ ì¡°íšŒ APIë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤</li>
                <li>Luckysheetìš© ë°ì´í„° í˜•ì‹ì„ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤</li>
                <li>JOINìœ¼ë¡œ í™˜ìëª…, ì¹˜ë£Œì‚¬ëª…ì„ í•¨ê»˜ ê°€ì ¸ì˜µë‹ˆë‹¤</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì˜ˆì•½ ìƒì„±/ìˆ˜ì •/ì‚­ì œ APIë¥¼ ë§Œë“­ë‹ˆë‹¤. CRUD ì™„ì„±!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
