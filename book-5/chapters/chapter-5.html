<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5ì¥: CSRF ê³µê²©ê³¼ ë°©ì–´ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 5ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "5"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ›¡ï¸ 5ê¶Œ: ë³´ì•ˆ í¸</h1>
                <p>DB & ì„œë²„ ë³´ì•ˆ</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">CSRF ê³µê²©ê³¼ ë°©ì–´</h1>

            <h2>CSRF(Cross-Site Request Forgery)ë€?</h2>

            <p>ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ìƒíƒœë¥¼ ì´ìš©í•´ì„œ ì˜ë„í•˜ì§€ ì•Šì€ ìš”ì²­ì„ ë³´ë‚´ê²Œ í•˜ëŠ” ê³µê²©ì…ë‹ˆë‹¤.</p>

            <blockquote>
                ì‚¬ìš©ìê°€ íë§ì† ì‹œìŠ¤í…œì— ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œ<br>
                ì•…ì„± ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•˜ë©´, ìë™ìœ¼ë¡œ í™˜ì ì •ë³´ê°€ ìˆ˜ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </blockquote>

            <hr>

            <h2>CSRF ê³µê²© ì›ë¦¬</h2>

            <pre class="file-tree">ê³µê²© ì‹œë‚˜ë¦¬ì˜¤
â”‚
â”œâ”€â”€ 1. ê´€ë¦¬ìê°€ íë§ì†ì— ë¡œê·¸ì¸ (ì„¸ì…˜ ìœ ì§€)
â”‚
â”œâ”€â”€ 2. ì•…ì„± ì´ë©”ì¼/ì‚¬ì´íŠ¸ í´ë¦­
â”‚   â””â”€â”€ "ë¬´ë£Œ ì¹˜ë£Œ ì¥ë¹„ ì¦ì •" ë§í¬
â”‚
â”œâ”€â”€ 3. ì•…ì„± ì‚¬ì´íŠ¸ì˜ ìˆ¨ê²¨ì§„ í¼ì´ ìë™ ì œì¶œ
â”‚   â””â”€â”€ íë§ì† ì„œë²„ë¡œ ìš”ì²­ ì „ì†¡
â”‚
â””â”€â”€ 4. ì„œë²„ëŠ” ì •ìƒ ìš”ì²­ìœ¼ë¡œ ì¸ì‹
    â””â”€â”€ ê´€ë¦¬ì ì„¸ì…˜ìœ¼ë¡œ ì‹¤í–‰ë¨!</pre>

            <hr>

            <h2>ê³µê²© ì˜ˆì‹œ 1: ìˆ¨ê²¨ì§„ í¼</h2>

            <pre><code>&lt;!-- ì•…ì„± ì‚¬ì´íŠ¸ì˜ HTML --&gt;
&lt;h1&gt;ì¶•í•˜í•©ë‹ˆë‹¤! ê²½í’ˆì— ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!&lt;/h1&gt;

&lt;!-- ìˆ¨ê²¨ì§„ í¼ - ìë™ ì œì¶œ --&gt;
&lt;form id="evil" action="https://healing-hands.com/api/patients/P001" method="POST" style="display:none"&gt;
    &lt;input name="phone" value="010-9999-9999"&gt;
    &lt;input name="address" value="í•´ì»¤ì£¼ì†Œ"&gt;
&lt;/form&gt;

&lt;script&gt;
    document.getElementById('evil').submit();
&lt;/script&gt;

&lt;!-- í”¼í•´ìê°€ í˜ì´ì§€ë¥¼ ì—´ë©´ ìë™ìœ¼ë¡œ í™˜ì ì •ë³´ ìˆ˜ì •! --&gt;</code></pre>

            <h2>ê³µê²© ì˜ˆì‹œ 2: ì´ë¯¸ì§€ íƒœê·¸</h2>

            <pre><code>&lt;!-- GET ìš”ì²­ì„ íŠ¸ë¦¬ê±°í•˜ëŠ” ì´ë¯¸ì§€ --&gt;
&lt;img src="https://healing-hands.com/api/patients/P001/delete" style="display:none"&gt;

&lt;!-- í˜ì´ì§€ ë¡œë“œë§Œìœ¼ë¡œ ì‚­ì œ ìš”ì²­ ì‹¤í–‰! --&gt;</code></pre>

            <h2>ê³µê²© ì˜ˆì‹œ 3: ë§í¬</h2>

            <pre><code>&lt;!-- ì´ë©”ì¼ì— í¬í•¨ëœ ë§í¬ --&gt;
&lt;a href="https://healing-hands.com/api/admin/add?username=hacker&password=1234"&gt;
    í´ë¦­í•˜ë©´ ê²½í’ˆ ë‹¹ì²¨!
&lt;/a&gt;

&lt;!-- ê´€ë¦¬ìê°€ í´ë¦­í•˜ë©´ í•´ì»¤ ê³„ì • ìƒì„±! --&gt;</code></pre>

            <hr>

            <h2>ë°©ì–´ 1: CSRF í† í°</h2>

            <p>ì„œë²„ê°€ ìƒì„±í•œ ë¹„ë°€ í† í°ì„ í¼ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.</p>

            <pre><code>from flask import Flask, session, request
from flask_wtf.csrf import CSRFProtect
import secrets

app = Flask(__name__)
app.secret_key = secrets.token_hex(32)

# CSRF ë³´í˜¸ í™œì„±í™”
csrf = CSRFProtect(app)</code></pre>

            <p>í…œí”Œë¦¿ì—ì„œ CSRF í† í° ì‚¬ìš©:</p>

            <pre><code>&lt;!-- Jinja2 í…œí”Œë¦¿ --&gt;
&lt;form method="POST" action="/api/patients"&gt;
    &lt;input type="hidden" name="csrf_token" value="{{ csrf_token() }}"&gt;

    &lt;input type="text" name="name"&gt;
    &lt;input type="text" name="phone"&gt;
    &lt;button type="submit"&gt;ì €ì¥&lt;/button&gt;
&lt;/form&gt;</code></pre>

            <p>ì„œë²„ì—ì„œ ê²€ì¦:</p>
            <pre><code># Flask-WTFê°€ ìë™ìœ¼ë¡œ ê²€ì¦
# í† í°ì´ ì—†ê±°ë‚˜ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ 400 ì—ëŸ¬

@app.route('/api/patients', methods=['POST'])
def create_patient():
    # CSRF í† í°ì´ ìë™ìœ¼ë¡œ ê²€ì¦ë¨
    name = request.form['name']
    ...</code></pre>

            <hr>

            <h2>ë°©ì–´ 2: SameSite ì¿ í‚¤</h2>

            <p>ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì¿ í‚¤ê°€ ì „ì†¡ë˜ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.</p>

            <pre><code>from flask import Flask

app = Flask(__name__)

# SameSite ì¿ í‚¤ ì„¤ì •
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'  # ê¶Œì¥
# ë˜ëŠ” 'Strict' - ë” ì—„ê²©í•˜ì§€ë§Œ ì‚¬ìš©ì„± ì €í•˜</code></pre>

            <p>SameSite ì˜µì…˜:</p>
            <table>
                <tr>
                    <th>ê°’</th>
                    <th>ì„¤ëª…</th>
                    <th>ì¶”ì²œ</th>
                </tr>
                <tr>
                    <td>Strict</td>
                    <td>ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì¿ í‚¤ ì ˆëŒ€ ì „ì†¡ ì•ˆ í•¨</td>
                    <td>ë³´ì•ˆ ìµœìš°ì„ </td>
                </tr>
                <tr>
                    <td>Lax</td>
                    <td>ë§í¬ í´ë¦­ì€ í—ˆìš©, POSTëŠ” ì°¨ë‹¨</td>
                    <td>ì¼ë°˜ì  ì¶”ì²œ</td>
                </tr>
                <tr>
                    <td>None</td>
                    <td>í•­ìƒ ì „ì†¡ (HTTPS í•„ìˆ˜)</td>
                    <td>ë¹„ì¶”ì²œ</td>
                </tr>
            </table>

            <hr>

            <h2>ë°©ì–´ 3: Referer ê²€ì¦</h2>

            <p>ìš”ì²­ì´ ì–´ë””ì„œ ì™”ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>

            <pre><code>from urllib.parse import urlparse

ALLOWED_ORIGINS = ['https://healing-hands.com', 'https://www.healing-hands.com']

@app.before_request
def check_referer():
    if request.method in ['POST', 'PUT', 'DELETE']:
        referer = request.headers.get('Referer')

        if not referer:
            return {'error': 'ì˜ëª»ëœ ìš”ì²­'}, 403

        origin = f"{urlparse(referer).scheme}://{urlparse(referer).netloc}"

        if origin not in ALLOWED_ORIGINS:
            return {'error': 'í—ˆìš©ë˜ì§€ ì•Šì€ ì¶œì²˜'}, 403</code></pre>

            <hr>

            <h2>ë°©ì–´ 4: ì¤‘ìš” ì‘ì—…ì— ì¬ì¸ì¦</h2>

            <pre><code>@app.route('/api/patients/&lt;id&gt;/delete', methods=['POST'])
def delete_patient(id):
    # ì¤‘ìš” ì‘ì—… ì „ ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸
    password = request.form.get('password')

    if not verify_password(session['user_id'], password):
        return {'error': 'ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”'}, 401

    # ì‚­ì œ ì§„í–‰
    ...</code></pre>

            <hr>

            <h2>AJAX ìš”ì²­ ë³´í˜¸</h2>

            <pre><code>// JavaScriptì—ì„œ CSRF í† í° ì „ì†¡
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

fetch('/api/patients', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken  // ì»¤ìŠ¤í…€ í—¤ë”ë¡œ ì „ì†¡
    },
    body: JSON.stringify(data)
});</code></pre>

            <p>ì„œë²„ì—ì„œ í—¤ë” ê²€ì¦:</p>
            <pre><code># Flask-WTF ì„¤ì •
app.config['WTF_CSRF_HEADERS'] = ['X-CSRFToken']</code></pre>

            <hr>

            <h2>ì•ˆì „í•˜ì§€ ì•Šì€ íŒ¨í„´</h2>

            <pre><code># âŒ GETìœ¼ë¡œ ìƒíƒœ ë³€ê²½ (ìœ„í—˜!)
@app.route('/api/patients/&lt;id&gt;/delete')  # GET
def delete_patient(id):
    cursor.execute("DELETE FROM patients WHERE id = %s", (id,))

# âœ… POST/DELETEë¡œ ìƒíƒœ ë³€ê²½ (ì•ˆì „)
@app.route('/api/patients/&lt;id&gt;', methods=['DELETE'])
def delete_patient(id):
    # CSRF í† í° ê²€ì¦ í›„ ì‚­ì œ
    cursor.execute("DELETE FROM patients WHERE id = %s", (id,))</code></pre>

            <hr>

            <h2>CSRF ë°©ì–´ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

            <table>
                <tr>
                    <th>í•­ëª©</th>
                    <th>í™•ì¸</th>
                </tr>
                <tr>
                    <td>ëª¨ë“  í¼ì— CSRF í† í° í¬í•¨</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>SameSite ì¿ í‚¤ ì„¤ì •</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>GETìœ¼ë¡œ ìƒíƒœ ë³€ê²½ ì•ˆ í•¨</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>AJAXì—ì„œ CSRF í† í° ì „ì†¡</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ì¤‘ìš” ì‘ì—…ì— ì¬ì¸ì¦</td>
                    <td>â˜</td>
                </tr>
            </table>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li><strong>CSRF</strong>ëŠ” ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ì•…ìš©í•˜ëŠ” ê³µê²©</li>
                <li><strong>CSRF í† í°</strong>ìœ¼ë¡œ ì •ë‹¹í•œ ìš”ì²­ì¸ì§€ í™•ì¸</li>
                <li><strong>SameSite ì¿ í‚¤</strong>ë¡œ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì¿ í‚¤ ì „ì†¡ ì°¨ë‹¨</li>
                <li>ìƒíƒœ ë³€ê²½ì€ ë°˜ë“œì‹œ <strong>POST/PUT/DELETE</strong>ë¡œ</li>
                <li>ì¤‘ìš” ì‘ì—…ì€ <strong>ì¬ì¸ì¦</strong> ìš”êµ¬</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ì•ˆì „í•œ ì¸ì¦ê³¼ ì„¸ì…˜ ê´€ë¦¬ë¥¼ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
