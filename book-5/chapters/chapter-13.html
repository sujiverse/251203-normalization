<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>13ì¥: ë¡œê¹…ê³¼ ëª¨ë‹ˆí„°ë§ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 5ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "5"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ›¡ï¸ 5ê¶Œ: ë³´ì•ˆ í¸</h1>
                <p>DB & ì„œë²„ ë³´ì•ˆ</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ë¡œê¹…ê³¼ ëª¨ë‹ˆí„°ë§</h1>

            <h2>ë¡œê¹…ì´ í•„ìš”í•œ ì´ìœ </h2>

            <blockquote>
                "ë¡œê·¸ê°€ ì—†ìœ¼ë©´ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚¬ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            </blockquote>

            <pre class="file-tree">ë¡œê·¸ì˜ ìš©ë„
â”‚
â”œâ”€â”€ ë³´ì•ˆ
â”‚   â”œâ”€â”€ ì¹¨ì… íƒì§€
â”‚   â”œâ”€â”€ ê³µê²© ë¶„ì„
â”‚   â””â”€â”€ ì‚¬ê³  ëŒ€ì‘
â”‚
â”œâ”€â”€ ë””ë²„ê¹…
â”‚   â”œâ”€â”€ ì—ëŸ¬ ì›ì¸ íŒŒì•…
â”‚   â””â”€â”€ ì„±ëŠ¥ ë¬¸ì œ ë¶„ì„
â”‚
â””â”€â”€ ê°ì‚¬
    â”œâ”€â”€ ëˆ„ê°€ ì–¸ì œ ë­˜ í–ˆëŠ”ì§€
    â””â”€â”€ ë²•ì  ìš”êµ¬ì‚¬í•­ ì¶©ì¡±</pre>

            <hr>

            <h2>Flask ë¡œê¹… ì„¤ì •</h2>

            <pre><code>import logging
from logging.handlers import RotatingFileHandler
from flask import Flask, request

app = Flask(__name__)

# ë¡œê·¸ í¬ë§· ì„¤ì •
formatter = logging.Formatter(
    '[%(asctime)s] %(levelname)s in %(module)s: %(message)s'
)

# íŒŒì¼ í•¸ë“¤ëŸ¬ (10MBë§ˆë‹¤ ë¡œí…Œì´ì…˜, ìµœëŒ€ 10ê°œ íŒŒì¼)
file_handler = RotatingFileHandler(
    '/var/log/healing-hands/app.log',
    maxBytes=10*1024*1024,
    backupCount=10
)
file_handler.setFormatter(formatter)
file_handler.setLevel(logging.INFO)

# ì•±ì— í•¸ë“¤ëŸ¬ ì¶”ê°€
app.logger.addHandler(file_handler)
app.logger.setLevel(logging.INFO)

# ìš”ì²­ ë¡œê¹…
@app.before_request
def log_request():
    app.logger.info(f'{request.method} {request.path} - {request.remote_addr}')</code></pre>

            <hr>

            <h2>ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê¹…</h2>

            <pre><code>import json
from datetime import datetime

def log_security_event(event_type, details, user_id=None):
    """ë³´ì•ˆ ì´ë²¤íŠ¸ ë¡œê¹…"""
    event = {
        'timestamp': datetime.utcnow().isoformat(),
        'event_type': event_type,
        'user_id': user_id,
        'ip_address': request.remote_addr,
        'user_agent': request.headers.get('User-Agent'),
        'details': details
    }

    # ë³´ì•ˆ ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡
    with open('/var/log/healing-hands/security.log', 'a') as f:
        f.write(json.dumps(event) + '\n')

# ì‚¬ìš© ì˜ˆì‹œ

# ë¡œê·¸ì¸ ì„±ê³µ
@app.route('/login', methods=['POST'])
def login():
    if authenticate(username, password):
        log_security_event('LOGIN_SUCCESS', {'username': username}, user_id=user.id)
        return {'success': True}
    else:
        log_security_event('LOGIN_FAILURE', {'username': username, 'reason': 'invalid_password'})
        return {'error': 'ì¸ì¦ ì‹¤íŒ¨'}, 401

# ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì‹œë„
@app.route('/admin/users')
@login_required
def admin_users():
    if session.get('role') != 'admin':
        log_security_event('UNAUTHORIZED_ACCESS', {
            'path': request.path,
            'required_role': 'admin'
        }, user_id=session.get('user_id'))
        return {'error': 'ê¶Œí•œ ì—†ìŒ'}, 403
    ...</code></pre>

            <hr>

            <h2>ë¡œê·¸ ë ˆë²¨</h2>

            <table>
                <tr>
                    <th>ë ˆë²¨</th>
                    <th>ìš©ë„</th>
                    <th>ì˜ˆì‹œ</th>
                </tr>
                <tr>
                    <td>DEBUG</td>
                    <td>ê°œë°œ ì‹œ ìƒì„¸ ì •ë³´</td>
                    <td>ë³€ìˆ˜ ê°’, í•¨ìˆ˜ í˜¸ì¶œ</td>
                </tr>
                <tr>
                    <td>INFO</td>
                    <td>ì¼ë°˜ì ì¸ ì •ë³´</td>
                    <td>ìš”ì²­ ì²˜ë¦¬, ì‘ì—… ì™„ë£Œ</td>
                </tr>
                <tr>
                    <td>WARNING</td>
                    <td>ì ì¬ì  ë¬¸ì œ</td>
                    <td>deprecated ì‚¬ìš©</td>
                </tr>
                <tr>
                    <td>ERROR</td>
                    <td>ì—ëŸ¬ ë°œìƒ</td>
                    <td>ì˜ˆì™¸ ì²˜ë¦¬, DB ì—°ê²° ì‹¤íŒ¨</td>
                </tr>
                <tr>
                    <td>CRITICAL</td>
                    <td>ì‹¬ê°í•œ ë¬¸ì œ</td>
                    <td>ì„œë¹„ìŠ¤ ì¤‘ë‹¨</td>
                </tr>
            </table>

            <pre><code># ìš´ì˜ í™˜ê²½: INFO ì´ìƒë§Œ ê¸°ë¡
app.logger.setLevel(logging.INFO)

# ê°œë°œ í™˜ê²½: DEBUG í¬í•¨ ì „ì²´ ê¸°ë¡
app.logger.setLevel(logging.DEBUG)</code></pre>

            <hr>

            <h2>MySQL ë¡œê¹…</h2>

            <pre><code># my.cnf

[mysqld]
# ì—ëŸ¬ ë¡œê·¸
log_error = /var/log/mysql/error.log

# ì¼ë°˜ ì¿¼ë¦¬ ë¡œê·¸ (ì„±ëŠ¥ ì˜í–¥ ìˆìŒ)
general_log = 1
general_log_file = /var/log/mysql/general.log

# ìŠ¬ë¡œìš° ì¿¼ë¦¬ ë¡œê·¸
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2  # 2ì´ˆ ì´ìƒ ê±¸ë¦¬ëŠ” ì¿¼ë¦¬</code></pre>

            <pre><code>-- ê°ì‚¬ í…Œì´ë¸” ìƒì„±
CREATE TABLE audit_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50),
    action VARCHAR(10),
    record_id VARCHAR(50),
    old_data JSON,
    new_data JSON,
    user_id INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- íŠ¸ë¦¬ê±°ë¡œ ë³€ê²½ ê¸°ë¡
DELIMITER //
CREATE TRIGGER patients_audit_update
AFTER UPDATE ON patients
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (table_name, action, record_id, old_data, new_data, user_id)
    VALUES (
        'patients',
        'UPDATE',
        OLD.patient_id,
        JSON_OBJECT('name', OLD.name, 'phone', OLD.phone),
        JSON_OBJECT('name', NEW.name, 'phone', NEW.phone),
        @current_user_id
    );
END //
DELIMITER ;</code></pre>

            <hr>

            <h2>ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í™œë™ íƒì§€</h2>

            <pre><code>from collections import defaultdict
from datetime import datetime, timedelta

# IPë³„ ìš”ì²­ ì¹´ìš´íŠ¸
request_counts = defaultdict(list)

@app.before_request
def detect_suspicious_activity():
    ip = request.remote_addr
    now = datetime.now()

    # 1ë¶„ ì´ë‚´ ìš”ì²­ë§Œ ìœ ì§€
    request_counts[ip] = [
        t for t in request_counts[ip]
        if now - t < timedelta(minutes=1)
    ]
    request_counts[ip].append(now)

    # 1ë¶„ì— 100íšŒ ì´ìƒì´ë©´ ì˜ì‹¬
    if len(request_counts[ip]) > 100:
        log_security_event('RATE_LIMIT_EXCEEDED', {
            'requests_per_minute': len(request_counts[ip])
        })

    # SQL ì¸ì ì…˜ íŒ¨í„´ ê°ì§€
    suspicious_patterns = ["'", '"', '--', ';', 'UNION', 'SELECT', 'DROP']
    for value in request.values.values():
        if any(pattern in str(value).upper() for pattern in suspicious_patterns):
            log_security_event('SUSPICIOUS_INPUT', {
                'path': request.path,
                'value': value[:100]  # ì²˜ìŒ 100ìë§Œ
            })</code></pre>

            <hr>

            <h2>ë¡œê·¸ ë¶„ì„</h2>

            <pre><code># ë¡œê·¸ì¸ ì‹¤íŒ¨ íšŸìˆ˜ í™•ì¸
grep "LOGIN_FAILURE" /var/log/healing-hands/security.log | wc -l

# íŠ¹ì • IPì˜ í™œë™ í™•ì¸
grep "192.168.1.100" /var/log/healing-hands/security.log

# ì‹œê°„ëŒ€ë³„ ìš”ì²­ ìˆ˜
cat /var/log/healing-hands/app.log | cut -d' ' -f2 | cut -d':' -f1 | sort | uniq -c</code></pre>

            <h3>Pythonìœ¼ë¡œ ë¡œê·¸ ë¶„ì„</h3>
            <pre><code>import json
from collections import Counter

def analyze_security_logs(log_file):
    events = []
    with open(log_file) as f:
        for line in f:
            events.append(json.loads(line))

    # ì´ë²¤íŠ¸ ìœ í˜•ë³„ ì¹´ìš´íŠ¸
    event_types = Counter(e['event_type'] for e in events)
    print("ì´ë²¤íŠ¸ ìœ í˜•ë³„ íšŸìˆ˜:")
    for event_type, count in event_types.most_common():
        print(f"  {event_type}: {count}")

    # ë¡œê·¸ì¸ ì‹¤íŒ¨ê°€ ë§ì€ IP
    login_failures = [e for e in events if e['event_type'] == 'LOGIN_FAILURE']
    ip_counts = Counter(e['ip_address'] for e in login_failures)
    print("\në¡œê·¸ì¸ ì‹¤íŒ¨ IP Top 5:")
    for ip, count in ip_counts.most_common(5):
        print(f"  {ip}: {count}íšŒ")

analyze_security_logs('/var/log/healing-hands/security.log')</code></pre>

            <hr>

            <h2>ì•Œë¦¼ ì„¤ì •</h2>

            <pre><code>import smtplib
from email.mime.text import MIMEText

def send_alert(subject, message):
    """ë³´ì•ˆ ì•Œë¦¼ ì´ë©”ì¼ ë°œì†¡"""
    msg = MIMEText(message)
    msg['Subject'] = f'[ë³´ì•ˆ ì•Œë¦¼] {subject}'
    msg['From'] = 'security@healing-hands.com'
    msg['To'] = 'admin@healing-hands.com'

    with smtplib.SMTP('localhost') as smtp:
        smtp.send_message(msg)

# ì‹¬ê°í•œ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì•Œë¦¼
def log_security_event(event_type, details, user_id=None):
    # ... ë¡œê·¸ ê¸°ë¡ ...

    # ì‹¬ê°í•œ ì´ë²¤íŠ¸ëŠ” ì¦‰ì‹œ ì•Œë¦¼
    critical_events = ['UNAUTHORIZED_ACCESS', 'RATE_LIMIT_EXCEEDED', 'SQL_INJECTION_ATTEMPT']
    if event_type in critical_events:
        send_alert(event_type, json.dumps(details, indent=2))</code></pre>

            <hr>

            <h2>ë¡œê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

            <table>
                <tr>
                    <th>í•­ëª©</th>
                    <th>í™•ì¸</th>
                </tr>
                <tr>
                    <td>ì•± ë¡œê¹… ì„¤ì •</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ë³´ì•ˆ ì´ë²¤íŠ¸ ë³„ë„ ë¡œê¹…</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>DB ê°ì‚¬ ë¡œê·¸ í™œì„±í™”</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ì˜ì‹¬ í™œë™ íƒì§€</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ì‹¬ê°í•œ ì´ë²¤íŠ¸ ì•Œë¦¼</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ë¡œê·¸ ë°±ì—…/ë³´ê´€</td>
                    <td>â˜</td>
                </tr>
            </table>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li><strong>ë¡œê·¸</strong>ëŠ” ë³´ì•ˆ ì‚¬ê³  ë¶„ì„ì˜ í•µì‹¬</li>
                <li><strong>ë³´ì•ˆ ì´ë²¤íŠ¸</strong>ëŠ” ë³„ë„ë¡œ ìƒì„¸ ê¸°ë¡</li>
                <li><strong>ë¡œê·¸ ë¡œí…Œì´ì…˜</strong>ìœ¼ë¡œ ë””ìŠ¤í¬ ê´€ë¦¬</li>
                <li><strong>ì˜ì‹¬ í™œë™ íƒì§€</strong>ë¡œ ì„ ì œ ëŒ€ì‘</li>
                <li>ì‹¬ê°í•œ ì´ë²¤íŠ¸ëŠ” <strong>ì¦‰ì‹œ ì•Œë¦¼</strong></li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ë°±ì—…ê³¼ ë³µêµ¬ë¥¼ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
