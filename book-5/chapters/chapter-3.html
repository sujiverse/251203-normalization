<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3ì¥: SQL ì¸ì ì…˜ ë°©ì–´ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 5ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "5"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ›¡ï¸ 5ê¶Œ: ë³´ì•ˆ í¸</h1>
                <p>DB & ì„œë²„ ë³´ì•ˆ</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">SQL ì¸ì ì…˜ ë°©ì–´</h1>

            <h2>ë°©ì–´ì˜ í•µì‹¬: Prepared Statement</h2>

            <p>Prepared Statement(ë§¤ê°œë³€ìˆ˜í™”ëœ ì¿¼ë¦¬)ëŠ” SQL ì¸ì ì…˜ì„ <strong>ì™„ë²½í•˜ê²Œ ì°¨ë‹¨</strong>í•©ë‹ˆë‹¤.</p>

            <h3>ì›ë¦¬</h3>
            <pre class="file-tree">ì¼ë°˜ ì¿¼ë¦¬ (ì·¨ì•½)
â”œâ”€â”€ 1. ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±
â”œâ”€â”€ 2. ì‚¬ìš©ì ì…ë ¥ ì‚½ì…
â””â”€â”€ 3. DBë¡œ ì „ì†¡ â†’ ì½”ë“œì™€ ë°ì´í„°ê°€ ì„ì„!

Prepared Statement (ì•ˆì „)
â”œâ”€â”€ 1. ì¿¼ë¦¬ í…œí”Œë¦¿ ì „ì†¡ (ë°ì´í„° ìœ„ì¹˜ë§Œ í‘œì‹œ)
â”œâ”€â”€ 2. ë°ì´í„° ë³„ë„ ì „ì†¡
â””â”€â”€ 3. DBê°€ êµ¬ë¶„í•´ì„œ ì²˜ë¦¬ â†’ ì½”ë“œì™€ ë°ì´í„° ë¶„ë¦¬!</pre>

            <hr>

            <h2>Python (MySQL Connector)</h2>

            <h3>ì·¨ì•½í•œ ì½”ë“œ</h3>
            <pre><code># âŒ ìœ„í—˜!
name = request.args.get('name')
query = f"SELECT * FROM patients WHERE name = '{name}'"
cursor.execute(query)</code></pre>

            <h3>ì•ˆì „í•œ ì½”ë“œ</h3>
            <pre><code># âœ… ì•ˆì „!
name = request.args.get('name')
query = "SELECT * FROM patients WHERE name = %s"
cursor.execute(query, (name,))  # íŠœí”Œë¡œ ì „ë‹¬</code></pre>

            <p><code>%s</code>ëŠ” í”Œë ˆì´ìŠ¤í™€ë”ì…ë‹ˆë‹¤. ì‹¤ì œ ê°’ì€ ë³„ë„ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</p>

            <hr>

            <h2>ì—¬ëŸ¬ ë§¤ê°œë³€ìˆ˜ ì‚¬ìš©</h2>

            <pre><code># ì—¬ëŸ¬ ì¡°ê±´
query = """
    SELECT * FROM patients
    WHERE name = %s
    AND birth_date = %s
    AND insurance_code = %s
"""
cursor.execute(query, (name, birth_date, insurance_code))</code></pre>

            <pre><code># INSERT
query = """
    INSERT INTO patients (name, phone, birth_date)
    VALUES (%s, %s, %s)
"""
cursor.execute(query, (name, phone, birth_date))</code></pre>

            <pre><code># UPDATE
query = """
    UPDATE patients
    SET phone = %s, address = %s
    WHERE patient_id = %s
"""
cursor.execute(query, (phone, address, patient_id))</code></pre>

            <hr>

            <h2>Flask ì•± ì ìš© ì˜ˆì‹œ</h2>

            <pre><code>from flask import Flask, request, jsonify
import mysql.connector

app = Flask(__name__)

def get_db():
    return mysql.connector.connect(
        host='localhost',
        user='healing_user',
        password='secure_password',
        database='healing_hands'
    )

@app.route('/api/patients/search')
def search_patients():
    name = request.args.get('name', '')

    conn = get_db()
    cursor = conn.cursor(dictionary=True)

    # âœ… Prepared Statement ì‚¬ìš©
    query = "SELECT patient_id, name, phone FROM patients WHERE name LIKE %s"
    cursor.execute(query, (f'%{name}%',))

    results = cursor.fetchall()
    cursor.close()
    conn.close()

    return jsonify({'success': True, 'data': results})

@app.route('/api/patients', methods=['POST'])
def create_patient():
    data = request.get_json()

    conn = get_db()
    cursor = conn.cursor()

    # âœ… Prepared Statement ì‚¬ìš©
    query = """
        INSERT INTO patients (patient_id, name, phone, birth_date)
        VALUES (%s, %s, %s, %s)
    """
    cursor.execute(query, (
        data['patient_id'],
        data['name'],
        data['phone'],
        data['birth_date']
    ))

    conn.commit()
    cursor.close()
    conn.close()

    return jsonify({'success': True})</code></pre>

            <hr>

            <h2>ORM ì‚¬ìš© (SQLAlchemy)</h2>

            <p>ORMì„ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ Prepared Statementê°€ ì ìš©ë©ë‹ˆë‹¤.</p>

            <pre><code>from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

class Patient(db.Model):
    __tablename__ = 'patients'
    patient_id = db.Column(db.String(10), primary_key=True)
    name = db.Column(db.String(30))
    phone = db.Column(db.String(20))

# ê²€ìƒ‰ - ìë™ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
@app.route('/api/patients/search')
def search():
    name = request.args.get('name')

    # âœ… ORMì´ ìë™ìœ¼ë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
    patients = Patient.query.filter(
        Patient.name.like(f'%{name}%')
    ).all()

    return jsonify([p.to_dict() for p in patients])</code></pre>

            <hr>

            <h2>ì¶”ê°€ ë°©ì–´: ì…ë ¥ ê²€ì¦</h2>

            <p>Prepared Statementì™€ í•¨ê»˜ ì…ë ¥ ê²€ì¦ë„ ì ìš©í•˜ì„¸ìš”.</p>

            <pre><code>import re

def validate_patient_id(patient_id):
    """í™˜ì ID í˜•ì‹ ê²€ì¦: P + ìˆ«ì 3ìë¦¬"""
    if not re.match(r'^P\d{3}$', patient_id):
        raise ValueError('ì˜ëª»ëœ í™˜ì ID í˜•ì‹')
    return patient_id

def validate_phone(phone):
    """ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦"""
    if not re.match(r'^\d{3}-\d{4}-\d{4}$', phone):
        raise ValueError('ì˜ëª»ëœ ì „í™”ë²ˆí˜¸ í˜•ì‹')
    return phone

def validate_name(name):
    """ì´ë¦„ ê²€ì¦: í•œê¸€, ì˜ë¬¸ë§Œ í—ˆìš©"""
    if not re.match(r'^[ê°€-í£a-zA-Z\s]+$', name):
        raise ValueError('ì´ë¦„ì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ì í¬í•¨')
    if len(name) > 30:
        raise ValueError('ì´ë¦„ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤')
    return name

@app.route('/api/patients', methods=['POST'])
def create_patient():
    data = request.get_json()

    try:
        # ì…ë ¥ ê²€ì¦
        patient_id = validate_patient_id(data['patient_id'])
        name = validate_name(data['name'])
        phone = validate_phone(data['phone'])
    except ValueError as e:
        return jsonify({'success': False, 'error': str(e)}), 400

    # DB ì €ì¥ (Prepared Statement)
    ...</code></pre>

            <hr>

            <h2>ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°</h2>

            <p>SQL ì—ëŸ¬ë¥¼ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œí•˜ë©´ ê³µê²©ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.</p>

            <pre><code># âŒ ìœ„í—˜: ìƒì„¸ ì—ëŸ¬ ë…¸ì¶œ
@app.route('/api/patients')
def get_patients():
    try:
        cursor.execute(query)
    except Exception as e:
        return jsonify({'error': str(e)})  # SQL ì—ëŸ¬ ë…¸ì¶œ!

# âœ… ì•ˆì „: ì¼ë°˜ì ì¸ ë©”ì‹œì§€ë§Œ í‘œì‹œ
@app.route('/api/patients')
def get_patients():
    try:
        cursor.execute(query)
    except Exception as e:
        app.logger.error(f'DB ì—ëŸ¬: {e}')  # ì„œë²„ ë¡œê·¸ì—ë§Œ ê¸°ë¡
        return jsonify({'error': 'ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}), 500</code></pre>

            <hr>

            <h2>ìµœì†Œ ê¶Œí•œ ì›ì¹™</h2>

            <p>DB ì‚¬ìš©ìì—ê²Œ í•„ìš”í•œ ê¶Œí•œë§Œ ë¶€ì—¬í•©ë‹ˆë‹¤.</p>

            <pre><code>-- ì›¹ ì•±ìš© ì‚¬ìš©ì: SELECT, INSERT, UPDATEë§Œ
CREATE USER 'web_app'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE ON healing_hands.* TO 'web_app'@'localhost';

-- DELETE, DROP ê¶Œí•œ ì—†ìŒ!
-- ì‹¤ìˆ˜ë¡œ í…Œì´ë¸” ì‚­ì œ ë°©ì§€</code></pre>

            <hr>

            <h2>ë°©ì–´ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

            <table>
                <tr>
                    <th>í•­ëª©</th>
                    <th>í™•ì¸</th>
                </tr>
                <tr>
                    <td>ëª¨ë“  ì¿¼ë¦¬ì— Prepared Statement ì‚¬ìš©</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ì‚¬ìš©ì ì…ë ¥ ê²€ì¦</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>SQL ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¹€</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>DB ì‚¬ìš©ì ìµœì†Œ ê¶Œí•œ</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ORM ì‚¬ìš© ê³ ë ¤</td>
                    <td>â˜</td>
                </tr>
            </table>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li><strong>Prepared Statement</strong>ëŠ” SQL ì¸ì ì…˜ì˜ ì™„ë²½í•œ ë°©ì–´ì±…</li>
                <li>ì¿¼ë¦¬ì™€ ë°ì´í„°ë¥¼ ë¶„ë¦¬í•´ì„œ ì „ë‹¬</li>
                <li>ì…ë ¥ ê²€ì¦ì„ ì¶”ê°€ë¡œ ì ìš©</li>
                <li>ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ</li>
                <li>DB ì‚¬ìš©ìì—ê²Œ ìµœì†Œ ê¶Œí•œë§Œ ë¶€ì—¬</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” XSS ê³µê²©ê³¼ ë°©ì–´ë¥¼ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
