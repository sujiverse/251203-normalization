<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7ì¥: ë¹„ë°€ë²ˆí˜¸ ì•ˆì „í•˜ê²Œ ì €ì¥ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 5ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "5"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ›¡ï¸ 5ê¶Œ: ë³´ì•ˆ í¸</h1>
                <p>DB & ì„œë²„ ë³´ì•ˆ</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ë¹„ë°€ë²ˆí˜¸ ì•ˆì „í•˜ê²Œ ì €ì¥</h1>

            <h2>ì ˆëŒ€ í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒ</h2>

            <pre><code># âŒ í‰ë¬¸ ì €ì¥ - ìµœì•…!
INSERT INTO users (username, password)
VALUES ('admin', 'mypassword123');

# DBê°€ ìœ ì¶œë˜ë©´ ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ!</code></pre>

            <pre><code># âŒ ë‹¨ìˆœ í•´ì‹œ - ìœ„í—˜!
import hashlib

password_hash = hashlib.sha256('mypassword123'.encode()).hexdigest()
# ë ˆì¸ë³´ìš° í…Œì´ë¸” ê³µê²©ì— ì·¨ì•½!</code></pre>

            <hr>

            <h2>í•´ì‹œë€?</h2>

            <pre class="file-tree">í•´ì‹œ í•¨ìˆ˜ íŠ¹ì§•
â”‚
â”œâ”€â”€ ë‹¨ë°©í–¥: í•´ì‹œ â†’ ì›ë³¸ ë³µì› ë¶ˆê°€
â”‚
â”œâ”€â”€ ê³ ì • ê¸¸ì´: ì…ë ¥ í¬ê¸°ì™€ ë¬´ê´€
â”‚
â”œâ”€â”€ ê²°ì •ì : ê°™ì€ ì…ë ¥ â†’ ê°™ì€ ì¶œë ¥
â”‚
â””â”€â”€ ëˆˆì‚¬íƒœ íš¨ê³¼: 1ê¸€ì ë³€ê²½ â†’ ì™„ì „íˆ ë‹¤ë¥¸ í•´ì‹œ</pre>

            <pre><code>import hashlib

# ê°™ì€ ì…ë ¥ â†’ ê°™ì€ í•´ì‹œ
hashlib.sha256('password'.encode()).hexdigest()
# '5e884898da28047d9...'

# 1ê¸€ì ë³€ê²½ â†’ ì™„ì „íˆ ë‹¤ë¥¸ í•´ì‹œ
hashlib.sha256('Password'.encode()).hexdigest()
# '48c8947f69c054a5c...'</code></pre>

            <hr>

            <h2>ì™œ ë‹¨ìˆœ í•´ì‹œê°€ ìœ„í—˜í•œê°€?</h2>

            <h3>1. ë ˆì¸ë³´ìš° í…Œì´ë¸” ê³µê²©</h3>
            <p>ë¯¸ë¦¬ ê³„ì‚°ëœ í•´ì‹œ-ë¹„ë°€ë²ˆí˜¸ ë§¤í•‘ í…Œì´ë¸”ì…ë‹ˆë‹¤.</p>

            <pre><code># ë ˆì¸ë³´ìš° í…Œì´ë¸” ì˜ˆì‹œ
{
    '5e884898...': 'password',
    '8d969eef...': '123456',
    'e10adc39...': '123456789',
    ...
}

# í•´ì‹œê°’ë§Œ ìˆìœ¼ë©´ ì›ë³¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŒ!</code></pre>

            <h3>2. ê°™ì€ ë¹„ë°€ë²ˆí˜¸ = ê°™ì€ í•´ì‹œ</h3>
            <pre><code>users í…Œì´ë¸”:
| username | password_hash          |
|----------|------------------------|
| user1    | 5e884898da28047d9...   |
| user2    | 5e884898da28047d9...   |  â† ê°™ì€ í•´ì‹œ!
| user3    | 5e884898da28047d9...   |  â† ê°™ì€ í•´ì‹œ!

â†’ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŒ</code></pre>

            <hr>

            <h2>í•´ê²°ì±…: ì†”íŒ… (Salting)</h2>

            <p>ë¹„ë°€ë²ˆí˜¸ì— ëœë¤ ë¬¸ìì—´(ì†”íŠ¸)ì„ ì¶”ê°€í•´ì„œ í•´ì‹œí•©ë‹ˆë‹¤.</p>

            <pre><code>import os
import hashlib

def hash_with_salt(password):
    # 16ë°”ì´íŠ¸ ëœë¤ ì†”íŠ¸ ìƒì„±
    salt = os.urandom(16)

    # ë¹„ë°€ë²ˆí˜¸ + ì†”íŠ¸ë¥¼ í•¨ê»˜ í•´ì‹œ
    password_hash = hashlib.pbkdf2_hmac(
        'sha256',
        password.encode(),
        salt,
        100000  # ë°˜ë³µ íšŸìˆ˜
    )

    # ì†”íŠ¸ì™€ í•´ì‹œë¥¼ í•¨ê»˜ ì €ì¥
    return salt + password_hash</code></pre>

            <p>ì†”íŠ¸ íš¨ê³¼:</p>
            <pre><code># ê°™ì€ ë¹„ë°€ë²ˆí˜¸ë¼ë„ ë‹¤ë¥¸ í•´ì‹œ!
user1: salt=abc123... â†’ hash=x7k9p2...
user2: salt=def456... â†’ hash=m3n8q1...

â†’ ë ˆì¸ë³´ìš° í…Œì´ë¸” ë¬´ë ¥í™”!</code></pre>

            <hr>

            <h2>ìµœì„ ì˜ ë°©ë²•: bcrypt</h2>

            <p>bcryptëŠ” ë¹„ë°€ë²ˆí˜¸ í•´ì‹±ì„ ìœ„í•´ ì„¤ê³„ëœ ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤.</p>

            <pre><code>import bcrypt

def hash_password(password):
    """ë¹„ë°€ë²ˆí˜¸ í•´ì‹±"""
    # ì†”íŠ¸ ìë™ ìƒì„±, work factor=12 (2^12 ë°˜ë³µ)
    password_bytes = password.encode('utf-8')
    salt = bcrypt.gensalt(rounds=12)
    return bcrypt.hashpw(password_bytes, salt).decode('utf-8')

def verify_password(password, password_hash):
    """ë¹„ë°€ë²ˆí˜¸ ê²€ì¦"""
    password_bytes = password.encode('utf-8')
    hash_bytes = password_hash.encode('utf-8')
    return bcrypt.checkpw(password_bytes, hash_bytes)

# ì‚¬ìš© ì˜ˆì‹œ
hashed = hash_password('mypassword123')
print(hashed)
# $2b$12$LQv3c1yqBWVHxkd0LHAkCO...

# ê²€ì¦
verify_password('mypassword123', hashed)  # True
verify_password('wrongpassword', hashed)  # False</code></pre>

            <h3>bcrypt í•´ì‹œ êµ¬ì¡°</h3>
            <pre><code>$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz0...
 â”‚  â”‚  â”‚                    â”‚
 â”‚  â”‚  â”‚                    â””â”€â”€ í•´ì‹œê°’
 â”‚  â”‚  â””â”€â”€ ì†”íŠ¸
 â”‚  â””â”€â”€ work factor (2^12 = 4096ë²ˆ ë°˜ë³µ)
 â””â”€â”€ ì•Œê³ ë¦¬ì¦˜ ë²„ì „</code></pre>

            <hr>

            <h2>íšŒì›ê°€ì… êµ¬í˜„</h2>

            <pre><code>@app.route('/register', methods=['POST'])
def register():
    data = request.get_json()

    username = data['username']
    password = data['password']

    # ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê²€ì¦
    if len(password) < 8:
        return {'error': 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤'}, 400

    # ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì í™•ì¸
    if get_user(username):
        return {'error': 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤'}, 400

    # ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
    password_hash = hash_password(password)

    # DBì— ì €ì¥
    cursor.execute("""
        INSERT INTO users (username, password_hash, created_at)
        VALUES (%s, %s, NOW())
    """, (username, password_hash))
    conn.commit()

    return {'success': True}</code></pre>

            <hr>

            <h2>ë¡œê·¸ì¸ êµ¬í˜„</h2>

            <pre><code>@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()

    username = data['username']
    password = data['password']

    # ì‚¬ìš©ì ì¡°íšŒ
    user = get_user(username)

    if not user:
        # íƒ€ì´ë° ê³µê²© ë°©ì§€: ì‚¬ìš©ì ì—†ì–´ë„ ê°™ì€ ì‹œê°„ ì†Œìš”
        bcrypt.checkpw(b'dummy', b'$2b$12$' + b'0' * 53)
        return {'error': 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤'}, 401

    # ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    if not verify_password(password, user['password_hash']):
        return {'error': 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤'}, 401

    # ë¡œê·¸ì¸ ì„±ê³µ
    session['user_id'] = user['id']
    return {'success': True}</code></pre>

            <div class="warning">
                <strong>ë³´ì•ˆ íŒ</strong><br>
                "ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤" vs "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤"ë¥¼ êµ¬ë¶„í•˜ì§€ ë§ˆì„¸ìš”!<br>
                ê³µê²©ìì—ê²Œ ìœ íš¨í•œ ì•„ì´ë”” ì •ë³´ë¥¼ ì£¼ê²Œ ë©ë‹ˆë‹¤.
            </div>

            <hr>

            <h2>ë¹„ë°€ë²ˆí˜¸ ì •ì±…</h2>

            <pre><code>import re

def validate_password(password):
    """ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê²€ì¦"""
    errors = []

    if len(password) < 8:
        errors.append('8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤')

    if not re.search(r'[A-Z]', password):
        errors.append('ëŒ€ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤')

    if not re.search(r'[a-z]', password):
        errors.append('ì†Œë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤')

    if not re.search(r'\d', password):
        errors.append('ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤')

    if not re.search(r'[!@#$%^&*]', password):
        errors.append('íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤')

    # í”í•œ ë¹„ë°€ë²ˆí˜¸ ì°¨ë‹¨
    common_passwords = ['password', '123456', 'qwerty', ...]
    if password.lower() in common_passwords:
        errors.append('ë„ˆë¬´ í”í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤')

    return errors</code></pre>

            <hr>

            <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>

            <pre><code>@app.route('/change-password', methods=['POST'])
@login_required
def change_password():
    data = request.get_json()

    current_password = data['current_password']
    new_password = data['new_password']

    user = get_user_by_id(session['user_id'])

    # í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if not verify_password(current_password, user['password_hash']):
        return {'error': 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤'}, 401

    # ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê²€ì¦
    errors = validate_password(new_password)
    if errors:
        return {'errors': errors}, 400

    # ì´ì „ ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ì§€ í™•ì¸
    if verify_password(new_password, user['password_hash']):
        return {'error': 'ì´ì „ê³¼ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”'}, 400

    # ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì €ì¥
    new_hash = hash_password(new_password)
    cursor.execute("""
        UPDATE users SET password_hash = %s WHERE id = %s
    """, (new_hash, session['user_id']))
    conn.commit()

    return {'success': True}</code></pre>

            <hr>

            <h2>DB í…Œì´ë¸” ì„¤ê³„</h2>

            <pre><code>CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(60) NOT NULL,  -- bcryptëŠ” 60ì
    role ENUM('admin', 'therapist', 'staff') DEFAULT 'staff',
    failed_attempts INT DEFAULT 0,
    locked_until DATETIME NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);</code></pre>

            <hr>

            <h2>ë¹„ë°€ë²ˆí˜¸ ì €ì¥ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

            <table>
                <tr>
                    <th>í•­ëª©</th>
                    <th>í™•ì¸</th>
                </tr>
                <tr>
                    <td>bcrypt ë˜ëŠ” argon2 ì‚¬ìš©</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>í‰ë¬¸ ì €ì¥ ì•ˆ í•¨</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ë¹„ë°€ë²ˆí˜¸ ì •ì±… ì ìš©</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ë¡œê·¸ì¸ ì‹¤íŒ¨ ë©”ì‹œì§€ ì¼ë°˜í™”</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ì´ì „ ë¹„ë°€ë²ˆí˜¸ ì¬ì‚¬ìš© ê¸ˆì§€</td>
                    <td>â˜</td>
                </tr>
            </table>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ë¹„ë°€ë²ˆí˜¸ë¥¼ <strong>í‰ë¬¸ìœ¼ë¡œ ì €ì¥í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤</strong></li>
                <li>ë‹¨ìˆœ í•´ì‹œëŠ” <strong>ë ˆì¸ë³´ìš° í…Œì´ë¸”</strong>ì— ì·¨ì•½</li>
                <li><strong>ì†”íŒ…</strong>ìœ¼ë¡œ ê°™ì€ ë¹„ë°€ë²ˆí˜¸ë„ ë‹¤ë¥¸ í•´ì‹œ ìƒì„±</li>
                <li><strong>bcrypt</strong>ëŠ” ë¹„ë°€ë²ˆí˜¸ìš©ìœ¼ë¡œ ì„¤ê³„ëœ ì•Œê³ ë¦¬ì¦˜</li>
                <li><strong>ë¹„ë°€ë²ˆí˜¸ ì •ì±…</strong>ìœ¼ë¡œ ì•½í•œ ë¹„ë°€ë²ˆí˜¸ ë°©ì§€</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” DB ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬ë¥¼ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
