<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6ì¥: ì¸ì¦ê³¼ ì„¸ì…˜ ê´€ë¦¬ - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 5ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "5"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ›¡ï¸ 5ê¶Œ: ë³´ì•ˆ í¸</h1>
                <p>DB & ì„œë²„ ë³´ì•ˆ</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">ì¸ì¦ê³¼ ì„¸ì…˜ ê´€ë¦¬</h1>

            <h2>ì¸ì¦ vs ì¸ê°€</h2>

            <table>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>ì¸ì¦ (Authentication)</th>
                    <th>ì¸ê°€ (Authorization)</th>
                </tr>
                <tr>
                    <td>ì§ˆë¬¸</td>
                    <td>ëˆ„êµ¬ì¸ê°€?</td>
                    <td>ë­˜ í•  ìˆ˜ ìˆëŠ”ê°€?</td>
                </tr>
                <tr>
                    <td>ì˜ˆì‹œ</td>
                    <td>ë¡œê·¸ì¸</td>
                    <td>ê´€ë¦¬ì ê¶Œí•œ í™•ì¸</td>
                </tr>
                <tr>
                    <td>ë°©ë²•</td>
                    <td>ë¹„ë°€ë²ˆí˜¸, ìƒì²´ì¸ì‹</td>
                    <td>ì—­í• , ê¶Œí•œ ì²´í¬</td>
                </tr>
            </table>

            <hr>

            <h2>ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦</h2>

            <pre class="file-tree">ì„¸ì…˜ ì¸ì¦ íë¦„
â”‚
â”œâ”€â”€ 1. ë¡œê·¸ì¸ ìš”ì²­ (ID/PW)
â”‚
â”œâ”€â”€ 2. ì„œë²„ì—ì„œ ê²€ì¦
â”‚   â”œâ”€â”€ ì„±ê³µ â†’ ì„¸ì…˜ ID ìƒì„±
â”‚   â””â”€â”€ ì„¸ì…˜ ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥
â”‚
â”œâ”€â”€ 3. ì„¸ì…˜ IDë¥¼ ì¿ í‚¤ë¡œ ì „ì†¡
â”‚
â””â”€â”€ 4. ì´í›„ ìš”ì²­ë§ˆë‹¤ ì¿ í‚¤ ìë™ ì „ì†¡
    â””â”€â”€ ì„œë²„ê°€ ì„¸ì…˜ ë°ì´í„°ë¡œ ì‚¬ìš©ì í™•ì¸</pre>

            <h3>Flask ì„¸ì…˜ êµ¬í˜„</h3>

            <pre><code>from flask import Flask, session, request, redirect
import secrets

app = Flask(__name__)
app.secret_key = secrets.token_hex(32)  # ë¹„ë°€í‚¤ (í™˜ê²½ë³€ìˆ˜ë¡œ!)

# ë¡œê·¸ì¸
@app.route('/login', methods=['POST'])
def login():
    username = request.form['username']
    password = request.form['password']

    user = get_user(username)

    if user and verify_password(password, user['password_hash']):
        # ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
        session['user_id'] = user['id']
        session['username'] = user['username']
        session['role'] = user['role']

        return redirect('/dashboard')

    return {'error': 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤'}, 401

# ë¡œê·¸ì•„ì›ƒ
@app.route('/logout')
def logout():
    session.clear()  # ì„¸ì…˜ ì‚­ì œ
    return redirect('/login')

# ë¡œê·¸ì¸ í™•ì¸ ë°ì½”ë ˆì´í„°
from functools import wraps

def login_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        if 'user_id' not in session:
            return redirect('/login')
        return f(*args, **kwargs)
    return decorated

# ì‚¬ìš©
@app.route('/dashboard')
@login_required
def dashboard():
    return f"í™˜ì˜í•©ë‹ˆë‹¤, {session['username']}ë‹˜!"</code></pre>

            <hr>

            <h2>ì„¸ì…˜ ë³´ì•ˆ ì„¤ì •</h2>

            <pre><code>from datetime import timedelta

app.config.update(
    # ì„¸ì…˜ ì¿ í‚¤ ì„¤ì •
    SESSION_COOKIE_SECURE=True,      # HTTPSì—ì„œë§Œ ì „ì†¡
    SESSION_COOKIE_HTTPONLY=True,    # JavaScript ì ‘ê·¼ ì°¨ë‹¨
    SESSION_COOKIE_SAMESITE='Lax',   # CSRF ë°©ì–´

    # ì„¸ì…˜ ìˆ˜ëª…
    PERMANENT_SESSION_LIFETIME=timedelta(hours=2),  # 2ì‹œê°„
)

@app.before_request
def make_session_permanent():
    session.permanent = True</code></pre>

            <hr>

            <h2>ì„œë²„ ì¸¡ ì„¸ì…˜ ì €ì¥ (Redis)</h2>

            <p>Flask ê¸°ë³¸ ì„¸ì…˜ì€ ì¿ í‚¤ì— ì €ì¥ë©ë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ ì„œë²„ì— ì €ì¥í•©ë‹ˆë‹¤.</p>

            <pre><code>from flask import Flask
from flask_session import Session
import redis

app = Flask(__name__)

# Redis ì„¸ì…˜ ì„¤ì •
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.Redis(host='localhost', port=6379)
app.config['SESSION_PERMANENT'] = True
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(hours=2)

Session(app)</code></pre>

            <hr>

            <h2>JWT í† í° ì¸ì¦</h2>

            <p>API ì„œë²„ì—ì„œ ë§ì´ ì‚¬ìš©í•˜ëŠ” í† í° ê¸°ë°˜ ì¸ì¦ì…ë‹ˆë‹¤.</p>

            <pre class="file-tree">JWT ì¸ì¦ íë¦„
â”‚
â”œâ”€â”€ 1. ë¡œê·¸ì¸ ìš”ì²­ (ID/PW)
â”‚
â”œâ”€â”€ 2. ì„œë²„ì—ì„œ ê²€ì¦
â”‚   â””â”€â”€ ì„±ê³µ â†’ JWT í† í° ìƒì„±
â”‚
â”œâ”€â”€ 3. í† í°ì„ í´ë¼ì´ì–¸íŠ¸ì— ì „ì†¡
â”‚   â””â”€â”€ í´ë¼ì´ì–¸íŠ¸ê°€ ì €ì¥ (localStorage ë“±)
â”‚
â””â”€â”€ 4. ì´í›„ ìš”ì²­ë§ˆë‹¤ í† í°ì„ í—¤ë”ì— í¬í•¨
    â””â”€â”€ Authorization: Bearer {token}</pre>

            <pre><code>import jwt
from datetime import datetime, timedelta

SECRET_KEY = 'your-secret-key'  # í™˜ê²½ë³€ìˆ˜ë¡œ!

def create_token(user_id, role):
    """JWT í† í° ìƒì„±"""
    payload = {
        'user_id': user_id,
        'role': role,
        'exp': datetime.utcnow() + timedelta(hours=2),  # ë§Œë£Œì‹œê°„
        'iat': datetime.utcnow()  # ë°œê¸‰ì‹œê°„
    }
    return jwt.encode(payload, SECRET_KEY, algorithm='HS256')

def verify_token(token):
    """JWT í† í° ê²€ì¦"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
        return payload
    except jwt.ExpiredSignatureError:
        return None  # ë§Œë£Œë¨
    except jwt.InvalidTokenError:
        return None  # ìœ íš¨í•˜ì§€ ì•ŠìŒ

# ë¡œê·¸ì¸ API
@app.route('/api/login', methods=['POST'])
def api_login():
    data = request.get_json()
    user = get_user(data['username'])

    if user and verify_password(data['password'], user['password_hash']):
        token = create_token(user['id'], user['role'])
        return {'token': token}

    return {'error': 'ì¸ì¦ ì‹¤íŒ¨'}, 401

# í† í° ê²€ì¦ ë°ì½”ë ˆì´í„°
def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        auth_header = request.headers.get('Authorization')

        if not auth_header or not auth_header.startswith('Bearer '):
            return {'error': 'í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤'}, 401

        token = auth_header.split(' ')[1]
        payload = verify_token(token)

        if not payload:
            return {'error': 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°'}, 401

        request.user = payload
        return f(*args, **kwargs)
    return decorated

# ì‚¬ìš©
@app.route('/api/patients')
@token_required
def get_patients():
    user_id = request.user['user_id']
    ...</code></pre>

            <hr>

            <h2>ì„¸ì…˜ vs JWT</h2>

            <table>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>ì„¸ì…˜</th>
                    <th>JWT</th>
                </tr>
                <tr>
                    <td>ì €ì¥ ìœ„ì¹˜</td>
                    <td>ì„œë²„</td>
                    <td>í´ë¼ì´ì–¸íŠ¸</td>
                </tr>
                <tr>
                    <td>í™•ì¥ì„±</td>
                    <td>ì„œë²„ ê°„ ì„¸ì…˜ ê³µìœ  í•„ìš”</td>
                    <td>ë¬´ìƒíƒœ (Stateless)</td>
                </tr>
                <tr>
                    <td>ë¡œê·¸ì•„ì›ƒ</td>
                    <td>ì„œë²„ì—ì„œ ì‚­ì œ ê°€ëŠ¥</td>
                    <td>ë§Œë£Œ ì „ê¹Œì§€ ìœ íš¨</td>
                </tr>
                <tr>
                    <td>ì í•©í•œ ê²½ìš°</td>
                    <td>ì›¹ ì•±</td>
                    <td>API, ëª¨ë°”ì¼</td>
                </tr>
            </table>

            <hr>

            <h2>ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)</h2>

            <pre><code># ì—­í•  í™•ì¸ ë°ì½”ë ˆì´í„°
def role_required(required_role):
    def decorator(f):
        @wraps(f)
        def decorated(*args, **kwargs):
            if session.get('role') != required_role:
                return {'error': 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤'}, 403
            return f(*args, **kwargs)
        return decorated
    return decorator

# ê´€ë¦¬ìë§Œ ì ‘ê·¼
@app.route('/admin/users')
@login_required
@role_required('admin')
def admin_users():
    return get_all_users()

# ì¹˜ë£Œì‚¬ ì´ìƒë§Œ ì ‘ê·¼
@app.route('/patients')
@login_required
@role_required('therapist')
def patient_list():
    return get_patients()</code></pre>

            <hr>

            <h2>ë¡œê·¸ì¸ ë³´ì•ˆ ê°•í™”</h2>

            <h3>1. ë¡œê·¸ì¸ ì‹œë„ ì œí•œ</h3>
            <pre><code>from flask_limiter import Limiter

limiter = Limiter(app, key_func=get_remote_address)

@app.route('/login', methods=['POST'])
@limiter.limit("5 per minute")  # ë¶„ë‹¹ 5íšŒ ì œí•œ
def login():
    ...</code></pre>

            <h3>2. ê³„ì • ì ê¸ˆ</h3>
            <pre><code>def check_login_attempts(username):
    attempts = get_login_attempts(username)

    if attempts >= 5:
        lockout_time = get_lockout_time(username)
        if datetime.now() < lockout_time:
            remaining = (lockout_time - datetime.now()).seconds // 60
            return {'error': f'{remaining}ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”'}, 429
        else:
            reset_login_attempts(username)

    return None

@app.route('/login', methods=['POST'])
def login():
    username = request.form['username']

    # ì ê¸ˆ í™•ì¸
    lockout = check_login_attempts(username)
    if lockout:
        return lockout

    # ë¡œê·¸ì¸ ì‹œë„
    if not authenticate(username, request.form['password']):
        increment_login_attempts(username)
        return {'error': 'ë¡œê·¸ì¸ ì‹¤íŒ¨'}, 401

    # ì„±ê³µ ì‹œ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
    reset_login_attempts(username)
    ...</code></pre>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li><strong>ì¸ì¦</strong>ì€ "ëˆ„êµ¬ì¸ê°€", <strong>ì¸ê°€</strong>ëŠ” "ë­˜ í•  ìˆ˜ ìˆëŠ”ê°€"</li>
                <li><strong>ì„¸ì…˜</strong>: ì„œë²„ì— ìƒíƒœ ì €ì¥, ì›¹ ì•±ì— ì í•©</li>
                <li><strong>JWT</strong>: í´ë¼ì´ì–¸íŠ¸ì— ì €ì¥, APIì— ì í•©</li>
                <li>ì„¸ì…˜ ì¿ í‚¤ëŠ” <strong>Secure, HttpOnly, SameSite</strong> ì„¤ì •</li>
                <li><strong>ë¡œê·¸ì¸ ì‹œë„ ì œí•œ</strong>ìœ¼ë¡œ ë¬´ì°¨ë³„ ëŒ€ì… ë°©ì–´</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ëŠ” ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
