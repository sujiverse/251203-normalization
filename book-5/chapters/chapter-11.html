<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11ì¥: WAS ì„œë²„ ë³´ì•ˆ ì„¤ì • - ë¬¼ë¦¬ì¹˜ë£Œì‚¬ë¥¼ ìœ„í•œ DB 5ê¶Œ</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    @@include('components/top-nav.html', {"root": "../..", "activeBook": "5"})

    @@include('components/mobile-menu.html')

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="close-btn" onclick="toggleMenu()">Ã—</button>
            <div class="sidebar-header">
                <h1>ğŸ›¡ï¸ 5ê¶Œ: ë³´ì•ˆ í¸</h1>
                <p>DB & ì„œë²„ ë³´ì•ˆ</p>
            </div>
            <ul class="nav-list" id="navList"></ul>
        </nav>

        <main class="main">
            <h1 class="title">WAS ì„œë²„ ë³´ì•ˆ ì„¤ì •</h1>

            <h2>WAS(Web Application Server)ë€?</h2>

            <pre class="file-tree">ì›¹ ì„œë¹„ìŠ¤ êµ¬ì¡°
â”‚
â”œâ”€â”€ í´ë¼ì´ì–¸íŠ¸ (ë¸Œë¼ìš°ì €)
â”‚
â”œâ”€â”€ ì›¹ ì„œë²„ (Nginx/Apache)
â”‚   â””â”€â”€ ì •ì  íŒŒì¼, ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ
â”‚
â”œâ”€â”€ WAS (Gunicorn/uWSGI)
â”‚   â””â”€â”€ Python ì•± ì‹¤í–‰
â”‚
â””â”€â”€ DB (MySQL)
    â””â”€â”€ ë°ì´í„° ì €ì¥</pre>

            <p>Flask ì•±ì€ ê°œë°œ ì„œë²„ë¡œ ì§ì ‘ ë°°í¬í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤!</p>

            <hr>

            <h2>Flask ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™”</h2>

            <div class="danger">
                <strong>ì ˆëŒ€ ê¸ˆì§€!</strong><br>
                ìš´ì˜ í™˜ê²½ì—ì„œ DEBUG=TrueëŠ” ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í˜‘ì…ë‹ˆë‹¤.
            </div>

            <pre><code># âŒ ìœ„í—˜: ë””ë²„ê·¸ ëª¨ë“œ
app.run(debug=True)

# ë””ë²„ê·¸ ëª¨ë“œ ìœ„í—˜ì„±:
# - ì—ëŸ¬ ë°œìƒ ì‹œ ì½”ë“œ ë…¸ì¶œ
# - ëŒ€í™”í˜• ë””ë²„ê±°ë¡œ ì½”ë“œ ì‹¤í–‰ ê°€ëŠ¥
# - ì„œë²„ ì •ë³´ ë…¸ì¶œ</code></pre>

            <pre><code># âœ… ì•ˆì „: í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
import os

DEBUG = os.environ.get('FLASK_DEBUG', 'False').lower() == 'true'

if __name__ == '__main__':
    app.run(debug=DEBUG)</code></pre>

            <hr>

            <h2>Gunicorn ì„¤ì •</h2>

            <p>Gunicornì€ Python WSGI HTTP ì„œë²„ì…ë‹ˆë‹¤.</p>

            <pre><code># ì„¤ì¹˜
pip install gunicorn

# ê¸°ë³¸ ì‹¤í–‰
gunicorn app:app

# ê¶Œì¥ ì„¤ì •ìœ¼ë¡œ ì‹¤í–‰
gunicorn --config gunicorn.conf.py app:app</code></pre>

            <h3>gunicorn.conf.py</h3>
            <pre><code># gunicorn.conf.py

# ë°”ì¸ë“œ ì£¼ì†Œ (Nginx ë’¤ì—ì„œ ì‹¤í–‰)
bind = "127.0.0.1:8000"

# ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìˆ˜ (CPU ì½”ì–´ * 2 + 1)
workers = 5

# ì›Œì»¤ í´ë˜ìŠ¤
worker_class = "sync"

# íƒ€ì„ì•„ì›ƒ (ì´ˆ)
timeout = 30

# ë³´ì•ˆ: í—¤ë” í¬ê¸° ì œí•œ
limit_request_line = 4094
limit_request_fields = 100
limit_request_field_size = 8190

# ë¡œê¹…
accesslog = "/var/log/gunicorn/access.log"
errorlog = "/var/log/gunicorn/error.log"
loglevel = "warning"

# í”„ë¡œì„¸ìŠ¤ ì´ë¦„
proc_name = "healing_hands"

# ë°ëª¬ ëª¨ë“œ (systemd ì‚¬ìš© ì‹œ False)
daemon = False

# ì‚¬ìš©ì/ê·¸ë£¹ (rootë¡œ ì‹¤í–‰ ê¸ˆì§€!)
user = "www-data"
group = "www-data"</code></pre>

            <hr>

            <h2>systemd ì„œë¹„ìŠ¤ ë“±ë¡</h2>

            <pre><code># /etc/systemd/system/healing-hands.service

[Unit]
Description=Healing Hands Flask App
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/healing-hands
Environment="PATH=/var/www/healing-hands/venv/bin"
ExecStart=/var/www/healing-hands/venv/bin/gunicorn --config gunicorn.conf.py app:app
Restart=always
RestartSec=5

# ë³´ì•ˆ ì„¤ì •
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/gunicorn

[Install]
WantedBy=multi-user.target</code></pre>

            <pre><code># ì„œë¹„ìŠ¤ ì‹œì‘
sudo systemctl daemon-reload
sudo systemctl start healing-hands
sudo systemctl enable healing-hands

# ìƒíƒœ í™•ì¸
sudo systemctl status healing-hands</code></pre>

            <hr>

            <h2>Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ</h2>

            <pre><code># /etc/nginx/sites-available/healing-hands

server {
    listen 80;
    server_name healing-hands.com;

    # HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name healing-hands.com;

    # SSL ì„¤ì • (ë‹¤ìŒ ì¥ì—ì„œ ìì„¸íˆ)
    ssl_certificate /etc/letsencrypt/live/healing-hands.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/healing-hands.com/privkey.pem;

    # ë³´ì•ˆ í—¤ë”
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ì„œë²„ ì •ë³´ ìˆ¨ê¸°ê¸°
    server_tokens off;

    # ìš”ì²­ í¬ê¸° ì œí•œ
    client_max_body_size 10M;

    # ì •ì  íŒŒì¼
    location /static {
        alias /var/www/healing-hands/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # API ìš”ì²­ â†’ Gunicorn
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # íƒ€ì„ì•„ì›ƒ
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
    }
}</code></pre>

            <pre><code># ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì ìš©
sudo nginx -t
sudo systemctl reload nginx</code></pre>

            <hr>

            <h2>ë³´ì•ˆ í—¤ë” ì„¤ì •</h2>

            <pre><code>from flask import Flask, Response

app = Flask(__name__)

@app.after_request
def add_security_headers(response):
    # XSS ë°©ì§€
    response.headers['X-XSS-Protection'] = '1; mode=block'

    # MIME íƒ€ì… ìŠ¤ë‹ˆí•‘ ë°©ì§€
    response.headers['X-Content-Type-Options'] = 'nosniff'

    # í´ë¦­ì¬í‚¹ ë°©ì§€
    response.headers['X-Frame-Options'] = 'SAMEORIGIN'

    # HTTPS ê°•ì œ (1ë…„)
    response.headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains'

    # Content Security Policy
    response.headers['Content-Security-Policy'] = "default-src 'self'; script-src 'self'"

    # Referrer ì •ì±…
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'

    return response</code></pre>

            <hr>

            <h2>ì—ëŸ¬ í˜ì´ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h2>

            <pre><code># ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë°©ì§€

@app.errorhandler(404)
def not_found(error):
    return {'error': 'í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}, 404

@app.errorhandler(500)
def server_error(error):
    # ë¡œê·¸ì—ë§Œ ê¸°ë¡, ì‚¬ìš©ìì—ê²ŒëŠ” ì¼ë°˜ ë©”ì‹œì§€
    app.logger.error(f'ì„œë²„ ì—ëŸ¬: {error}')
    return {'error': 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}, 500

@app.errorhandler(Exception)
def handle_exception(error):
    app.logger.exception('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜ˆì™¸')
    return {'error': 'ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}, 500</code></pre>

            <hr>

            <h2>í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬</h2>

            <pre><code># .env íŒŒì¼ (ë²„ì „ ê´€ë¦¬ì—ì„œ ì œì™¸!)
FLASK_ENV=production
SECRET_KEY=your-super-secret-key-here
DATABASE_URL=mysql://user:pass@localhost/healing_hands
ENCRYPTION_KEY=your-encryption-key</code></pre>

            <pre><code># ì•±ì—ì„œ ë¡œë“œ
from dotenv import load_dotenv
import os

load_dotenv()

app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')
DATABASE_URL = os.environ.get('DATABASE_URL')</code></pre>

            <pre><code># .gitignoreì— ì¶”ê°€
.env
*.pem
*.key
__pycache__/
*.pyc</code></pre>

            <hr>

            <h2>Rate Limiting</h2>

            <pre><code>from flask import Flask
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

app = Flask(__name__)

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"]
)

# ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ - ë” ì—„ê²©í•œ ì œí•œ
@app.route('/login', methods=['POST'])
@limiter.limit("5 per minute")
def login():
    ...

# API ì—”ë“œí¬ì¸íŠ¸
@app.route('/api/patients')
@limiter.limit("30 per minute")
def get_patients():
    ...</code></pre>

            <hr>

            <h2>íŒŒì¼ ì—…ë¡œë“œ ë³´ì•ˆ</h2>

            <pre><code>import os
from werkzeug.utils import secure_filename

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'pdf'}
MAX_CONTENT_LENGTH = 10 * 1024 * 1024  # 10MB

app.config['MAX_CONTENT_LENGTH'] = MAX_CONTENT_LENGTH

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route('/upload', methods=['POST'])
def upload_file():
    if 'file' not in request.files:
        return {'error': 'íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'}, 400

    file = request.files['file']

    if file.filename == '':
        return {'error': 'íŒŒì¼ëª…ì´ ì—†ìŠµë‹ˆë‹¤'}, 400

    if not allowed_file(file.filename):
        return {'error': 'í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹'}, 400

    # ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±
    filename = secure_filename(file.filename)

    # ì €ì¥ (ì‹¤í–‰ ê¶Œí•œ ì—†ëŠ” ë””ë ‰í† ë¦¬ì—)
    file.save(os.path.join('/var/uploads', filename))

    return {'success': True}</code></pre>

            <hr>

            <h2>WAS ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>

            <table>
                <tr>
                    <th>í•­ëª©</th>
                    <th>í™•ì¸</th>
                </tr>
                <tr>
                    <td>ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™”</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>Gunicorn/uWSGI ì‚¬ìš©</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ë³´ì•ˆ í—¤ë” ì„¤ì •</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>í™˜ê²½ë³€ìˆ˜ë¡œ ë¹„ë°€ ê´€ë¦¬</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>Rate Limiting ì ìš©</td>
                    <td>â˜</td>
                </tr>
                <tr>
                    <td>ì—ëŸ¬ ë©”ì‹œì§€ ì¼ë°˜í™”</td>
                    <td>â˜</td>
                </tr>
            </table>

            <hr>

            <h2>ì´ë²ˆ ì¥ ì •ë¦¬</h2>

            <ul>
                <li>ìš´ì˜ í™˜ê²½ì—ì„œ <strong>ë””ë²„ê·¸ ëª¨ë“œ ì ˆëŒ€ ê¸ˆì§€</strong></li>
                <li><strong>Gunicorn</strong> + <strong>Nginx</strong> ì¡°í•© ì‚¬ìš©</li>
                <li><strong>ë³´ì•ˆ í—¤ë”</strong>ë¡œ í´ë¼ì´ì–¸íŠ¸ ë³´í˜¸</li>
                <li>ë¹„ë°€ ì •ë³´ëŠ” <strong>í™˜ê²½ë³€ìˆ˜</strong>ë¡œ ê´€ë¦¬</li>
                <li><strong>Rate Limiting</strong>ìœ¼ë¡œ ë¬´ì°¨ë³„ ëŒ€ì… ë°©ì–´</li>
            </ul>

            <blockquote>ë‹¤ìŒ ì¥ì—ì„œëŠ” HTTPS ì ìš© ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤!</blockquote>

            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn">â† ì´ì „</button>
                <span class="page-num" id="pageNum"></span>
                <button class="nav-btn" id="nextBtn">ë‹¤ìŒ â†’</button>
            </div>
        </main>
    </div>
    <script src="../js/nav.js"></script>
</body>
</html>
